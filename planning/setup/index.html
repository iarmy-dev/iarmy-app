<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planning - Configuration | iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23FF6B35'/%3E%3Ctext x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'%3Ei%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { background: #0a0a0a; color: white; min-height: 100vh; overflow-x: hidden; }
    .bg-gradient-animate { background: linear-gradient(135deg, #0a0a0a 0%, #0f0a0d 25%, #0a0f0f 50%, #0d0f0a 75%, #0a0a0a 100%); background-size: 400% 400%; animation: gradientShift 20s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.2; animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 0; }
    .orb-1 { width: 400px; height: 400px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); top: -200px; right: -100px; }
    .orb-2 { width: 300px; height: 300px; background: linear-gradient(135deg, #6B35FF, #8B5EFF); bottom: -150px; left: -100px; animation-delay: -7s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }

    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(24px); border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.04); }
    .glass-card { background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); transition: all 0.4s ease; }

    .logo-i { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; transition: all 0.4s; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); }
    .logo-i:hover { transform: scale(1.15) rotate(-8deg); box-shadow: 0 0 40px rgba(255,107,53,0.6); }

    .sidebar { background: rgba(255, 255, 255, 0.01); backdrop-filter: blur(20px); width: 280px; min-height: calc(100vh - 70px); padding: 24px; position: fixed; left: 0; top: 70px; z-index: 40; }
    .step-item { display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; margin-bottom: 8px; transition: all 0.3s ease; cursor: pointer; }
    .step-item:hover:not(.upcoming):not(.active) { background: rgba(255, 255, 255, 0.03); }
    .step-item.active { background: rgba(255, 107, 53, 0.08); cursor: default; }
    .step-item.completed { opacity: 0.6; cursor: pointer; }
    .step-item.completed:hover { opacity: 0.8; background: rgba(255, 255, 255, 0.03); }
    .step-item.upcoming { cursor: not-allowed; opacity: 0.3; pointer-events: none; }
    .step-number { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.08); }
    .step-item.active .step-number { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-color: transparent; box-shadow: 0 0 20px rgba(255, 107, 53, 0.3); }
    .step-item.completed .step-number { background: linear-gradient(135deg, #22c55e, #4ade80); border-color: transparent; }
    .step-label { font-size: 14px; font-weight: 500; color: rgba(255, 255, 255, 0.5); }
    .step-item.active .step-label { color: white; }

    .main-content { margin-left: 280px; padding: 40px; max-width: 700px; position: relative; z-index: 10; }
    .step-content { display: none; animation: fadeIn 0.4s ease; }
    .step-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .upload-zone { border: 2px dashed rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 40px 30px; text-align: center; transition: all 0.4s ease; cursor: pointer; background: rgba(255, 255, 255, 0.01); }
    .upload-zone:hover, .upload-zone.dragover { border-color: rgba(255, 107, 53, 0.4); background: rgba(255, 107, 53, 0.03); }
    .upload-zone.analyzing { border-color: rgba(255, 107, 53, 0.3); background: rgba(255, 107, 53, 0.05); pointer-events: none; }

    .btn-glow { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); width: 100%; font-size: 15px; }
    .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4); }
    .btn-glow:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 16px 32px; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%; }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .btn-telegram { background: linear-gradient(135deg, #0088cc, #00aaff); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease; width: 100%; font-size: 15px; }
    .btn-telegram:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 136, 204, 0.5); }

    .close-btn { position: fixed; top: 24px; right: 24px; width: 44px; height: 44px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; z-index: 100; transition: all 0.3s ease; text-decoration: none; }
    .close-btn:hover { background: rgba(255, 255, 255, 0.08); transform: rotate(90deg); }

    .employee-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 14px; transition: all 0.3s; }
    .employee-card:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.12); }
    .employee-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #FF6B35, #FF8B5E); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; flex-shrink: 0; }
    .employee-info { flex: 1; min-width: 0; }
    .employee-name { font-weight: 600; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .employee-meta { font-size: 13px; color: rgba(255,255,255,0.4); display: flex; gap: 8px; flex-wrap: wrap; margin-top: 2px; }
    .tag { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 500; }
    .tag-cdi { background: rgba(34,197,94,0.15); color: #4ade80; }
    .tag-cdd { background: rgba(59,130,246,0.15); color: #60a5fa; }
    .tag-stage { background: rgba(168,85,247,0.15); color: #c084fc; }
    .tag-alternance { background: rgba(234,179,8,0.15); color: #facc15; }

    .analyzing-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .check-icon { width: 60px; height: 60px; background: linear-gradient(135deg, #22c55e, #4ade80); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; animation: popIn 0.5s ease; }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

    .stat-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px; text-align: center; }
    .stat-value { font-size: 32px; font-weight: 700; background: linear-gradient(135deg, #FF6B35, #FF8B5E); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-label { font-size: 13px; color: rgba(255,255,255,0.4); margin-top: 4px; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; padding: 20px; max-width: 100%; }
      .upload-zone { padding: 30px 20px; }
    }

    /* Mobile steps indicator */
    .mobile-steps { display: none; position: fixed; top: 70px; left: 0; right: 0; background: rgba(10,10,10,0.95); backdrop-filter: blur(20px); padding: 16px 20px; z-index: 45; border-bottom: 1px solid rgba(255,255,255,0.05); }
    @media (max-width: 768px) { .mobile-steps { display: block; } .main-content { padding-top: 100px; } }
    .mobile-steps-track { display: flex; align-items: center; justify-content: center; gap: 6px; }
    .mobile-step { width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.3); }
    .mobile-step.active { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-color: transparent; color: white; }
    .mobile-step.completed { background: linear-gradient(135deg, #22c55e, #4ade80); border-color: transparent; color: white; }
    .mobile-step-line { width: 16px; height: 2px; background: rgba(255,255,255,0.1); }
    .mobile-step-label { text-align: center; margin-top: 12px; font-size: 13px; color: rgba(255,255,255,0.5); }
  </style>
</head>
<body class="bg-gradient-animate">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <!-- Header -->
  <nav class="glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-3xl mx-auto px-5 py-4 flex items-center justify-between">
      <a href="https://iarmy.fr" class="flex items-center gap-3">
        <div class="logo-i">i</div>
        <span class="font-semibold text-lg">iArmy</span>
      </a>
      <div id="auth-buttons"></div>
    </div>
  </nav>

  <!-- Mobile Steps -->
  <div class="mobile-steps">
    <div class="mobile-steps-track">
      <div class="mobile-step active" data-step="1"><span>1</span></div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="2"><span>2</span></div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="3"><span>3</span></div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="4"><span>4</span></div>
    </div>
    <div class="mobile-step-label" id="mobile-step-label">Contrats</div>
  </div>

  <div class="flex min-h-screen" style="padding-top: 70px;">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="mb-6">
        <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px;">Module</div>
        <div style="font-size: 18px; font-weight: 700; color: white; margin-top: 4px;">Planning</div>
      </div>
      <div id="steps-nav">
        <div class="step-item active" id="step-nav-1"><div class="step-number">1</div><span class="step-label">Contrats</span></div>
        <div class="step-item upcoming" id="step-nav-2"><div class="step-number">2</div><span class="step-label">Mon equipe</span></div>
        <div class="step-item upcoming" id="step-nav-3"><div class="step-number">3</div><span class="step-label">Paiement</span></div>
        <div class="step-item upcoming" id="step-nav-4"><div class="step-number">4</div><span class="step-label">Telegram</span></div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <a href="https://iarmy.fr" class="close-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></a>

      <!-- STEP 1: Upload Contrats -->
      <div class="step-content active" id="step-1">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 1/4</span></div>
        <h1 class="text-3xl font-bold mb-3">Envoie les contrats</h1>
        <p class="text-white/40 mb-6">Ajoute les contrats de tes employes un par un. L'IA extrait automatiquement les infos.</p>

        <!-- Upload Zone -->
        <div class="upload-zone mb-6" id="drop-zone" onclick="document.getElementById('file-input').click()">
          <input type="file" id="file-input" accept="image/*,.pdf" class="hidden" onchange="handleFileSelect(event)">
          <div id="upload-content">
            <svg class="w-12 h-12 mx-auto mb-3 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p class="text-white/50 mb-1">Glisse une photo ou clique</p>
            <p class="text-white/30 text-sm">Contrat, planning, fiche de paie...</p>
          </div>
        </div>

        <!-- Analyzing State -->
        <div id="analyzing-state" class="hidden glass-card p-6 mb-6">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-orange-400 analyzing-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
            </div>
            <div>
              <div class="font-semibold">Analyse du document</div>
              <div class="text-white/40 text-sm">L'IA extrait les informations...</div>
            </div>
          </div>
          <div class="space-y-2">
            <div class="flex items-center gap-3 text-sm" id="step-read">
              <div class="w-6 h-6 rounded-full bg-white/5 flex items-center justify-center text-white/30">1</div>
              <span class="text-white/40">Lecture du document</span>
            </div>
            <div class="flex items-center gap-3 text-sm" id="step-extract">
              <div class="w-6 h-6 rounded-full bg-white/5 flex items-center justify-center text-white/30">2</div>
              <span class="text-white/40">Extraction des informations</span>
            </div>
            <div class="flex items-center gap-3 text-sm" id="step-save">
              <div class="w-6 h-6 rounded-full bg-white/5 flex items-center justify-center text-white/30">3</div>
              <span class="text-white/40">Enregistrement</span>
            </div>
          </div>
        </div>

        <!-- Extracted Data Preview (shown after analysis) -->
        <div id="extracted-preview" class="hidden glass-card p-6 mb-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            </div>
            <div>
              <div class="font-semibold text-green-400">Employe detecte</div>
              <div class="text-white/40 text-sm">Verifie les infos extraites</div>
            </div>
          </div>

          <!-- Extracted fields -->
          <div class="space-y-3 mb-6">
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-white/50 text-sm">Nom</span>
              <span class="font-medium" id="preview-emp-name">-</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-white/50 text-sm">Poste</span>
              <span class="font-medium" id="preview-emp-role">-</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-white/50 text-sm">Contrat</span>
              <span id="preview-emp-contract">-</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
              <span class="text-white/50 text-sm">Heures/sem</span>
              <span class="font-medium" id="preview-emp-hours">-</span>
            </div>
          </div>

          <!-- What we'll do -->
          <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-orange-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <div class="text-sm">
                <div class="text-orange-400 font-medium mb-1">Ce qu'on va faire</div>
                <div class="text-white/60">Ajouter cet employe a ton equipe pour gerer ses plannings et heures de travail via Telegram.</div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <button onclick="cancelExtraction()" class="btn-secondary">Annuler</button>
            <button onclick="confirmExtraction()" class="btn-glow">Confirmer</button>
          </div>
        </div>

        <!-- Employee List (grows as you add) -->
        <div id="employees-list" class="space-y-3 mb-6"></div>

        <!-- Continue button (hidden until at least 1 employee) -->
        <div id="continue-section" class="hidden">
          <div class="flex items-center gap-4 mb-4">
            <div class="flex-1 h-px bg-white/10"></div>
            <span class="text-white/30 text-sm" id="employees-count-label">1 employe ajoute</span>
            <div class="flex-1 h-px bg-white/10"></div>
          </div>
          <button onclick="goToStep(2)" class="btn-glow">Continuer</button>
        </div>
      </div>

      <!-- STEP 2: Team Recap -->
      <div class="step-content" id="step-2">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 2/4</span></div>
        <h1 class="text-3xl font-bold mb-3">Ton equipe</h1>
        <p class="text-white/40 mb-6">Voici les informations extraites de tes contrats.</p>

        <!-- Stats -->
        <div class="grid grid-cols-3 gap-3 mb-6">
          <div class="stat-card">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">Employes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-hours">0</div>
            <div class="stat-label">Heures/sem</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-cdi">0</div>
            <div class="stat-label">CDI</div>
          </div>
        </div>

        <!-- Team List -->
        <div id="team-list" class="space-y-3 mb-6"></div>

        <!-- Actions -->
        <div class="grid grid-cols-2 gap-3">
          <button onclick="goToStep(1)" class="btn-secondary">+ Ajouter</button>
          <button onclick="goToStep(3)" class="btn-glow">Continuer</button>
        </div>
      </div>

      <!-- STEP 3: Payment -->
      <div class="step-content" id="step-3">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 3/4</span></div>
        <h1 class="text-3xl font-bold mb-3">Active ton essai gratuit</h1>
        <p class="text-white/40 mb-8">7 jours gratuits, puis 39‚Ç¨/mois. Annule quand tu veux.</p>

        <div class="glass-card p-8 max-w-lg mx-auto">
          <!-- Team summary -->
          <div class="flex items-center gap-4 mb-6 pb-6 border-b border-white/10">
            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-orange-500/20 to-orange-600/20 flex items-center justify-center text-xl font-bold text-orange-400" id="payment-team-count">0</div>
            <div>
              <div class="font-semibold text-lg">Ton equipe</div>
              <div class="text-white/40 text-sm" id="payment-team-info">0 employes</div>
            </div>
          </div>

          <div class="space-y-3 mb-6">
            <div class="flex items-center gap-3 text-white/70">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              <span>Gestion illimitee d'employes</span>
            </div>
            <div class="flex items-center gap-3 text-white/70">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              <span>Plannings automatiques</span>
            </div>
            <div class="flex items-center gap-3 text-white/70">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              <span>Rappels Telegram</span>
            </div>
            <div class="flex items-center gap-3 text-white/70">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              <span>Export documents</span>
            </div>
          </div>

          <div id="payment-loading" class="text-center py-8">
            <div class="w-8 h-8 border-2 border-white/20 border-t-orange-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white/40">Chargement...</p>
          </div>

          <div id="payment-form" style="display: none;">
            <div id="payment-element" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px;"></div>
            <div id="payment-error" style="color: #f87171; font-size: 13px; margin-bottom: 12px; display: none;"></div>
            <button id="btn-pay" onclick="confirmPayment()" class="btn-glow">
              Demarrer l'essai gratuit
            </button>
            <p class="text-center text-white/30 text-xs mt-4">Tu ne seras debite qu'apres 7 jours</p>
          </div>
        </div>
      </div>

      <!-- STEP 4: Telegram -->
      <div class="step-content" id="step-4">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 4/4</span></div>
        <h1 class="text-3xl font-bold mb-3">Connecte Telegram</h1>
        <p class="text-white/40 mb-8">Pour recevoir les notifications et gerer ton equipe</p>

        <div id="telegram-initial" class="glass-card p-8 max-w-lg mx-auto text-center">
          <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-blue-500/20 to-blue-500/5 flex items-center justify-center mb-6">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="#2AABEE">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.28-.37.78-.57 3.05-1.33 5.08-2.21 6.1-2.63 2.91-1.21 3.52-1.42 3.91-1.43.09 0 .28.02.41.12.1.09.13.21.15.34-.01.05.01.18 0 .28z"/>
            </svg>
          </div>
          <p class="text-white/50 mb-6">Le bot t'enverra des rappels et te permettra de gerer ton equipe directement depuis Telegram</p>
          <button onclick="connectTelegram()" class="btn-telegram" id="btn-telegram">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.28-.37.78-.57 3.05-1.33 5.08-2.21 6.1-2.63 2.91-1.21 3.52-1.42 3.91-1.43.09 0 .28.02.41.12.1.09.13.21.15.34-.01.05.01.18 0 .28z"/>
            </svg>
            Connecter Telegram
          </button>
        </div>

        <div id="telegram-connecting" class="glass-card p-8 max-w-lg mx-auto text-center" style="display: none;">
          <div class="w-8 h-8 border-2 border-white/20 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-white/50 mb-4">Clique sur "Demarrer" dans Telegram</p>
          <a id="telegram-link" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">Ouvrir manuellement</a>
        </div>

        <div id="telegram-connected" class="glass-card p-8 max-w-lg mx-auto text-center" style="display: none;">
          <div class="check-icon">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
          </div>
          <h3 class="text-2xl font-bold mb-2">C'est pret !</h3>
          <p class="text-white/50 mb-6">Ton module Planning est configure</p>
          <button onclick="goToPlanning()" class="btn-glow">Voir mon equipe</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_8mpFx9ubrV29KfKtgAb3eg_dyazidfT';
    const GEMINI_API_KEY = 'AIzaSyBvpwl8E8pRmcfkP4O8ybnl2xvH9kJ1n-U';
    const STRIPE_KEY = 'pk_live_51SnfoGQnTQdmBOkyXQ0lVJWGO24O9zzKNdXKNFQfq8r37uZRmKJgqmwQz66BYYjX96L1lP3XRQPFWwzIU8HxGKG300gNkmRVSd';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentStep = 1;
    let addedEmployees = [];
    let pendingEmployee = null; // Employee waiting for confirmation
    let stripe = null;
    let elements = null;
    let paymentElement = null;
    let connectionCheckInterval = null;

    // Init
    async function init() {
      // Check if from Telegram
      const tg = window.Telegram?.WebApp;
      if (tg && (tg.initData || tg.platform !== 'unknown')) {
        document.querySelector('.main-content').innerHTML = `
          <div class="glass-card p-8 text-center max-w-lg mx-auto" style="margin-top: 40px;">
            <div class="text-4xl mb-4">üåê</div>
            <h2 class="text-xl font-bold mb-3">Configuration sur le site</h2>
            <p class="text-white/50 mb-6">La configuration initiale doit etre faite sur le site web.</p>
            <a href="https://app.iarmy.fr/planning/setup/" class="btn-glow inline-block">Ouvrir le site</a>
          </div>
        `;
        return;
      }

      // Check auth
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'https://iarmy.fr?redirect=/planning/setup/';
        return;
      }
      currentUser = session.user;

      // Update auth buttons
      const userName = currentUser.user_metadata?.full_name || currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'User';
      const userAvatar = currentUser.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=FF6B35&color=fff`;
      document.getElementById('auth-buttons').innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <a href="/compte/" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; text-decoration: none; color: white;">
            <img src="${userAvatar}" style="width: 28px; height: 28px; border-radius: 50%; border: 2px solid rgba(255,107,53,0.3);">
            <span style="font-weight: 500; font-size: 14px;">${userName.split(' ')[0]}</span>
          </a>
        </div>
      `;

      // Check if already has subscription
      const { data: sub } = await supabase
        .from('subscriptions')
        .select('status, is_tester')
        .eq('user_id', currentUser.id)
        .eq('module_name', 'planning')
        .maybeSingle();

      if (sub?.status === 'active' || sub?.is_tester) {
        const { data: tgLink } = await supabase
          .from('telegram_links')
          .select('telegram_user_id')
          .eq('user_id', currentUser.id)
          .maybeSingle();

        if (tgLink?.telegram_user_id) {
          window.location.href = '/planning/';
          return;
        } else {
          goToStep(4);
          return;
        }
      }

      // Load existing employees (if any from previous attempt)
      const { data: existingEmployees } = await supabase
        .from('employees')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at');

      if (existingEmployees && existingEmployees.length > 0) {
        addedEmployees = existingEmployees;
        renderEmployeesList();
        updateContinueSection();
      }

      setupEventListeners();
    }

    function setupEventListeners() {
      const dropZone = document.getElementById('drop-zone');
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        dropZone.addEventListener(e, preventDefaults, false);
      });
      ['dragenter', 'dragover'].forEach(e => {
        dropZone.addEventListener(e, () => dropZone.classList.add('dragover'), false);
      });
      ['dragleave', 'drop'].forEach(e => {
        dropZone.addEventListener(e, () => dropZone.classList.remove('dragover'), false);
      });
      dropZone.addEventListener('drop', e => {
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
      });
    }

    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

    function handleFileSelect(e) {
      if (e.target.files.length) handleFile(e.target.files[0]);
    }

    async function handleFile(file) {
      if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
        alert('Format non supporte. Utilise une image ou PDF.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        await analyzeDocument(e.target.result);
      };
      reader.readAsDataURL(file);
    }

    async function analyzeDocument(base64) {
      // Hide upload zone, show analyzing state
      document.getElementById('drop-zone').classList.add('hidden');
      document.getElementById('analyzing-state').classList.remove('hidden');

      // Step 1: Reading
      updateAnalysisStep('step-read', 'active');

      try {
        await new Promise(r => setTimeout(r, 500)); // Small delay for UX
        updateAnalysisStep('step-read', 'done');
        updateAnalysisStep('step-extract', 'active');

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: `Analyse ce document (contrat de travail, planning, fiche de paie) et extrais les informations au format JSON:
{
  "name": "Nom complet de l'employe",
  "role": "Poste/Fonction",
  "contract_type": "CDI ou CDD ou Stage ou Alternance",
  "hours_per_week": nombre d'heures (entier),
  "start_date": "YYYY-MM-DD",
  "hourly_rate": taux horaire (nombre),
  "phone": "numero de telephone",
  "email": "email"
}
Si une info n'est pas visible, mets null. Reponds UNIQUEMENT avec le JSON.` },
                { inlineData: { mimeType: 'image/jpeg', data: base64.split(',')[1] } }
              ]
            }]
          })
        });

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const jsonMatch = text.match(/\{[\s\S]*\}/);

        if (jsonMatch) {
          const extractedData = JSON.parse(jsonMatch[0]);

          if (!extractedData.name) {
            throw new Error('No name extracted');
          }

          updateAnalysisStep('step-extract', 'done');
          updateAnalysisStep('step-save', 'active');
          await new Promise(r => setTimeout(r, 300));
          updateAnalysisStep('step-save', 'done');

          // Store pending employee and show preview
          pendingEmployee = extractedData;
          showExtractionPreview(extractedData);

        } else {
          throw new Error('No JSON found');
        }
      } catch (err) {
        console.error('Analyze error:', err);
        alert('L\'IA n\'a pas pu lire ce document. Essaie avec une photo plus nette.');
        resetUploadZone();
      }
    }

    function updateAnalysisStep(stepId, state) {
      const step = document.getElementById(stepId);
      const icon = step.querySelector('div');
      const text = step.querySelector('span');

      if (state === 'active') {
        icon.className = 'w-6 h-6 rounded-full bg-orange-500/20 flex items-center justify-center';
        icon.innerHTML = '<svg class="w-3 h-3 text-orange-400 analyzing-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>';
        text.className = 'text-white';
      } else if (state === 'done') {
        icon.className = 'w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center';
        icon.innerHTML = '<svg class="w-3 h-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
        text.className = 'text-white/60';
      }
    }

    function showExtractionPreview(data) {
      document.getElementById('analyzing-state').classList.add('hidden');
      document.getElementById('extracted-preview').classList.remove('hidden');

      // Fill preview fields
      document.getElementById('preview-emp-name').textContent = data.name || '-';
      document.getElementById('preview-emp-role').textContent = data.role || 'Non specifie';
      document.getElementById('preview-emp-hours').textContent = (data.hours_per_week || 35) + 'h';

      const contractEl = document.getElementById('preview-emp-contract');
      if (data.contract_type) {
        const type = data.contract_type.toUpperCase();
        let tagClass = 'tag-cdi';
        if (type === 'CDD') tagClass = 'tag-cdd';
        else if (type === 'STAGE') tagClass = 'tag-stage';
        else if (type === 'ALTERNANCE') tagClass = 'tag-alternance';
        contractEl.innerHTML = `<span class="tag ${tagClass}">${data.contract_type}</span>`;
      } else {
        contractEl.textContent = 'Non specifie';
      }
    }

    function cancelExtraction() {
      pendingEmployee = null;
      resetUploadZone();
    }

    async function confirmExtraction() {
      if (!pendingEmployee) return;

      const saved = await saveEmployeeData(pendingEmployee);
      if (saved) {
        pendingEmployee = null;
        document.getElementById('extracted-preview').classList.add('hidden');
        resetUploadZone();
      } else {
        alert('Erreur lors de l\'enregistrement');
      }
    }

    function resetUploadZone() {
      document.getElementById('drop-zone').classList.remove('hidden');
      document.getElementById('analyzing-state').classList.add('hidden');
      document.getElementById('extracted-preview').classList.add('hidden');
      document.getElementById('file-input').value = '';

      // Reset analysis steps
      ['step-read', 'step-extract', 'step-save'].forEach(stepId => {
        const step = document.getElementById(stepId);
        const icon = step.querySelector('div');
        const num = stepId === 'step-read' ? '1' : stepId === 'step-extract' ? '2' : '3';
        icon.className = 'w-6 h-6 rounded-full bg-white/5 flex items-center justify-center text-white/30';
        icon.innerHTML = num;
        step.querySelector('span').className = 'text-white/40';
      });
    }

    async function saveEmployeeData(data) {
      if (!data.name) return false;

      const employeeData = {
        user_id: currentUser.id,
        name: data.name,
        role: data.role || null,
        contract_type: data.contract_type || null,
        hours_per_week: data.hours_per_week || 35,
        hourly_rate: data.hourly_rate || null,
        start_date: data.start_date || null,
        work_days: ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'],
        phone: data.phone || null,
        email: data.email || null
      };

      const { data: inserted, error } = await supabase.from('employees').insert(employeeData).select().single();
      if (error) {
        console.error('Save employee error:', error);
        return false;
      }

      addedEmployees.push(inserted);
      renderEmployeesList();
      updateContinueSection();
      return true;
    }

    function renderEmployeesList() {
      const container = document.getElementById('employees-list');
      container.innerHTML = addedEmployees.map(emp => `
        <div class="employee-card">
          <div class="employee-avatar">${emp.name.charAt(0).toUpperCase()}</div>
          <div class="employee-info">
            <div class="employee-name">${emp.name}</div>
            <div class="employee-meta">
              <span>${emp.role || 'Employe'}</span>
              ${emp.contract_type ? `<span class="tag tag-${emp.contract_type.toLowerCase()}">${emp.contract_type}</span>` : ''}
              <span>${emp.hours_per_week || 35}h/sem</span>
            </div>
          </div>
          <button onclick="removeEmployee('${emp.id}')" class="text-white/30 hover:text-red-400 p-2" title="Supprimer">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      `).join('');
    }

    async function removeEmployee(id) {
      if (!confirm('Supprimer cet employe ?')) return;

      await supabase.from('employees').delete().eq('id', id);
      addedEmployees = addedEmployees.filter(e => e.id !== id);
      renderEmployeesList();
      updateContinueSection();
    }

    function updateContinueSection() {
      const section = document.getElementById('continue-section');
      const label = document.getElementById('employees-count-label');
      const count = addedEmployees.length;

      if (count > 0) {
        section.classList.remove('hidden');
        label.textContent = count + ' employe' + (count > 1 ? 's' : '') + ' ajoute' + (count > 1 ? 's' : '');
      } else {
        section.classList.add('hidden');
      }
    }

    function renderTeamRecap() {
      const container = document.getElementById('team-list');
      container.innerHTML = addedEmployees.map(emp => `
        <div class="employee-card">
          <div class="employee-avatar">${emp.name.charAt(0).toUpperCase()}</div>
          <div class="employee-info">
            <div class="employee-name">${emp.name}</div>
            <div class="employee-meta">
              <span>${emp.role || 'Employe'}</span>
              ${emp.contract_type ? `<span class="tag tag-${emp.contract_type.toLowerCase()}">${emp.contract_type}</span>` : ''}
              <span>${emp.hours_per_week || 35}h/sem</span>
            </div>
          </div>
        </div>
      `).join('');

      // Stats
      document.getElementById('stat-total').textContent = addedEmployees.length;
      document.getElementById('stat-hours').textContent = addedEmployees.reduce((sum, e) => sum + (e.hours_per_week || 35), 0);
      document.getElementById('stat-cdi').textContent = addedEmployees.filter(e => e.contract_type?.toUpperCase() === 'CDI').length;

      // Payment summary
      document.getElementById('payment-team-count').textContent = addedEmployees.length;
      document.getElementById('payment-team-info').textContent = addedEmployees.length + ' employe' + (addedEmployees.length > 1 ? 's' : '');
    }

    async function initStripePayment() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const res = await fetch(SUPABASE_URL + '/functions/v1/create-setup-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token
          },
          body: JSON.stringify({ module_name: 'planning' })
        });

        const { clientSecret, hasAccess } = await res.json();

        if (hasAccess) {
          goToStep(4);
          return;
        }

        stripe = Stripe(STRIPE_KEY);
        elements = stripe.elements({
          clientSecret,
          appearance: {
            theme: 'night',
            variables: {
              colorPrimary: '#FF6B35',
              colorBackground: '#141414',
              colorText: '#ffffff',
              colorDanger: '#f87171',
              borderRadius: '12px'
            }
          }
        });

        paymentElement = elements.create('payment', { layout: 'tabs' });
        paymentElement.mount('#payment-element');

        document.getElementById('payment-loading').style.display = 'none';
        document.getElementById('payment-form').style.display = 'block';

      } catch (err) {
        console.error('Stripe init error:', err);
        document.getElementById('payment-loading').innerHTML = '<p class="text-red-400">Erreur de chargement</p><button onclick="initStripePayment()" class="btn-secondary mt-4">Reessayer</button>';
      }
    }

    async function confirmPayment() {
      const btn = document.getElementById('btn-pay');
      const errorEl = document.getElementById('payment-error');
      btn.disabled = true;
      btn.textContent = 'Traitement...';
      errorEl.style.display = 'none';

      try {
        const { error } = await stripe.confirmSetup({
          elements,
          confirmParams: {
            return_url: window.location.origin + '/planning/setup/?payment=success'
          }
        });

        if (error) {
          errorEl.textContent = error.message;
          errorEl.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Demarrer l\'essai gratuit';
        }
      } catch (err) {
        errorEl.textContent = 'Une erreur est survenue';
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Demarrer l\'essai gratuit';
      }
    }

    async function connectTelegram() {
      const btn = document.getElementById('btn-telegram');
      btn.disabled = true;
      btn.textContent = 'Connexion...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        const res = await fetch(SUPABASE_URL + '/functions/v1/generate-telegram-link', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token
          }
        });

        const { token } = await res.json();
        const telegramLink = 'https://t.me/IArmyBOT?start=' + token;

        document.getElementById('telegram-initial').style.display = 'none';
        document.getElementById('telegram-connecting').style.display = 'block';
        document.getElementById('telegram-link').href = telegramLink;

        window.open(telegramLink, '_blank');
        startConnectionCheck();
      } catch (err) {
        alert('Erreur: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Connecter Telegram';
      }
    }

    function startConnectionCheck() {
      connectionCheckInterval = setInterval(async () => {
        const { data } = await supabase
          .from('telegram_links')
          .select('telegram_user_id')
          .eq('user_id', currentUser.id)
          .maybeSingle();

        if (data?.telegram_user_id) {
          clearInterval(connectionCheckInterval);
          document.getElementById('telegram-connecting').style.display = 'none';
          document.getElementById('telegram-connected').style.display = 'block';
        }
      }, 3000);
    }

    function goToPlanning() {
      window.location.href = '/planning/';
    }

    function goToStep(step) {
      currentStep = step;

      const stepLabels = ['Contrats', 'Mon equipe', 'Paiement', 'Telegram'];

      // Update sidebar
      for (let i = 1; i <= 4; i++) {
        const nav = document.getElementById('step-nav-' + i);
        const mobileStep = document.querySelector('.mobile-step[data-step="' + i + '"]');
        nav.classList.remove('active', 'completed', 'upcoming');
        mobileStep.classList.remove('active', 'completed');

        if (i < step) {
          nav.classList.add('completed');
          mobileStep.classList.add('completed');
        } else if (i === step) {
          nav.classList.add('active');
          mobileStep.classList.add('active');
        } else {
          nav.classList.add('upcoming');
        }
      }
      document.getElementById('mobile-step-label').textContent = stepLabels[step - 1];

      // Show step content
      document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
      document.getElementById('step-' + step).classList.add('active');

      // Step-specific actions
      if (step === 2) {
        renderTeamRecap();
      } else if (step === 3) {
        renderTeamRecap();
        initStripePayment();
      }
    }

    // Check payment return
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('payment') === 'success') {
      window.history.replaceState({}, '', '/planning/setup/');
      setTimeout(async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
          currentUser = session.user;
          goToStep(4);
        }
      }, 1000);
    } else {
      init();
    }
  </script>
</body>
</html>
