<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock - Configuration | iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23FF6B35'/%3E%3Ctext x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'%3Ei%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { background: #0a0a0a; color: white; min-height: 100vh; overflow-x: hidden; }
    .bg-gradient-animate { background: linear-gradient(135deg, #0a0a0a 0%, #0f0a0d 25%, #0a0f0f 50%, #0d0f0a 75%, #0a0a0a 100%); background-size: 400% 400%; animation: gradientShift 20s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.2; animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 0; }
    .orb-1 { width: 400px; height: 400px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); top: -200px; right: -100px; }
    .orb-2 { width: 300px; height: 300px; background: linear-gradient(135deg, #10B981, #34D399); bottom: -150px; left: -100px; animation-delay: -7s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }

    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(24px); border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.04); }
    .glass-card { background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); }

    .logo-i { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; }

    .sidebar { background: rgba(255, 255, 255, 0.01); backdrop-filter: blur(20px); width: 280px; min-height: calc(100vh - 70px); padding: 24px; position: fixed; left: 0; top: 70px; z-index: 40; overflow-y: auto; }
    .step-item { display: flex; align-items: center; gap: 14px; padding: 12px 14px; border-radius: 12px; margin-bottom: 6px; transition: all 0.3s ease; cursor: pointer; }
    .step-item.active { background: rgba(255, 107, 53, 0.08); }
    .step-item.completed { opacity: 0.6; }
    .step-item.upcoming { opacity: 0.3; pointer-events: none; }
    .step-number { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.08); }
    .step-item.active .step-number { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-color: transparent; }
    .step-item.completed .step-number { background: linear-gradient(135deg, #22c55e, #4ade80); border-color: transparent; }
    .step-label { font-size: 13px; font-weight: 500; color: rgba(255, 255, 255, 0.5); }
    .step-item.active .step-label { color: white; }

    .main-content { margin-left: 280px; padding: 40px; max-width: 700px; position: relative; z-index: 10; }
    .step-content { display: none; animation: fadeIn 0.4s ease; }
    .step-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .upload-zone { border: 2px dashed rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 40px 30px; text-align: center; transition: all 0.4s ease; cursor: pointer; background: rgba(255, 255, 255, 0.01); }
    .upload-zone:hover { border-color: rgba(255, 107, 53, 0.4); background: rgba(255, 107, 53, 0.03); }

    .btn-glow { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); width: 100%; font-size: 15px; }
    .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4); }
    .btn-glow:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 16px 32px; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%; }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .btn-telegram { background: linear-gradient(135deg, #0088cc, #00aaff); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease; width: 100%; font-size: 15px; }
    .btn-telegram:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 136, 204, 0.5); }

    .close-btn { position: fixed; top: 24px; right: 24px; width: 44px; height: 44px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; z-index: 100; transition: all 0.3s ease; text-decoration: none; }
    .close-btn:hover { background: rgba(255, 255, 255, 0.08); transform: rotate(90deg); }

    .input { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 14px 16px; color: white; font-size: 15px; width: 100%; }
    .input:focus { outline: none; border-color: rgba(255,107,53,0.5); }
    .input::placeholder { color: rgba(255,255,255,0.3); }

    .item-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 14px; transition: all 0.3s; }
    .item-card:hover { background: rgba(255,255,255,0.05); }
    .item-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
    .item-info { flex: 1; min-width: 0; }
    .item-name { font-weight: 600; font-size: 15px; }
    .item-meta { font-size: 13px; color: rgba(255,255,255,0.4); }

    .tag { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; }
    .tag-green { background: rgba(34,197,94,0.15); color: #4ade80; }
    .tag-blue { background: rgba(59,130,246,0.15); color: #60a5fa; }
    .tag-orange { background: rgba(255,107,53,0.15); color: #FF8B5E; }
    .tag-red { background: rgba(239,68,68,0.15); color: #f87171; }

    .analyzing-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .check-icon { width: 60px; height: 60px; background: linear-gradient(135deg, #22c55e, #4ade80); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; animation: popIn 0.5s ease; }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

    .stat-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #FF6B35, #FF8B5E); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stat-label { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 4px; }

    .threshold-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px; }
    .threshold-header { display: flex; align-items: center; justify-content: between; margin-bottom: 12px; }
    .threshold-value { display: flex; align-items: center; gap: 12px; }
    .threshold-input { width: 80px; text-align: center; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; padding: 20px; max-width: 100%; }
    }

    .mobile-steps { display: none; position: fixed; top: 70px; left: 0; right: 0; background: rgba(10,10,10,0.95); backdrop-filter: blur(20px); padding: 12px 20px; z-index: 45; border-bottom: 1px solid rgba(255,255,255,0.05); }
    @media (max-width: 768px) { .mobile-steps { display: block; } .main-content { padding-top: 80px; } }
    .mobile-steps-track { display: flex; align-items: center; justify-content: center; gap: 4px; }
    .mobile-step { width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.3); }
    .mobile-step.active { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-color: transparent; color: white; }
    .mobile-step.completed { background: linear-gradient(135deg, #22c55e, #4ade80); border-color: transparent; color: white; }
    .mobile-step-line { width: 12px; height: 2px; background: rgba(255,255,255,0.1); }
    .mobile-step-label { text-align: center; margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.5); }
  </style>
</head>
<body class="bg-gradient-animate">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <!-- Header -->
  <nav class="glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="https://iarmy.fr" class="flex items-center gap-3">
        <div class="logo-i">i</div>
        <span class="font-semibold text-lg">Stock</span>
      </a>
    </div>
  </nav>

  <!-- Mobile Steps -->
  <div class="mobile-steps">
    <div class="mobile-steps-track">
      <div class="mobile-step active" data-step="1">1</div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="2">2</div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="3">3</div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="4">4</div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="5">5</div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="6">6</div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="7">7</div>
      <div class="mobile-step-line"></div>
      <div class="mobile-step" data-step="8">8</div>
    </div>
    <div class="mobile-step-label" id="mobile-step-label">Ta carte</div>
  </div>

  <div class="flex min-h-screen" style="padding-top: 70px;">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="mb-6">
        <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px;">Module</div>
        <div style="font-size: 18px; font-weight: 700; color: white; margin-top: 4px;">Stock</div>
        <div style="font-size: 12px; color: rgba(255,255,255,0.3); margin-top: 2px;">Gestion bar</div>
      </div>
      <div id="steps-nav">
        <div class="step-item active" id="step-nav-1"><div class="step-number">1</div><span class="step-label">Ta carte</span></div>
        <div class="step-item upcoming" id="step-nav-2"><div class="step-number">2</div><span class="step-label">Tes produits</span></div>
        <div class="step-item upcoming" id="step-nav-3"><div class="step-number">3</div><span class="step-label">Fiches techniques</span></div>
        <div class="step-item upcoming" id="step-nav-4"><div class="step-number">4</div><span class="step-label">Inventaire</span></div>
        <div class="step-item upcoming" id="step-nav-5"><div class="step-number">5</div><span class="step-label">Seuils & alertes</span></div>
        <div class="step-item upcoming" id="step-nav-6"><div class="step-number">6</div><span class="step-label">Fournisseurs</span></div>
        <div class="step-item upcoming" id="step-nav-7"><div class="step-number">7</div><span class="step-label">Paiement</span></div>
        <div class="step-item upcoming" id="step-nav-8"><div class="step-number">8</div><span class="step-label">Telegram</span></div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <a href="https://iarmy.fr" class="close-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></a>

      <!-- STEP 1: Carte -->
      <div class="step-content active" id="step-1">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 1/8</span></div>
        <h1 class="text-3xl font-bold mb-3">Ta carte de cocktails</h1>
        <p class="text-white/40 mb-6">Envoie une photo de ta carte ou ajoute tes cocktails manuellement.</p>

        <!-- Upload Zone -->
        <div class="upload-zone mb-6" id="menu-drop-zone" onclick="document.getElementById('menu-file-input').click()">
          <input type="file" id="menu-file-input" accept="image/*,.pdf" class="hidden" onchange="handleMenuUpload(event)">
          <svg class="w-12 h-12 mx-auto mb-3 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <p class="text-white/50 mb-1">Photo de ta carte</p>
          <p class="text-white/30 text-sm">L'IA detecte les cocktails et prix</p>
        </div>

        <!-- Analyzing -->
        <div id="menu-analyzing" class="hidden glass-card p-6 mb-6">
          <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-orange-400 analyzing-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
            </div>
            <div>
              <div class="font-semibold">Analyse de ta carte...</div>
              <div class="text-white/40 text-sm">Detection des cocktails et prix</div>
            </div>
          </div>
        </div>

        <!-- Manual add -->
        <div class="flex items-center gap-4 mb-4">
          <div class="flex-1 h-px bg-white/10"></div>
          <span class="text-white/30 text-sm">ou ajoute manuellement</span>
          <div class="flex-1 h-px bg-white/10"></div>
        </div>

        <div class="flex gap-3 mb-6">
          <input type="text" id="cocktail-name" class="input flex-1" placeholder="Nom du cocktail">
          <input type="number" id="cocktail-price" class="input" style="width: 100px;" placeholder="Prix ‚Ç¨">
          <button onclick="addCocktail()" class="btn-secondary" style="width: auto; padding: 14px 20px;">+</button>
        </div>

        <!-- Cocktails List -->
        <div id="cocktails-list" class="space-y-3 mb-6"></div>

        <!-- Continue -->
        <div id="cocktails-continue" class="hidden">
          <div class="flex items-center gap-4 mb-4">
            <div class="flex-1 h-px bg-white/10"></div>
            <span class="text-white/30 text-sm" id="cocktails-count">0 cocktails</span>
            <div class="flex-1 h-px bg-white/10"></div>
          </div>
          <button onclick="goToStep(2)" class="btn-glow">Continuer</button>
        </div>
      </div>

      <!-- STEP 2: Produits -->
      <div class="step-content" id="step-2">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 2/8</span></div>
        <h1 class="text-3xl font-bold mb-3">Tes produits</h1>
        <p class="text-white/40 mb-6">Ajoute tes bouteilles et ingredients. Photo ou manuel.</p>

        <!-- Upload Zone -->
        <div class="upload-zone mb-6" id="products-drop-zone" onclick="document.getElementById('products-file-input').click()">
          <input type="file" id="products-file-input" accept="image/*" class="hidden" onchange="handleProductsUpload(event)">
          <svg class="w-12 h-12 mx-auto mb-3 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
          </svg>
          <p class="text-white/50 mb-1">Photo de tes bouteilles</p>
          <p class="text-white/30 text-sm">L'IA detecte marques et contenances</p>
        </div>

        <!-- Analyzing -->
        <div id="products-analyzing" class="hidden glass-card p-6 mb-6">
          <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-orange-400 analyzing-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
            </div>
            <div>
              <div class="font-semibold">Detection des bouteilles...</div>
              <div class="text-white/40 text-sm">Identification des marques</div>
            </div>
          </div>
        </div>

        <!-- Manual add -->
        <div class="flex items-center gap-4 mb-4">
          <div class="flex-1 h-px bg-white/10"></div>
          <span class="text-white/30 text-sm">ou ajoute manuellement</span>
          <div class="flex-1 h-px bg-white/10"></div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
          <input type="text" id="product-name" class="input" placeholder="Nom (ex: Havana Club)">
          <select id="product-type" class="input">
            <option value="spirit">Spiritueux</option>
            <option value="liqueur">Liqueur</option>
            <option value="wine">Vin</option>
            <option value="beer">Biere</option>
            <option value="soft">Soft</option>
            <option value="other">Autre</option>
          </select>
        </div>
        <div class="grid grid-cols-3 gap-3 mb-4">
          <input type="number" id="product-volume" class="input" placeholder="Volume (cl)">
          <input type="number" id="product-price" class="input" placeholder="Prix achat ‚Ç¨">
          <button onclick="addProduct()" class="btn-secondary" style="padding: 14px;">+ Ajouter</button>
        </div>

        <!-- Products List -->
        <div id="products-list" class="space-y-3 mb-6"></div>

        <!-- Continue -->
        <div id="products-continue" class="hidden">
          <div class="flex items-center gap-4 mb-4">
            <div class="flex-1 h-px bg-white/10"></div>
            <span class="text-white/30 text-sm" id="products-count">0 produits</span>
            <div class="flex-1 h-px bg-white/10"></div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button onclick="goToStep(1)" class="btn-secondary">Retour</button>
            <button onclick="goToStep(3)" class="btn-glow">Continuer</button>
          </div>
        </div>
      </div>

      <!-- STEP 3: Fiches techniques -->
      <div class="step-content" id="step-3">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 3/8</span></div>
        <h1 class="text-3xl font-bold mb-3">Fiches techniques</h1>
        <p class="text-white/40 mb-6">Definis les ingredients de chaque cocktail pour calculer les marges.</p>

        <!-- Recipe selector -->
        <div class="mb-6">
          <label class="block text-white/50 text-sm mb-2">Cocktail a configurer</label>
          <select id="recipe-cocktail" class="input" onchange="loadRecipe()">
            <option value="">-- Choisis un cocktail --</option>
          </select>
        </div>

        <!-- Recipe editor -->
        <div id="recipe-editor" class="hidden">
          <div class="glass-card p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-lg" id="recipe-name">Mojito</h3>
              <span class="tag tag-green" id="recipe-margin">Marge: --</span>
            </div>

            <!-- Ingredients list -->
            <div id="recipe-ingredients" class="space-y-3 mb-4"></div>

            <!-- Add ingredient -->
            <div class="flex gap-3">
              <select id="ingredient-product" class="input flex-1">
                <option value="">+ Ajouter ingredient</option>
              </select>
              <input type="number" id="ingredient-qty" class="input" style="width: 80px;" placeholder="cl">
              <button onclick="addIngredient()" class="btn-secondary" style="width: auto; padding: 14px 16px;">+</button>
            </div>
          </div>

          <!-- Price breakdown -->
          <div class="glass-card p-4 mb-6">
            <div class="flex justify-between text-sm mb-2">
              <span class="text-white/50">Cout ingredients</span>
              <span id="recipe-cost">0.00‚Ç¨</span>
            </div>
            <div class="flex justify-between text-sm mb-2">
              <span class="text-white/50">Prix de vente</span>
              <span id="recipe-price">0.00‚Ç¨</span>
            </div>
            <div class="flex justify-between font-semibold">
              <span>Marge</span>
              <span class="text-green-400" id="recipe-margin-value">0%</span>
            </div>
          </div>

          <button onclick="saveRecipe()" class="btn-glow mb-4">Enregistrer cette fiche</button>
        </div>

        <!-- Progress -->
        <div class="glass-card p-4 mb-6">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-white/50">Fiches completees</span>
            <span id="recipes-progress">0 / 0</span>
          </div>
          <div class="h-2 bg-white/10 rounded-full overflow-hidden">
            <div id="recipes-progress-bar" class="h-full bg-gradient-to-r from-orange-500 to-orange-400 transition-all" style="width: 0%"></div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="goToStep(2)" class="btn-secondary">Retour</button>
          <button onclick="goToStep(4)" class="btn-glow" id="recipes-continue-btn" disabled>Continuer</button>
        </div>
      </div>

      <!-- STEP 4: Inventaire -->
      <div class="step-content" id="step-4">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 4/8</span></div>
        <h1 class="text-3xl font-bold mb-3">Inventaire initial</h1>
        <p class="text-white/40 mb-6">Compte tes bouteilles actuelles. Photo ou manuel.</p>

        <!-- Upload Zone -->
        <div class="upload-zone mb-6" id="inventory-drop-zone" onclick="document.getElementById('inventory-file-input').click()">
          <input type="file" id="inventory-file-input" accept="image/*" class="hidden" onchange="handleInventoryUpload(event)">
          <svg class="w-12 h-12 mx-auto mb-3 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
          </svg>
          <p class="text-white/50 mb-1">Photo de ton stock</p>
          <p class="text-white/30 text-sm">L'IA compte les bouteilles</p>
        </div>

        <!-- Inventory list -->
        <div id="inventory-list" class="space-y-3 mb-6"></div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="goToStep(3)" class="btn-secondary">Retour</button>
          <button onclick="goToStep(5)" class="btn-glow">Continuer</button>
        </div>
      </div>

      <!-- STEP 5: Seuils -->
      <div class="step-content" id="step-5">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 5/8</span></div>
        <h1 class="text-3xl font-bold mb-3">Seuils & alertes</h1>
        <p class="text-white/40 mb-6">Configure tes objectifs de marge et alertes de stock.</p>

        <div class="space-y-4 mb-6">
          <!-- Marge cible -->
          <div class="threshold-card">
            <div class="flex items-center justify-between mb-3">
              <div>
                <div class="font-semibold">Marge cible</div>
                <div class="text-white/40 text-sm">Objectif de marge sur les cocktails</div>
              </div>
              <div class="flex items-center gap-2">
                <input type="number" id="threshold-margin" class="input threshold-input" value="70">
                <span class="text-white/50">%</span>
              </div>
            </div>
            <div class="text-xs text-white/30">Alerte si un cocktail passe en dessous</div>
          </div>

          <!-- Stock bas -->
          <div class="threshold-card">
            <div class="flex items-center justify-between mb-3">
              <div>
                <div class="font-semibold">Stock bas</div>
                <div class="text-white/40 text-sm">Seuil d'alerte pour commander</div>
              </div>
              <div class="flex items-center gap-2">
                <input type="number" id="threshold-stock" class="input threshold-input" value="2">
                <span class="text-white/50">bouteilles</span>
              </div>
            </div>
            <div class="text-xs text-white/30">Alerte quand un produit passe en dessous</div>
          </div>

          <!-- Ecart inventaire -->
          <div class="threshold-card">
            <div class="flex items-center justify-between mb-3">
              <div>
                <div class="font-semibold">Ecart inventaire</div>
                <div class="text-white/40 text-sm">Tolerance entre reel et theorique</div>
              </div>
              <div class="flex items-center gap-2">
                <input type="number" id="threshold-variance" class="input threshold-input" value="10">
                <span class="text-white/50">%</span>
              </div>
            </div>
            <div class="text-xs text-white/30">Alerte si l'ecart depasse ce seuil</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="goToStep(4)" class="btn-secondary">Retour</button>
          <button onclick="saveThresholds(); goToStep(6)" class="btn-glow">Continuer</button>
        </div>
      </div>

      <!-- STEP 6: Fournisseurs -->
      <div class="step-content" id="step-6">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 6/8</span></div>
        <h1 class="text-3xl font-bold mb-3">Tes fournisseurs</h1>
        <p class="text-white/40 mb-6">Ajoute tes fournisseurs pour faciliter les commandes.</p>

        <!-- Add supplier -->
        <div class="glass-card p-6 mb-6">
          <div class="grid grid-cols-2 gap-3 mb-4">
            <input type="text" id="supplier-name" class="input" placeholder="Nom (ex: Metro)">
            <input type="text" id="supplier-contact" class="input" placeholder="Contact/Tel">
          </div>
          <button onclick="addSupplier()" class="btn-secondary">+ Ajouter fournisseur</button>
        </div>

        <!-- Suppliers list -->
        <div id="suppliers-list" class="space-y-3 mb-6"></div>

        <p class="text-white/30 text-sm text-center mb-6">Tu pourras aussi ajouter des fournisseurs plus tard en envoyant une facture sur Telegram</p>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="goToStep(5)" class="btn-secondary">Retour</button>
          <button onclick="goToStep(7)" class="btn-glow">Continuer</button>
        </div>
      </div>

      <!-- STEP 7: Paiement -->
      <div class="step-content" id="step-7">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 7/8</span></div>
        <h1 class="text-3xl font-bold mb-3">Active ton essai gratuit</h1>
        <p class="text-white/40 mb-8">7 jours gratuits, puis 29‚Ç¨/mois. Annule quand tu veux.</p>

        <div class="glass-card p-8 max-w-lg mx-auto">
          <!-- Summary -->
          <div class="grid grid-cols-3 gap-3 mb-6 pb-6 border-b border-white/10">
            <div class="text-center">
              <div class="text-2xl font-bold text-orange-400" id="summary-cocktails">0</div>
              <div class="text-xs text-white/40">Cocktails</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-green-400" id="summary-products">0</div>
              <div class="text-xs text-white/40">Produits</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-blue-400" id="summary-suppliers">0</div>
              <div class="text-xs text-white/40">Fournisseurs</div>
            </div>
          </div>

          <div class="space-y-3 mb-6">
            <div class="flex items-center gap-3 text-white/70">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              <span>Suivi stock automatique</span>
            </div>
            <div class="flex items-center gap-3 text-white/70">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              <span>Analyse ticket Z par photo</span>
            </div>
            <div class="flex items-center gap-3 text-white/70">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              <span>Inventaire intelligent</span>
            </div>
            <div class="flex items-center gap-3 text-white/70">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              <span>Alertes marges & stock</span>
            </div>
          </div>

          <div id="payment-loading" class="text-center py-8">
            <div class="w-8 h-8 border-2 border-white/20 border-t-orange-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white/40">Chargement...</p>
          </div>

          <div id="payment-form" style="display: none;">
            <div id="payment-element" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px;"></div>
            <div id="payment-error" style="color: #f87171; font-size: 13px; margin-bottom: 12px; display: none;"></div>
            <button id="btn-pay" onclick="confirmPayment()" class="btn-glow">Demarrer l'essai gratuit</button>
            <p class="text-center text-white/30 text-xs mt-4">Tu ne seras debite qu'apres 7 jours</p>
          </div>
        </div>
      </div>

      <!-- STEP 8: Telegram -->
      <div class="step-content" id="step-8">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 8/8</span></div>
        <h1 class="text-3xl font-bold mb-3">Connecte Telegram</h1>
        <p class="text-white/40 mb-8">Pour gerer ton stock au quotidien</p>

        <div id="telegram-initial" class="glass-card p-8 max-w-lg mx-auto text-center">
          <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-blue-500/20 to-blue-500/5 flex items-center justify-center mb-6">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="#2AABEE">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.28-.37.78-.57 3.05-1.33 5.08-2.21 6.1-2.63 2.91-1.21 3.52-1.42 3.91-1.43.09 0 .28.02.41.12.1.09.13.21.15.34-.01.05.01.18 0 .28z"/>
            </svg>
          </div>
          <p class="text-white/50 mb-6">Envoie tes tickets Z, factures et inventaires directement sur Telegram</p>
          <button onclick="connectTelegram()" class="btn-telegram" id="btn-telegram">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.28-.37.78-.57 3.05-1.33 5.08-2.21 6.1-2.63 2.91-1.21 3.52-1.42 3.91-1.43.09 0 .28.02.41.12.1.09.13.21.15.34-.01.05.01.18 0 .28z"/>
            </svg>
            Connecter Telegram
          </button>
        </div>

        <div id="telegram-connecting" class="glass-card p-8 max-w-lg mx-auto text-center" style="display: none;">
          <div class="w-8 h-8 border-2 border-white/20 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-white/50 mb-4">Clique sur "Demarrer" dans Telegram</p>
          <a id="telegram-link" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">Ouvrir manuellement</a>
        </div>

        <div id="telegram-connected" class="glass-card p-8 max-w-lg mx-auto text-center" style="display: none;">
          <div class="check-icon">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
          </div>
          <h3 class="text-2xl font-bold mb-2">C'est pret !</h3>
          <p class="text-white/50 mb-6">Ton module Stock est configure</p>
          <button onclick="goToStock()" class="btn-glow">Voir mon stock</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cWZucGRjbmlmYXVod2dldGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY2MzQ4NDYsImV4cCI6MjA1MjIxMDg0Nn0.YjrRXPHBmag47WyLWOKPr7TIc0z3oN_AzNL5CSx3az8';
    const GEMINI_API_KEY = 'AIzaSyBvpwl8E8pRmcfkP4O8ybnl2xvH9kJ1n-U';
    const STRIPE_KEY = 'pk_live_51SnfoGQnTQdmBOkyXQ0lVJWGO24O9zzKNdXKNFQfq8r37uZRmKJgqmwQz66BYYjX96L1lP3XRQPFWwzIU8HxGKG300gNkmRVSd';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentStep = 1;
    let cocktails = [];
    let products = [];
    let recipes = {};
    let inventory = {};
    let suppliers = [];
    let thresholds = { margin: 70, stock: 2, variance: 10 };
    let stripe = null;
    let elements = null;
    let paymentElement = null;
    let connectionCheckInterval = null;
    let isTester = false; // Skip paiement si testeur

    const stepLabels = ['Ta carte', 'Tes produits', 'Fiches techniques', 'Inventaire', 'Seuils & alertes', 'Fournisseurs', 'Paiement', 'Telegram'];

    // Init
    async function init() {
      const tg = window.Telegram?.WebApp;
      if (tg && (tg.initData || tg.platform !== 'unknown')) {
        document.querySelector('.main-content').innerHTML = `
          <div class="glass-card p-8 text-center max-w-lg mx-auto" style="margin-top: 40px;">
            <div class="text-4xl mb-4">üåê</div>
            <h2 class="text-xl font-bold mb-3">Configuration sur le site</h2>
            <p class="text-white/50 mb-6">La configuration initiale doit etre faite sur le site web.</p>
            <a href="https://app.iarmy.fr/stock/setup/" class="btn-glow inline-block">Ouvrir le site</a>
          </div>
        `;
        return;
      }

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'https://iarmy.fr?redirect=/stock/setup/';
        return;
      }
      currentUser = session.user;

      // Check existing subscription
      const { data: sub } = await supabase
        .from('subscriptions')
        .select('status, is_tester')
        .eq('user_id', currentUser.id)
        .eq('module_name', 'stock')
        .maybeSingle();

      // Verifier si testeur
      isTester = sub?.is_tester === true;
      const hasActiveSubscription = sub?.status === 'active';

      // Check si deja configure (a des produits)
      const { count: productCount } = await supabase
        .from('stock_products')
        .select('id', { count: 'exact', head: true })
        .eq('user_id', currentUser.id);

      const isAlreadyConfigured = productCount > 0;

      // Si deja configure ET (testeur OU actif) ‚Üí redirect vers dashboard
      if (isAlreadyConfigured && (hasActiveSubscription || isTester)) {
        window.location.href = '/stock/';
        return;
      }

      // Si deja configure mais SANS subscription (essai termine) ‚Üí direct au paiement
      if (isAlreadyConfigured && !hasActiveSubscription && !isTester) {
        // Masquer toutes les etapes sauf paiement et telegram
        for (let i = 1; i <= 6; i++) {
          document.getElementById('step-nav-' + i).style.display = 'none';
          const mobileStep = document.querySelector('.mobile-step[data-step="' + i + '"]');
          if (mobileStep) mobileStep.style.display = 'none';
        }
        // Aller direct au paiement
        await loadExistingData();
        setTimeout(() => goToStep(7), 100);
        return;
      }

      // Si testeur, masquer l'etape paiement dans la nav
      if (isTester) {
        document.getElementById('step-nav-7').style.display = 'none';
        const mobileStep7 = document.querySelector('.mobile-step[data-step="7"]');
        if (mobileStep7) mobileStep7.style.display = 'none';
      }

      // Load existing data
      await loadExistingData();
    }

    async function loadExistingData() {
      // Load cocktails
      const { data: existingCocktails } = await supabase
        .from('stock_cocktails')
        .select('*')
        .eq('user_id', currentUser.id);
      if (existingCocktails) {
        cocktails = existingCocktails;
        renderCocktails();
      }

      // Load products
      const { data: existingProducts } = await supabase
        .from('stock_products')
        .select('*')
        .eq('user_id', currentUser.id);
      if (existingProducts) {
        products = existingProducts;
        renderProducts();
      }

      // Load suppliers
      const { data: existingSuppliers } = await supabase
        .from('stock_suppliers')
        .select('*')
        .eq('user_id', currentUser.id);
      if (existingSuppliers) {
        suppliers = existingSuppliers;
        renderSuppliers();
      }
    }

    // Navigation
    function goToStep(step) {
      // Si testeur et step 7 (paiement), skip direct vers step 8
      if (isTester && step === 7) {
        step = 8;
      }

      currentStep = step;

      for (let i = 1; i <= 8; i++) {
        const nav = document.getElementById('step-nav-' + i);
        const mobileStep = document.querySelector('.mobile-step[data-step="' + i + '"]');
        if (!nav) continue; // step 7 peut etre masque

        nav.classList.remove('active', 'completed', 'upcoming');
        if (mobileStep) mobileStep.classList.remove('active', 'completed');

        if (i < step) {
          nav.classList.add('completed');
          if (mobileStep) mobileStep.classList.add('completed');
        } else if (i === step) {
          nav.classList.add('active');
          if (mobileStep) mobileStep.classList.add('active');
        } else {
          nav.classList.add('upcoming');
        }
      }
      document.getElementById('mobile-step-label').textContent = stepLabels[step - 1];

      document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
      document.getElementById('step-' + step).classList.add('active');

      // Step specific actions
      if (step === 3) initRecipesStep();
      if (step === 4) initInventoryStep();
      if (step === 7 && !isTester) {
        updatePaymentSummary();
        initStripePayment();
      }
    }

    // ==================== STEP 1: Cocktails ====================
    async function handleMenuUpload(e) {
      if (!e.target.files.length) return;
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async (ev) => {
        document.getElementById('menu-drop-zone').classList.add('hidden');
        document.getElementById('menu-analyzing').classList.remove('hidden');

        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  { text: `Analyse cette carte de bar/restaurant et extrais tous les cocktails avec leurs prix. Reponds en JSON:
[{"name": "Mojito", "price": 12}, {"name": "Margarita", "price": 11}]
Reponds UNIQUEMENT avec le JSON.` },
                  { inlineData: { mimeType: file.type, data: ev.target.result.split(',')[1] } }
                ]
              }]
            })
          });

          const data = await response.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
          const jsonMatch = text.match(/\[[\s\S]*\]/);

          if (jsonMatch) {
            const extracted = JSON.parse(jsonMatch[0]);
            for (const c of extracted) {
              if (c.name && !cocktails.find(x => x.name.toLowerCase() === c.name.toLowerCase())) {
                await saveCocktail(c.name, c.price || 0);
              }
            }
          }
        } catch (err) {
          console.error('Menu analysis error:', err);
          alert('Erreur lors de l\'analyse. Ajoute tes cocktails manuellement.');
        }

        document.getElementById('menu-drop-zone').classList.remove('hidden');
        document.getElementById('menu-analyzing').classList.add('hidden');
        e.target.value = '';
      };
      reader.readAsDataURL(file);
    }

    async function addCocktail() {
      const name = document.getElementById('cocktail-name').value.trim();
      const price = parseFloat(document.getElementById('cocktail-price').value) || 0;
      if (!name) return;

      await saveCocktail(name, price);
      document.getElementById('cocktail-name').value = '';
      document.getElementById('cocktail-price').value = '';
    }

    async function saveCocktail(name, price) {
      const cocktailData = { user_id: currentUser.id, name, price };
      const { data, error } = await supabase.from('stock_cocktails').insert(cocktailData).select().single();
      if (!error && data) {
        cocktails.push(data);
        renderCocktails();
      }
    }

    function renderCocktails() {
      const container = document.getElementById('cocktails-list');
      container.innerHTML = cocktails.map(c => `
        <div class="item-card">
          <div class="item-icon" style="background: linear-gradient(135deg, rgba(255,107,53,0.2), rgba(255,107,53,0.1));">üçπ</div>
          <div class="item-info">
            <div class="item-name">${c.name}</div>
            <div class="item-meta">${c.price ? c.price + '‚Ç¨' : 'Prix non defini'}</div>
          </div>
          <button onclick="removeCocktail('${c.id}')" class="text-white/30 hover:text-red-400 p-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      `).join('');

      const count = cocktails.length;
      document.getElementById('cocktails-count').textContent = count + ' cocktail' + (count > 1 ? 's' : '');
      document.getElementById('cocktails-continue').classList.toggle('hidden', count === 0);
    }

    async function removeCocktail(id) {
      await supabase.from('stock_cocktails').delete().eq('id', id);
      cocktails = cocktails.filter(c => c.id !== id);
      renderCocktails();
    }

    // ==================== STEP 2: Products ====================
    async function handleProductsUpload(e) {
      if (!e.target.files.length) return;
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async (ev) => {
        document.getElementById('products-drop-zone').classList.add('hidden');
        document.getElementById('products-analyzing').classList.remove('hidden');

        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  { text: `Analyse cette photo de bouteilles et identifie chaque produit. Reponds en JSON:
[{"name": "Havana Club", "type": "spirit", "volume_cl": 70}, {"name": "Absolut", "type": "spirit", "volume_cl": 100}]
Types: spirit, liqueur, wine, beer, soft, other. Reponds UNIQUEMENT avec le JSON.` },
                  { inlineData: { mimeType: file.type, data: ev.target.result.split(',')[1] } }
                ]
              }]
            })
          });

          const data = await response.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
          const jsonMatch = text.match(/\[[\s\S]*\]/);

          if (jsonMatch) {
            const extracted = JSON.parse(jsonMatch[0]);
            for (const p of extracted) {
              if (p.name && !products.find(x => x.name.toLowerCase() === p.name.toLowerCase())) {
                await saveProduct(p.name, p.type || 'spirit', p.volume_cl || 70, 0);
              }
            }
          }
        } catch (err) {
          console.error('Products analysis error:', err);
          alert('Erreur lors de l\'analyse. Ajoute tes produits manuellement.');
        }

        document.getElementById('products-drop-zone').classList.remove('hidden');
        document.getElementById('products-analyzing').classList.add('hidden');
        e.target.value = '';
      };
      reader.readAsDataURL(file);
    }

    async function addProduct() {
      const name = document.getElementById('product-name').value.trim();
      const type = document.getElementById('product-type').value;
      const volume = parseFloat(document.getElementById('product-volume').value) || 70;
      const price = parseFloat(document.getElementById('product-price').value) || 0;
      if (!name) return;

      await saveProduct(name, type, volume, price);
      document.getElementById('product-name').value = '';
      document.getElementById('product-volume').value = '';
      document.getElementById('product-price').value = '';
    }

    async function saveProduct(name, type, volume_cl, purchase_price) {
      const productData = { user_id: currentUser.id, name, type, volume_cl, purchase_price };
      const { data, error } = await supabase.from('stock_products').insert(productData).select().single();
      if (!error && data) {
        products.push(data);
        renderProducts();
      }
    }

    function renderProducts() {
      const icons = { spirit: 'ü•É', liqueur: 'üçæ', wine: 'üç∑', beer: 'üç∫', soft: 'ü•§', other: 'üì¶' };
      const container = document.getElementById('products-list');
      container.innerHTML = products.map(p => `
        <div class="item-card">
          <div class="item-icon" style="background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.1));">${icons[p.type] || 'üì¶'}</div>
          <div class="item-info">
            <div class="item-name">${p.name}</div>
            <div class="item-meta">${p.volume_cl}cl ${p.purchase_price ? '‚Ä¢ ' + p.purchase_price + '‚Ç¨' : ''}</div>
          </div>
          <button onclick="removeProduct('${p.id}')" class="text-white/30 hover:text-red-400 p-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      `).join('');

      const count = products.length;
      document.getElementById('products-count').textContent = count + ' produit' + (count > 1 ? 's' : '');
      document.getElementById('products-continue').classList.toggle('hidden', count === 0);
    }

    async function removeProduct(id) {
      await supabase.from('stock_products').delete().eq('id', id);
      products = products.filter(p => p.id !== id);
      renderProducts();
    }

    // ==================== STEP 3: Recipes ====================
    function initRecipesStep() {
      const select = document.getElementById('recipe-cocktail');
      select.innerHTML = '<option value="">-- Choisis un cocktail --</option>' +
        cocktails.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

      const ingredientSelect = document.getElementById('ingredient-product');
      ingredientSelect.innerHTML = '<option value="">+ Ajouter ingredient</option>' +
        products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

      updateRecipesProgress();
    }

    function loadRecipe() {
      const cocktailId = document.getElementById('recipe-cocktail').value;
      if (!cocktailId) {
        document.getElementById('recipe-editor').classList.add('hidden');
        return;
      }

      const cocktail = cocktails.find(c => c.id === cocktailId);
      document.getElementById('recipe-name').textContent = cocktail.name;
      document.getElementById('recipe-price').textContent = cocktail.price + '‚Ç¨';
      document.getElementById('recipe-editor').classList.remove('hidden');

      if (!recipes[cocktailId]) recipes[cocktailId] = [];
      renderRecipeIngredients(cocktailId);
    }

    function renderRecipeIngredients(cocktailId) {
      const container = document.getElementById('recipe-ingredients');
      const ingredients = recipes[cocktailId] || [];

      container.innerHTML = ingredients.map((ing, idx) => {
        const product = products.find(p => p.id === ing.product_id);
        return `
          <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
            <span class="flex-1">${product?.name || 'Produit inconnu'}</span>
            <span class="text-white/50">${ing.quantity_cl}cl</span>
            <button onclick="removeIngredient('${cocktailId}', ${idx})" class="text-white/30 hover:text-red-400">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        `;
      }).join('');

      calculateRecipeCost(cocktailId);
    }

    function addIngredient() {
      const cocktailId = document.getElementById('recipe-cocktail').value;
      const productId = document.getElementById('ingredient-product').value;
      const qty = parseFloat(document.getElementById('ingredient-qty').value) || 0;
      if (!productId || !qty) return;

      if (!recipes[cocktailId]) recipes[cocktailId] = [];
      recipes[cocktailId].push({ product_id: productId, quantity_cl: qty });

      document.getElementById('ingredient-product').value = '';
      document.getElementById('ingredient-qty').value = '';
      renderRecipeIngredients(cocktailId);
    }

    function removeIngredient(cocktailId, idx) {
      recipes[cocktailId].splice(idx, 1);
      renderRecipeIngredients(cocktailId);
    }

    function calculateRecipeCost(cocktailId) {
      const ingredients = recipes[cocktailId] || [];
      const cocktail = cocktails.find(c => c.id === cocktailId);
      let cost = 0;

      for (const ing of ingredients) {
        const product = products.find(p => p.id === ing.product_id);
        if (product && product.purchase_price && product.volume_cl) {
          const pricePerCl = product.purchase_price / product.volume_cl;
          cost += pricePerCl * ing.quantity_cl;
        }
      }

      document.getElementById('recipe-cost').textContent = cost.toFixed(2) + '‚Ç¨';

      const price = cocktail?.price || 0;
      const margin = price > 0 ? ((price - cost) / price * 100) : 0;
      document.getElementById('recipe-margin-value').textContent = margin.toFixed(0) + '%';
      document.getElementById('recipe-margin').textContent = 'Marge: ' + margin.toFixed(0) + '%';
      document.getElementById('recipe-margin').className = 'tag ' + (margin >= 60 ? 'tag-green' : margin >= 40 ? 'tag-orange' : 'tag-red');
    }

    async function saveRecipe() {
      const cocktailId = document.getElementById('recipe-cocktail').value;
      const ingredients = recipes[cocktailId] || [];

      // Delete existing
      await supabase.from('stock_recipes').delete().eq('cocktail_id', cocktailId);

      // Insert new
      for (const ing of ingredients) {
        await supabase.from('stock_recipes').insert({
          user_id: currentUser.id,
          cocktail_id: cocktailId,
          product_id: ing.product_id,
          quantity_cl: ing.quantity_cl
        });
      }

      alert('Fiche technique enregistree!');
      updateRecipesProgress();
    }

    function updateRecipesProgress() {
      const total = cocktails.length;
      const done = Object.keys(recipes).filter(k => recipes[k].length > 0).length;
      document.getElementById('recipes-progress').textContent = done + ' / ' + total;
      document.getElementById('recipes-progress-bar').style.width = (total > 0 ? done / total * 100 : 0) + '%';
      document.getElementById('recipes-continue-btn').disabled = done < total;
    }

    // ==================== STEP 4: Inventory ====================
    function initInventoryStep() {
      renderInventory();
    }

    async function handleInventoryUpload(e) {
      // Similar to products upload but for counting
      alert('Fonctionnalite en cours de dev. Saisis ton inventaire manuellement.');
      e.target.value = '';
    }

    function renderInventory() {
      const container = document.getElementById('inventory-list');
      container.innerHTML = products.map(p => `
        <div class="item-card">
          <div class="item-info flex-1">
            <div class="item-name">${p.name}</div>
            <div class="item-meta">${p.volume_cl}cl</div>
          </div>
          <div class="flex items-center gap-2">
            <input type="number" step="0.1" class="input" style="width: 80px; text-align: center;"
              value="${inventory[p.id] || 0}" onchange="updateInventory('${p.id}', this.value)" placeholder="0">
            <span class="text-white/40 text-sm">bout.</span>
          </div>
        </div>
      `).join('');
    }

    function updateInventory(productId, value) {
      inventory[productId] = parseFloat(value) || 0;
    }

    // ==================== STEP 5: Thresholds ====================
    function saveThresholds() {
      thresholds.margin = parseInt(document.getElementById('threshold-margin').value) || 70;
      thresholds.stock = parseInt(document.getElementById('threshold-stock').value) || 2;
      thresholds.variance = parseInt(document.getElementById('threshold-variance').value) || 10;
    }

    // ==================== STEP 6: Suppliers ====================
    async function addSupplier() {
      const name = document.getElementById('supplier-name').value.trim();
      const contact = document.getElementById('supplier-contact').value.trim();
      if (!name) return;

      const supplierData = { user_id: currentUser.id, name, contact };
      const { data, error } = await supabase.from('stock_suppliers').insert(supplierData).select().single();
      if (!error && data) {
        suppliers.push(data);
        renderSuppliers();
      }

      document.getElementById('supplier-name').value = '';
      document.getElementById('supplier-contact').value = '';
    }

    function renderSuppliers() {
      const container = document.getElementById('suppliers-list');
      container.innerHTML = suppliers.map(s => `
        <div class="item-card">
          <div class="item-icon" style="background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(59,130,246,0.1));">üì¶</div>
          <div class="item-info">
            <div class="item-name">${s.name}</div>
            <div class="item-meta">${s.contact || 'Pas de contact'}</div>
          </div>
          <button onclick="removeSupplier('${s.id}')" class="text-white/30 hover:text-red-400 p-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      `).join('');
    }

    async function removeSupplier(id) {
      await supabase.from('stock_suppliers').delete().eq('id', id);
      suppliers = suppliers.filter(s => s.id !== id);
      renderSuppliers();
    }

    // ==================== STEP 7: Payment ====================
    function updatePaymentSummary() {
      document.getElementById('summary-cocktails').textContent = cocktails.length;
      document.getElementById('summary-products').textContent = products.length;
      document.getElementById('summary-suppliers').textContent = suppliers.length;
    }

    async function initStripePayment() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const res = await fetch(SUPABASE_URL + '/functions/v1/create-setup-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token
          },
          body: JSON.stringify({ module_name: 'stock' })
        });

        const { clientSecret, hasAccess } = await res.json();

        if (hasAccess) {
          goToStep(8);
          return;
        }

        stripe = Stripe(STRIPE_KEY);
        elements = stripe.elements({
          clientSecret,
          appearance: {
            theme: 'night',
            variables: {
              colorPrimary: '#FF6B35',
              colorBackground: '#141414',
              colorText: '#ffffff',
              colorDanger: '#f87171',
              borderRadius: '12px'
            }
          }
        });

        paymentElement = elements.create('payment', { layout: 'tabs' });
        paymentElement.mount('#payment-element');

        document.getElementById('payment-loading').style.display = 'none';
        document.getElementById('payment-form').style.display = 'block';

      } catch (err) {
        console.error('Stripe init error:', err);
        document.getElementById('payment-loading').innerHTML = '<p class="text-red-400">Erreur de chargement</p><button onclick="initStripePayment()" class="btn-secondary mt-4">Reessayer</button>';
      }
    }

    async function confirmPayment() {
      const btn = document.getElementById('btn-pay');
      const errorEl = document.getElementById('payment-error');
      btn.disabled = true;
      btn.textContent = 'Traitement...';
      errorEl.style.display = 'none';

      try {
        const { error } = await stripe.confirmSetup({
          elements,
          confirmParams: {
            return_url: window.location.origin + '/stock/setup/?payment=success'
          }
        });

        if (error) {
          errorEl.textContent = error.message;
          errorEl.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Demarrer l\'essai gratuit';
        }
      } catch (err) {
        errorEl.textContent = 'Une erreur est survenue';
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Demarrer l\'essai gratuit';
      }
    }

    // ==================== STEP 8: Telegram ====================
    async function connectTelegram() {
      const btn = document.getElementById('btn-telegram');
      btn.disabled = true;
      btn.innerHTML = 'Connexion...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        const res = await fetch(SUPABASE_URL + '/functions/v1/generate-telegram-link', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token
          }
        });

        const { token } = await res.json();
        const telegramLink = 'https://t.me/IArmyBOT?start=' + token;

        document.getElementById('telegram-initial').style.display = 'none';
        document.getElementById('telegram-connecting').style.display = 'block';
        document.getElementById('telegram-link').href = telegramLink;

        window.open(telegramLink, '_blank');
        startConnectionCheck();
      } catch (err) {
        alert('Erreur: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.28-.37.78-.57 3.05-1.33 5.08-2.21 6.1-2.63 2.91-1.21 3.52-1.42 3.91-1.43.09 0 .28.02.41.12.1.09.13.21.15.34-.01.05.01.18 0 .28z"/></svg> Connecter Telegram';
      }
    }

    function startConnectionCheck() {
      connectionCheckInterval = setInterval(async () => {
        const { data } = await supabase
          .from('telegram_links')
          .select('telegram_user_id')
          .eq('user_id', currentUser.id)
          .maybeSingle();

        if (data?.telegram_user_id) {
          clearInterval(connectionCheckInterval);
          document.getElementById('telegram-connecting').style.display = 'none';
          document.getElementById('telegram-connected').style.display = 'block';
        }
      }, 3000);
    }

    function goToStock() {
      window.location.href = '/stock/';
    }

    // Check payment return
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('payment') === 'success') {
      window.history.replaceState({}, '', '/stock/setup/');
      setTimeout(async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
          currentUser = session.user;
          goToStep(8);
        }
      }, 1000);
    } else {
      init();
    }
  </script>
</body>
</html>
