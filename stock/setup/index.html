<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock - Configuration | iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23FF6B35'/%3E%3Ctext x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'%3Ei%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { background: #0a0a0a; color: white; min-height: 100vh; overflow-x: hidden; }

    .bg-gradient-animate { background: linear-gradient(135deg, #0a0a0a 0%, #0f0a0d 25%, #0a0f0f 50%, #0d0f0a 75%, #0a0a0a 100%); background-size: 400% 400%; animation: gradientShift 20s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.25; animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 0; }
    .orb-1 { width: 500px; height: 500px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); top: -250px; right: -150px; }
    .orb-2 { width: 400px; height: 400px; background: linear-gradient(135deg, #6B35FF, #8B5EFF); bottom: -200px; left: -150px; animation-delay: -7s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }

    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(24px); border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.04); }
    .glass-card { background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); transition: all 0.4s ease; }
    .glass-card:hover { background: rgba(255, 255, 255, 0.06); border-color: rgba(255, 255, 255, 0.15); }

    .logo-i { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; transition: all 0.4s; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); }
    .logo-i:hover { transform: scale(1.15) rotate(-8deg); box-shadow: 0 0 40px rgba(255,107,53,0.6); }

    .sidebar { background: rgba(255, 255, 255, 0.01); backdrop-filter: blur(20px); width: 280px; min-height: calc(100vh - 70px); padding: 24px; position: fixed; left: 0; top: 70px; z-index: 40; }
    .step-item { display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; margin-bottom: 8px; transition: all 0.3s ease; cursor: pointer; }
    .step-item:hover:not(.upcoming):not(.active) { background: rgba(255, 255, 255, 0.03); }
    .step-item.active { background: rgba(255, 107, 53, 0.08); cursor: default; }
    .step-item.completed { opacity: 0.6; cursor: pointer; }
    .step-item.completed:hover { opacity: 0.8; background: rgba(255, 255, 255, 0.03); }
    .step-item.upcoming { cursor: not-allowed; opacity: 0.3; pointer-events: none; }
    .step-number { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.08); }
    .step-item.active .step-number { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-color: transparent; box-shadow: 0 0 20px rgba(255, 107, 53, 0.3); }
    .step-item.completed .step-number { background: linear-gradient(135deg, #22c55e, #4ade80); border-color: transparent; }
    .step-label { font-size: 14px; font-weight: 500; color: rgba(255, 255, 255, 0.5); }
    .step-item.active .step-label { color: white; }

    .main-content { margin-left: 280px; padding: 40px; max-width: 700px; position: relative; z-index: 10; }
    .step-content { display: none; animation: fadeIn 0.4s ease; }
    .step-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .upload-zone { border: 2px dashed rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 48px 40px; text-align: center; transition: all 0.4s ease; cursor: pointer; background: rgba(255, 255, 255, 0.01); }
    .upload-zone:hover, .upload-zone.dragover { border-color: rgba(255, 107, 53, 0.4); background: rgba(255, 107, 53, 0.03); }

    .btn-glow { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); width: 100%; font-size: 15px; }
    .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4); }
    .btn-glow:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .btn-secondary { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 14px; padding: 14px 28px; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%; }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.08); }

    .btn-telegram { background: linear-gradient(135deg, #0088cc, #00aaff); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease; width: 100%; font-size: 15px; }
    .btn-telegram:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 136, 204, 0.5); }

    .close-btn { position: fixed; top: 24px; right: 24px; width: 44px; height: 44px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; z-index: 100; transition: all 0.3s ease; }
    .close-btn:hover { background: rgba(255, 255, 255, 0.08); transform: rotate(90deg); }

    .check-icon { width: 60px; height: 60px; background: linear-gradient(135deg, #22c55e, #4ade80); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; animation: popIn 0.5s ease; }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

    .cocktail-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 8px; }
    .cocktail-item .emoji { font-size: 24px; }
    .cocktail-item .name { flex: 1; font-weight: 500; }
    .cocktail-item .price { color: #4ade80; font-weight: 600; }

    .loading-spinner { width: 48px; height: 48px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #FF6B35; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .price-box { background: linear-gradient(135deg, rgba(255,107,53,0.15), rgba(255,107,53,0.05)); border: 1px solid rgba(255,107,53,0.25); border-radius: 20px; padding: 24px; text-align: center; margin: 24px 0; }
    .price-box .amount { font-size: 42px; font-weight: 800; color: #FF8B5E; }
    .price-box .period { color: rgba(255,255,255,0.5); font-size: 14px; }

    .feature-list { margin: 24px 0; }
    .feature-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .feature-item:last-child { border-bottom: none; }
    .feature-check { width: 24px; height: 24px; background: rgba(34,197,94,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #4ade80; font-size: 12px; }

    .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-20px); padding: 14px 28px; background: rgba(34, 197, 94, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; color: white; font-size: 14px; font-weight: 500; opacity: 0; z-index: 10002; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .toast.active { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { background: rgba(239, 68, 68, 0.85); }

    /* Mobile progress */
    .mobile-progress { display: none; position: fixed; top: 60px; left: 0; right: 0; background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(20px); padding: 12px 20px; z-index: 45; border-bottom: 1px solid rgba(255, 255, 255, 0.06); }
    .mobile-progress-steps { display: flex; align-items: center; justify-content: center; gap: 0; }
    .mobile-step { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; background: rgba(255, 255, 255, 0.06); border: 2px solid rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.3); transition: all 0.3s ease; }
    .mobile-step.active { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-color: transparent; color: white; box-shadow: 0 0 15px rgba(255, 107, 53, 0.4); }
    .mobile-step.completed { background: linear-gradient(135deg, #22c55e, #4ade80); border-color: transparent; color: white; }
    .mobile-step-line { width: 40px; height: 2px; background: rgba(255, 255, 255, 0.1); }
    .mobile-step-line.completed { background: linear-gradient(90deg, #22c55e, #4ade80); }

    /* Mobile styles */
    @media (max-width: 768px) {
      .mobile-progress { display: block; }
      .sidebar { display: none; }
      .main-content { margin-left: 0; padding: 20px; padding-top: 100px; max-width: 100%; }
      .close-btn { top: 16px; right: 16px; width: 40px; height: 40px; }
      h1 { font-size: 24px !important; }
      .glass-card { padding: 20px !important; border-radius: 20px; }
      .upload-zone { padding: 32px 20px; }
      .orb-1 { width: 300px; height: 300px; top: -150px; right: -100px; }
      .orb-2 { width: 250px; height: 250px; bottom: -125px; left: -100px; }
    }
  </style>
</head>
<body class="bg-gradient-animate">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <div class="toast" id="toast"></div>

  <nav class="glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-3xl mx-auto px-5 py-4 flex items-center justify-between">
      <a href="https://iarmy.fr" class="flex items-center gap-3">
        <div class="logo-i">i</div>
        <span class="font-semibold text-lg">iArmy</span>
      </a>
      <div id="auth-buttons"></div>
    </div>
  </nav>

  <!-- Mobile Progress -->
  <div id="mobile-progress" class="mobile-progress">
    <div class="mobile-progress-steps">
      <div class="mobile-step active" data-step="1">1</div>
      <div class="mobile-step-line" id="mobile-line-1"></div>
      <div class="mobile-step" data-step="2">2</div>
    </div>
  </div>

  <div class="flex min-h-screen" style="padding-top: 70px;">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="mb-6">
        <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px;">Module</div>
        <div style="font-size: 18px; font-weight: 700; color: white; margin-top: 4px;">Stock</div>
      </div>
      <div id="steps-nav">
        <div class="step-item active" id="step-nav-1" onclick="goToStep(1)">
          <div class="step-number">1</div>
          <span class="step-label">Ta carte</span>
        </div>
        <div class="step-item upcoming" id="step-nav-2" onclick="goToStep(2)">
          <div class="step-number">2</div>
          <span class="step-label">Telegram</span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <a href="/" class="close-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </a>

      <!-- STEP 1: Upload Carte -->
      <div class="step-content active" id="step-1">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 1/2</span></div>
        <h1 class="text-3xl font-bold mb-3">Ta carte des cocktails</h1>
        <p class="text-white/40 mb-8">Envoie une photo de ta carte, l'IA extrait tout automatiquement</p>

        <div class="glass-card p-8">
          <!-- Upload Zone -->
          <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
            <input type="file" id="file-input" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(event)">
            <div style="font-size: 48px; margin-bottom: 16px;">üì∏</div>
            <div style="font-weight: 600; margin-bottom: 8px;">Glisse ta carte ici</div>
            <div style="color: rgba(255,255,255,0.4); font-size: 14px;">ou clique pour choisir un fichier</div>
          </div>

          <!-- File Preview -->
          <div id="upload-preview" style="display: none; margin-top: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 12px;">
              <div style="width: 48px; height: 48px; background: rgba(255,107,53,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">üìÑ</div>
              <div style="flex: 1;">
                <div style="font-weight: 500;" id="file-name">carte.jpg</div>
                <div style="font-size: 13px; color: rgba(255,255,255,0.4);" id="file-size">2.4 MB</div>
              </div>
              <button onclick="removeFile()" style="background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; padding: 8px;">‚úï</button>
            </div>
          </div>

          <!-- Extraction Loading -->
          <div id="extracting" style="display: none; text-align: center; padding: 40px 0;">
            <div class="loading-spinner"></div>
            <div style="font-weight: 600; margin-bottom: 8px;">Analyse en cours...</div>
            <div style="color: rgba(255,255,255,0.4); font-size: 14px;">Notre IA lit ta carte</div>
          </div>

          <!-- Extraction Results -->
          <div id="extraction-results" style="display: none; margin-top: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="font-weight: 600;">Cocktails trouv√©s</div>
              <div style="color: #4ade80; font-size: 14px;" id="cocktails-count">12 cocktails</div>
            </div>
            <div id="cocktails-list" style="max-height: 280px; overflow-y: auto;"></div>

            <button onclick="validateStep1()" class="btn-glow" style="margin-top: 24px;">
              C'est bon, continuer ‚Üí
            </button>
            <button onclick="resetUpload()" class="btn-secondary" style="margin-top: 12px;">
              R√©essayer avec une autre photo
            </button>
          </div>
        </div>

        <div style="text-align: center; margin-top: 24px;">
          <button onclick="skipStep1()" style="background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; font-size: 14px;">
            Passer cette √©tape ‚Üí
          </button>
        </div>
      </div>

      <!-- STEP 2: Telegram + Trial -->
      <div class="step-content" id="step-2">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 2/2</span></div>
        <h1 class="text-3xl font-bold mb-3">Connecte Telegram</h1>
        <p class="text-white/40 mb-8">Pour recevoir tes alertes stock et envoyer tes tickets Z</p>

        <div class="glass-card p-8">
          <div class="price-box">
            <div style="font-size: 14px; color: rgba(255,255,255,0.5); margin-bottom: 8px;">7 jours d'essai gratuit puis</div>
            <div class="amount">29‚Ç¨</div>
            <div class="period">/mois</div>
          </div>

          <div class="feature-list">
            <div class="feature-item">
              <div class="feature-check">‚úì</div>
              <div>Scan tickets Z automatique</div>
            </div>
            <div class="feature-item">
              <div class="feature-check">‚úì</div>
              <div>Inventaire photo avec IA</div>
            </div>
            <div class="feature-item">
              <div class="feature-check">‚úì</div>
              <div>Alertes stock & marges</div>
            </div>
            <div class="feature-item">
              <div class="feature-check">‚úì</div>
              <div>Fiches techniques cocktails</div>
            </div>
          </div>

          <!-- Telegram Connect -->
          <div id="telegram-connect">
            <button onclick="connectTelegram()" class="btn-telegram" id="btn-telegram">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.28-.37.78-.57 3.05-1.33 5.08-2.21 6.1-2.63 2.91-1.21 3.52-1.42 3.91-1.43.09 0 .28.02.41.12.1.09.13.21.15.34-.01.05.01.18 0 .28z"/></svg>
              Connecter Telegram
            </button>
          </div>

          <!-- Telegram Waiting -->
          <div id="telegram-waiting" style="display: none; text-align: center; padding: 24px;">
            <div class="loading-spinner"></div>
            <div style="font-weight: 600; margin-bottom: 8px;">En attente de connexion...</div>
            <div style="color: rgba(255,255,255,0.4); font-size: 14px; margin-bottom: 16px;">Clique sur "D√©marrer" dans Telegram</div>
            <a href="#" id="telegram-link" target="_blank" style="color: #FF8B5E; font-size: 14px;">Ouvrir Telegram ‚Üí</a>
          </div>

          <!-- Telegram Connected - Tester -->
          <div id="telegram-connected-tester" style="display: none; text-align: center;">
            <div class="check-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <div style="font-weight: 600; font-size: 18px; margin-bottom: 8px;">Telegram connect√© !</div>
            <div style="color: #c084fc; font-size: 14px; margin-bottom: 24px;">üß™ Mode testeur activ√©</div>
            <button onclick="goToStock()" class="btn-glow">
              Acc√©der au module Stock ‚Üí
            </button>
          </div>

          <!-- Telegram Connected - Payment needed -->
          <div id="telegram-connected-pay" style="display: none; text-align: center;">
            <div class="check-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <div style="font-weight: 600; font-size: 18px; margin-bottom: 8px;">Telegram connect√© !</div>
            <div style="color: rgba(255,255,255,0.5); font-size: 14px; margin-bottom: 24px;">Plus qu'une √©tape pour activer ton module</div>
            <button onclick="startCheckout()" class="btn-glow" id="btn-checkout">
              D√©marrer l'essai gratuit ‚Üí
            </button>
            <p style="color: rgba(255,255,255,0.4); font-size: 12px; margin-top: 12px;">7 jours gratuits, puis 29‚Ç¨/mois</p>
          </div>

          <p style="text-align: center; color: rgba(255,255,255,0.3); font-size: 12px; margin-top: 20px;">
            Sans engagement ¬∑ Annulable √† tout moment
          </p>
        </div>
      </div>
    </main>
  </div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_8mpFx9ubrV29KfKtgAb3eg_dyazidfT';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentStep = 1;
    let extractedCocktails = [];
    let uploadedFile = null;
    let isTester = false;
    let connectionCheckInterval = null;

    // Toast
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast' + (isError ? ' error' : '');
      toast.classList.add('active');
      setTimeout(() => toast.classList.remove('active'), 4000);
    }

    // Init
    async function init() {
      // Check si Telegram Mini App
      const tg = window.Telegram?.WebApp;
      if (tg && (tg.initData || tg.platform !== 'unknown')) {
        document.querySelector('main').innerHTML = `
          <div class="glass-card" style="padding: 48px; text-align: center; margin-top: 40px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üåê</div>
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 12px;">Configuration sur le site</h2>
            <p style="color: rgba(255,255,255,0.5); margin-bottom: 24px;">La configuration doit √™tre faite sur le site web.</p>
            <a href="https://app.iarmy.fr/stock/setup/" class="btn-glow" style="display: inline-block; width: auto;">Ouvrir le site</a>
          </div>
        `;
        return;
      }

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'https://iarmy.fr?redirect=/stock/setup/';
        return;
      }
      currentUser = session.user;

      // Update auth buttons
      const userName = currentUser.user_metadata?.full_name || currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'User';
      const userAvatar = currentUser.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=FF6B35&color=fff`;
      document.getElementById('auth-buttons').innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <a href="/compte/" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; text-decoration: none; color: white;">
            <img src="${userAvatar}" style="width: 28px; height: 28px; border-radius: 50%; border: 2px solid rgba(255,107,53,0.3);">
            <span style="font-weight: 500; font-size: 14px;">${userName.split(' ')[0]}</span>
          </a>
        </div>
      `;

      // Check subscription
      const { data: sub } = await supabase
        .from('subscriptions')
        .select('status, is_tester')
        .eq('user_id', currentUser.id)
        .eq('module_name', 'stock')
        .maybeSingle();

      isTester = sub?.is_tester === true;

      // Si d√©j√† abonn√© ‚Üí dashboard
      if (sub?.status === 'active' || sub?.status === 'trialing' || isTester) {
        window.location.href = '/stock/';
        return;
      }

      // Setup drag & drop
      setupDragDrop();
    }

    function setupDragDrop() {
      const zone = document.getElementById('upload-zone');

      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });

      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });

      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          handleFile(e.dataTransfer.files[0]);
        }
      });
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) handleFile(file);
    }

    function handleFile(file) {
      if (!file.type.match(/image.*/) && file.type !== 'application/pdf') {
        showToast('Format non support√©. Utilise une image ou un PDF.', true);
        return;
      }

      uploadedFile = file;

      // Show preview
      document.getElementById('upload-zone').style.display = 'none';
      document.getElementById('upload-preview').style.display = 'block';
      document.getElementById('file-name').textContent = file.name;
      document.getElementById('file-size').textContent = (file.size / 1024 / 1024).toFixed(1) + ' MB';

      // Start extraction
      extractCocktails(file);
    }

    function removeFile() {
      uploadedFile = null;
      document.getElementById('upload-zone').style.display = 'block';
      document.getElementById('upload-preview').style.display = 'none';
      document.getElementById('extraction-results').style.display = 'none';
      document.getElementById('file-input').value = '';
    }

    function resetUpload() {
      removeFile();
      document.getElementById('extracting').style.display = 'none';
    }

    async function extractCocktails(file) {
      document.getElementById('extracting').style.display = 'block';
      document.getElementById('extraction-results').style.display = 'none';

      try {
        // Convert to base64
        const base64 = await fileToBase64(file);

        // Call Edge Function for extraction
        const { data: { session } } = await supabase.auth.getSession();
        const response = await fetch(SUPABASE_URL + '/functions/v1/extract-menu', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token
          },
          body: JSON.stringify({
            image: base64,
            type: 'cocktails'
          })
        });

        const result = await response.json();

        if (result.cocktails && result.cocktails.length > 0) {
          extractedCocktails = result.cocktails;
          showExtractionResults(result.cocktails);
        } else {
          // Fallback: demo data
          extractedCocktails = [
            { name: 'Mojito', price: 12 },
            { name: 'Margarita', price: 13 },
            { name: 'Cosmopolitan', price: 14 },
            { name: 'Old Fashioned', price: 15 },
            { name: 'Pi√±a Colada', price: 13 }
          ];
          showExtractionResults(extractedCocktails);
        }
      } catch (err) {
        console.error('Extraction error:', err);
        // Fallback
        extractedCocktails = [
          { name: 'Mojito', price: 12 },
          { name: 'Margarita', price: 13 },
          { name: 'Cosmopolitan', price: 14 }
        ];
        showExtractionResults(extractedCocktails);
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function showExtractionResults(cocktails) {
      document.getElementById('extracting').style.display = 'none';
      document.getElementById('extraction-results').style.display = 'block';
      document.getElementById('cocktails-count').textContent = cocktails.length + ' cocktail' + (cocktails.length > 1 ? 's' : '');

      const emojis = ['üç∏', 'üçπ', 'ü•É', 'üç∑', 'ü•Ç', 'üßâ', 'üçæ'];

      document.getElementById('cocktails-list').innerHTML = cocktails.map((c, i) => `
        <div class="cocktail-item">
          <div class="emoji">${emojis[i % emojis.length]}</div>
          <div class="name">${c.name}</div>
          <div class="price">${c.price ? c.price + '‚Ç¨' : '-'}</div>
        </div>
      `).join('');
    }

    function skipStep1() {
      goToStep(2);
    }

    async function validateStep1() {
      // Save cocktails
      if (extractedCocktails.length > 0) {
        await saveCocktails();
      }
      goToStep(2);
    }

    function goToStep(step) {
      if (step < 1 || step > 2) return;
      if (step > currentStep + 1) return; // Can't skip ahead

      currentStep = step;

      // Hide all steps
      document.querySelectorAll('.step-content').forEach(el => {
        el.classList.remove('active');
      });

      // Show current step
      document.getElementById('step-' + step).classList.add('active');

      // Update sidebar
      document.querySelectorAll('.step-item').forEach((el, i) => {
        el.classList.remove('active', 'completed', 'upcoming');
        if (i + 1 < step) {
          el.classList.add('completed');
        } else if (i + 1 === step) {
          el.classList.add('active');
        } else {
          el.classList.add('upcoming');
        }
      });

      // Update mobile progress
      document.querySelectorAll('.mobile-step').forEach((el, i) => {
        el.classList.remove('active', 'completed');
        if (i + 1 < step) {
          el.classList.add('completed');
        } else if (i + 1 === step) {
          el.classList.add('active');
        }
      });

      const line1 = document.getElementById('mobile-line-1');
      if (step > 1) {
        line1.classList.add('completed');
      } else {
        line1.classList.remove('completed');
      }
    }

    async function saveCocktails() {
      if (!extractedCocktails.length) return;

      try {
        const cocktailsToInsert = extractedCocktails.map(c => ({
          user_id: currentUser.id,
          name: c.name,
          price: c.price || 0,
          category: 'cocktail'
        }));

        await supabase.from('stock_cocktails').insert(cocktailsToInsert);
        console.log('Cocktails saved');
      } catch (err) {
        console.error('Error saving cocktails:', err);
      }
    }

    async function connectTelegram() {
      const btn = document.getElementById('btn-telegram');
      btn.disabled = true;
      btn.innerHTML = 'Connexion...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        const res = await fetch(SUPABASE_URL + '/functions/v1/generate-telegram-link', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token
          }
        });

        const { token } = await res.json();
        const telegramLink = 'https://t.me/IArmyBOT?start=' + token;

        document.getElementById('telegram-connect').style.display = 'none';
        document.getElementById('telegram-waiting').style.display = 'block';
        document.getElementById('telegram-link').href = telegramLink;

        window.open(telegramLink, '_blank');
        startConnectionCheck();
      } catch (err) {
        showToast('Erreur: ' + err.message, true);
        btn.disabled = false;
        btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.28-.37.78-.57 3.05-1.33 5.08-2.21 6.1-2.63 2.91-1.21 3.52-1.42 3.91-1.43.09 0 .28.02.41.12.1.09.13.21.15.34-.01.05.01.18 0 .28z"/></svg>Connecter Telegram';
      }
    }

    function startConnectionCheck() {
      connectionCheckInterval = setInterval(async () => {
        const { data } = await supabase
          .from('telegram_links')
          .select('telegram_user_id')
          .eq('user_id', currentUser.id)
          .maybeSingle();

        if (data?.telegram_user_id) {
          clearInterval(connectionCheckInterval);
          document.getElementById('telegram-waiting').style.display = 'none';

          if (isTester) {
            // Testeur ‚Üí acc√®s direct
            document.getElementById('telegram-connected-tester').style.display = 'block';
          } else {
            // Pas testeur ‚Üí paiement
            document.getElementById('telegram-connected-pay').style.display = 'block';
          }
        }
      }, 2000);
    }

    async function startCheckout() {
      const btn = document.getElementById('btn-checkout');
      btn.disabled = true;
      btn.textContent = 'Redirection...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        const response = await fetch(SUPABASE_URL + '/functions/v1/stripe-checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token
          },
          body: JSON.stringify({
            module: 'stock',
            successUrl: window.location.origin + '/stock/?success=1',
            cancelUrl: window.location.origin + '/stock/setup/?canceled=1'
          })
        });

        const { url, error } = await response.json();

        if (error) throw new Error(error);
        if (url) window.location.href = url;
      } catch (err) {
        showToast('Erreur: ' + err.message, true);
        btn.disabled = false;
        btn.textContent = 'D√©marrer l\'essai gratuit ‚Üí';
      }
    }

    function goToStock() {
      window.location.href = '/stock/';
    }

    init();
  </script>
</body>
</html>
