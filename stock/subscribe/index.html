<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abonnement | iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23FF6B35'/%3E%3Ctext x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'%3Ei%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a0a; color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }

    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(24px); border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.04); }
    .logo-i { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; transition: all 0.4s; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); }
    .logo-i:hover { transform: scale(1.15) rotate(-8deg); box-shadow: 0 0 40px rgba(255,107,53,0.6); }

    .orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.25; animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 0; }
    .orb-1 { width: 400px; height: 400px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); top: -200px; right: -100px; }
    .orb-2 { width: 300px; height: 300px; background: linear-gradient(135deg, #6B35FF, #8B5EFF); bottom: -150px; left: -100px; animation-delay: -7s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }

    .container { max-width: 420px; width: 100%; position: relative; z-index: 10; }

    .card { background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 28px; padding: 40px 32px; text-align: center; }

    .icon { font-size: 56px; margin-bottom: 20px; }
    h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    .subtitle { color: rgba(255,255,255,0.5); font-size: 15px; margin-bottom: 32px; }

    .price-box { background: linear-gradient(135deg, rgba(255,107,53,0.15), rgba(255,107,53,0.05)); border: 1px solid rgba(255,107,53,0.25); border-radius: 20px; padding: 24px; margin-bottom: 28px; }
    .price { font-size: 48px; font-weight: 800; color: #FF8B5E; }
    .period { color: rgba(255,255,255,0.5); font-size: 16px; }

    .features { text-align: left; margin-bottom: 32px; }
    .feature { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .feature:last-child { border-bottom: none; }
    .feature-check { width: 24px; height: 24px; background: rgba(34,197,94,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #4ade80; font-size: 12px; flex-shrink: 0; }
    .feature-text { font-size: 15px; color: rgba(255,255,255,0.8); }

    .btn { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border: none; border-radius: 14px; padding: 18px 32px; color: white; font-weight: 600; font-size: 16px; cursor: pointer; width: 100%; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 107, 53, 0.4); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .payment-methods { display: flex; align-items: center; justify-content: center; gap: 16px; margin-top: 20px; color: rgba(255,255,255,0.4); font-size: 13px; }
    .payment-methods span { display: flex; align-items: center; gap: 6px; }

    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); padding: 14px 28px; background: rgba(239, 68, 68, 0.9); backdrop-filter: blur(20px); border-radius: 14px; color: white; font-size: 14px; font-weight: 500; opacity: 0; z-index: 1000; transition: all 0.3s ease; }
    .toast.active { transform: translateX(-50%) translateY(0); opacity: 1; }

    .back-link { display: block; margin-top: 24px; color: rgba(255,255,255,0.4); font-size: 14px; text-decoration: none; }
    .back-link:hover { color: rgba(255,255,255,0.6); }

    @media (max-width: 480px) {
      .card { padding: 32px 24px; border-radius: 24px; }
      h1 { font-size: 24px; }
      .price { font-size: 42px; }
    }
  </style>
</head>
<body>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="toast" id="toast"></div>

  <!-- Header -->
  <nav class="glass" style="position: fixed; top: 0; left: 0; right: 0; z-index: 50;">
    <div style="max-width: 600px; margin: 0 auto; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;">
      <a href="https://iarmy.fr" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: white;">
        <div class="logo-i">i</div>
        <span style="font-weight: 600;">iArmy</span>
      </a>
      <div id="auth-buttons"></div>
    </div>
  </nav>

  <div class="container" style="padding-top: 80px;">
    <div class="card">
      <div class="icon" id="module-icon">üç∏</div>
      <h1 id="module-name">Stock</h1>
      <p class="subtitle">Ta config est pr√™te ! Active ton abonnement pour continuer.</p>

      <div class="price-box">
        <div class="price" id="module-price">29‚Ç¨</div>
        <div class="period">/mois</div>
      </div>

      <div class="features" id="module-features"></div>

      <button class="btn" id="btn-subscribe" onclick="startCheckout()">
        Activer mon abonnement ‚Üí
      </button>

      <div class="payment-methods">
        <span>Apple Pay</span>
        <span>‚Ä¢</span>
        <span>Google Pay</span>
        <span>‚Ä¢</span>
        <span>CB</span>
      </div>

      <a href="#" class="back-link" id="back-link">‚Üê Retour</a>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cWZucGRjbmlmYXVod2dldGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY2MzQ4NDYsImV4cCI6MjA1MjIxMDg0Nn0.YjrRXPHBmag47WyLWOKPr7TIc0z3oN_AzNL5CSx3az8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Config par module
    const MODULES = {
      stock: {
        name: 'Stock',
        icon: 'üç∏',
        price: '29‚Ç¨',
        features: [
          'Scan tickets Z automatique',
          'Inventaire photo avec IA',
          'Alertes stock & marges',
          'Fiches techniques cocktails'
        ]
      },
      compta: {
        name: 'Compta Express',
        icon: 'üìä',
        price: '29‚Ç¨',
        features: [
          'Saisie vocale & photo',
          'Export Google Sheets auto',
          'Cat√©gorisation intelligente',
          'R√©cap hebdo & mensuel'
        ]
      },
      planning: {
        name: 'Planning',
        icon: 'üìÖ',
        price: '39‚Ç¨',
        features: [
          'Planning √©quipe visuel',
          'Notifications Telegram',
          'Gestion des absences',
          'Export PDF'
        ]
      }
    };

    // D√©tecter le module depuis l'URL (/stock/subscribe/ ‚Üí stock)
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const moduleName = pathParts[0] || 'stock';
    const moduleConfig = MODULES[moduleName] || MODULES.stock;

    // Afficher les infos du module
    document.title = moduleConfig.name + ' - Abonnement | iArmy';
    document.getElementById('module-icon').textContent = moduleConfig.icon;
    document.getElementById('module-name').textContent = moduleConfig.name;
    document.getElementById('module-price').textContent = moduleConfig.price;
    document.getElementById('back-link').href = '/' + moduleName + '/';
    document.getElementById('module-features').innerHTML = moduleConfig.features.map(f => `
      <div class="feature">
        <div class="feature-check">‚úì</div>
        <div class="feature-text">${f}</div>
      </div>
    `).join('');

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('active');
      setTimeout(() => toast.classList.remove('active'), 4000);
    }

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'https://iarmy.fr?redirect=/' + moduleName + '/subscribe/';
        return;
      }

      // Afficher avatar utilisateur
      const user = session.user;
      const userName = user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0] || 'User';
      const userAvatar = user.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=FF6B35&color=fff`;
      document.getElementById('auth-buttons').innerHTML = `
        <a href="/compte/" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; text-decoration: none; color: white;">
          <img src="${userAvatar}" style="width: 28px; height: 28px; border-radius: 50%; border: 2px solid rgba(255,107,53,0.3);">
          <span style="font-weight: 500; font-size: 14px;">${userName.split(' ')[0]}</span>
        </a>
      `;

      // Check if already subscribed
      const { data: sub } = await supabase
        .from('subscriptions')
        .select('status, is_tester')
        .eq('user_id', session.user.id)
        .eq('module_name', moduleName)
        .maybeSingle();

      if (sub?.status === 'active' || sub?.is_tester) {
        // D√©j√† abonn√© ‚Üí dashboard
        window.location.href = '/' + moduleName + '/';
        return;
      }

      // Check if has existing config (ex-testeur)
      let hasConfig = false;

      if (moduleName === 'stock') {
        const { count } = await supabase
          .from('stock_cocktails')
          .select('id', { count: 'exact', head: true })
          .eq('user_id', session.user.id);
        hasConfig = count > 0;
      } else if (moduleName === 'compta') {
        const { data: config } = await supabase
          .from('module_configs')
          .select('id')
          .eq('user_id', session.user.id)
          .eq('module_name', 'compta')
          .maybeSingle();
        hasConfig = !!config;
      } else if (moduleName === 'planning') {
        const { data: config } = await supabase
          .from('module_configs')
          .select('id')
          .eq('user_id', session.user.id)
          .eq('module_name', 'planning')
          .maybeSingle();
        hasConfig = !!config;
      }

      if (!hasConfig) {
        // Pas de config ‚Üí doit faire le setup d'abord
        window.location.href = '/' + moduleName + '/setup/';
        return;
      }
    }

    async function startCheckout() {
      const btn = document.getElementById('btn-subscribe');
      btn.disabled = true;
      btn.textContent = 'Redirection...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          window.location.href = 'https://iarmy.fr?redirect=/' + moduleName + '/subscribe/';
          return;
        }

        const response = await fetch(SUPABASE_URL + '/functions/v1/stripe-checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token
          },
          body: JSON.stringify({
            moduleName: moduleName,
            successUrl: window.location.origin + '/' + moduleName + '/?success=1',
            cancelUrl: window.location.origin + '/' + moduleName + '/subscribe/?canceled=1'
          })
        });

        const { url, error } = await response.json();

        if (error) throw new Error(error);
        if (url) window.location.href = url;
      } catch (err) {
        showToast('Erreur: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Activer mon abonnement ‚Üí';
      }
    }

    // Check URL params
    const params = new URLSearchParams(window.location.search);
    if (params.get('canceled') === '1') {
      showToast('Paiement annul√©');
      window.history.replaceState({}, '', window.location.pathname);
    }

    init();
  </script>
</body>
</html>
