<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/config.js"></script>
  <script src="/js/icons.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- header.css removed - admin has its own styling, header.css nav rules conflict -->
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a0a; color: white; min-height: 100vh; }

    /* Layout */
    .app { display: flex; min-height: 100vh; overflow: hidden; position: relative; }

    /* Sidebar */
    .sidebar { width: 260px; background: #0f0f0f; border-right: 1px solid rgba(255,255,255,0.06); display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; position: relative; z-index: 1; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .sidebar-logo { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 18px; }
    .sidebar-logo .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; }
    .sidebar-logo span { color: #FF6B35; }
    .sidebar-logo .logo-i { width: 36px; height: 36px; min-width: 36px; min-height: 36px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .sidebar-logo .logo-i svg { width: 75%; height: 75%; }

    /* Nav */
    .nav { padding: 16px; flex: 1; display: flex; flex-direction: column; overflow-x: hidden; overflow-y: auto; }
    .nav-section { margin-bottom: 28px; overflow: hidden; }
    .nav-title { font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1.5px; padding: 8px 12px; margin-bottom: 4px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 12px; cursor: pointer; transition: all 0.2s; font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 4px; }
    .nav-item:hover { background: rgba(255,255,255,0.04); color: white; }
    .nav-item.active { background: rgba(255,107,53,0.15); color: #FF6B35; }
    .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
    .nav-badge { margin-left: auto; background: rgba(255,107,53,0.2); color: #FF6B35; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .nav-badge.green { background: rgba(34,197,94,0.2); color: #4ade80; }
    .nav-badge.red { background: rgba(239,68,68,0.2); color: #f87171; }
    .nav-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 16px 0; }
    .nav-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.06); }

    /* Main */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 2; background: #0a0a0a; }
    .main-header { padding: 20px 32px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; gap: 20px; background: #0a0a0a; position: relative; z-index: 1; }
    .main-title { font-size: 22px; font-weight: 700; }
    .main-subtitle { font-size: 13px; color: rgba(255,255,255,0.4); margin-top: 2px; }
    .main-actions { display: flex; gap: 12px; }
    .main-content { flex: 1; overflow-y: auto; padding: 32px; position: relative; background: #0a0a0a; }

    /* Buttons */
    .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: linear-gradient(135deg, #FF6B35, #FF8B5E); color: white; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,107,53,0.3); }
    .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; }
    .btn-secondary:hover:not(:disabled) { background: rgba(255,255,255,0.1); }
    .btn-success { background: rgba(34,197,94,0.15); color: #4ade80; }
    .btn-success:hover { background: rgba(34,197,94,0.25); }
    .btn-danger { background: rgba(239,68,68,0.1); color: #f87171; }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }
    .btn-ai { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; }
    .btn-ai:hover { box-shadow: 0 8px 20px rgba(139,92,246,0.3); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-icon { width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; }

    /* Cards */
    .card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 24px; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .card-title { font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.8); }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 20px; position: relative; transition: all 0.2s; }
    .stat-card:hover { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); }
    .stat-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; font-size: 18px; }
    .stat-value { font-size: 32px; font-weight: 700; color: #ffffff !important; opacity: 1 !important; visibility: visible !important; }
    .stat-label { font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 4px; opacity: 1 !important; visibility: visible !important; }
    .stat-change { font-size: 11px; margin-top: 8px; display: flex; align-items: center; gap: 4px; }
    .stat-change.up { color: #4ade80; }
    .stat-change.down { color: #f87171; }
    .stat-card.live { border-color: rgba(34,197,94,0.3); }
    .stat-card.live::after { content: ''; position: absolute; top: 16px; right: 16px; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Quick Actions */
    .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .quick-action { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .quick-action:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .quick-action-icon { font-size: 24px; margin-bottom: 8px; }
    .quick-action-label { font-size: 12px; color: rgba(255,255,255,0.6); }

    /* Grid layouts */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
    @media (max-width: 1200px) { .grid-3 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 800px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .app { flex-direction: column; }
      .main-content { padding: 16px; }
    }

    /* Editor Split */
    .editor-split { display: grid; grid-template-columns: 1fr 380px; gap: 32px; }
    @media (max-width: 1100px) { .editor-split { grid-template-columns: 1fr; } }

    /* Form */
    .form-section { margin-bottom: 28px; }
    .form-section-title { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.6); margin-bottom: 8px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; color: white; font-size: 14px; transition: all 0.2s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: rgba(255,107,53,0.5); background: rgba(255,255,255,0.06); }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-hint { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 6px; }
    .form-input-with-btn { display: flex; gap: 8px; }
    .form-input-with-btn .form-input { flex: 1; }

    /* AI Input */
    .ai-input-wrapper { position: relative; }
    .ai-input-wrapper .form-textarea { padding-right: 110px; }
    .ai-suggest-btn { position: absolute; right: 8px; bottom: 8px; padding: 8px 14px; background: linear-gradient(135deg, #8b5cf6, #a78bfa); border: none; border-radius: 8px; color: white; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .ai-suggest-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .ai-suggest-btn:disabled { opacity: 0.5; }

    /* Color Grid */
    .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
    .color-option { aspect-ratio: 1; border-radius: 10px; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .color-option:hover { transform: scale(1.1); }
    .color-option.selected { border-color: white; box-shadow: 0 0 20px currentColor; }
    .color-option svg { opacity: 0; }
    .color-option.selected svg { opacity: 1; }

    /* Icon Grid */
    .icon-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .icon-option { padding: 14px; background: rgba(255,255,255,0.02); border: 2px solid rgba(255,255,255,0.08); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .icon-option:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.15); }
    .icon-option.selected { border-color: #FF6B35; background: rgba(255,107,53,0.1); }
    .icon-option-preview { height: 40px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
    .icon-option-label { font-size: 11px; color: rgba(255,255,255,0.5); }

    /* Badge Options */
    .badge-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .badge-option { padding: 10px 18px; background: rgba(255,255,255,0.04); border: 2px solid rgba(255,255,255,0.08); border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .badge-option:hover { background: rgba(255,255,255,0.08); }
    .badge-option.selected { border-color: #FF6B35; background: rgba(255,107,53,0.15); color: #FF6B35; }

    /* Preview Panel */
    .preview-panel { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 20px; padding: 24px; position: sticky; top: 32px; }
    .preview-title { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; text-align: center; }
    .preview-card { width: 180px; height: 180px; border-radius: 24px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; margin: 0 auto 24px; position: relative; transition: all 0.3s; border: 1px solid transparent; }
    .preview-badge { position: absolute; top: -8px; right: -8px; padding: 4px 12px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .preview-badge.nouveau { background: linear-gradient(135deg, #22c55e, #4ade80); color: white; }
    .preview-badge.populaire { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
    .preview-badge.promo { background: linear-gradient(135deg, #ef4444, #f87171); color: white; }
    .preview-visibility { position: absolute; top: 10px; left: 10px; padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 600; }
    .preview-visibility.draft { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .preview-visibility.beta { background: rgba(168,85,247,0.2); color: #c084fc; }
    .preview-visibility.public { background: rgba(34,197,94,0.2); color: #4ade80; }
    .preview-icon { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
    .preview-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .preview-desc { font-size: 11px; color: rgba(255,255,255,0.5); }
    .preview-info { background: rgba(255,255,255,0.04); border-radius: 12px; padding: 16px; }
    .preview-info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 13px; }
    .preview-info-row:last-child { border-bottom: none; }
    .preview-info-label { color: rgba(255,255,255,0.4); }
    .preview-info-value { font-weight: 500; }

    /* Mini icon animations */
    .mini-sheet { width: 32px; height: 32px; background: rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden; }
    .mini-sheet-row { display: flex; height: 8px; }
    .mini-sheet-cell { flex: 1; background: rgba(255,255,255,0.1); margin: 1px; border-radius: 1px; }
    .mini-sheet-cell.fill { animation: cellFill 2s ease-in-out infinite; }
    .mini-sheet-cell.fill-1 { animation-delay: 0s; }
    .mini-sheet-cell.fill-2 { animation-delay: 0.3s; }
    .mini-sheet-cell.fill-3 { animation-delay: 0.6s; }
    .mini-sheet-cell.fill-4 { animation-delay: 0.9s; }
    .mini-sheet-cell.fill-5 { animation-delay: 1.2s; }
    .mini-sheet-cell.fill-6 { animation-delay: 1.5s; }
    @keyframes cellFill { 0%, 40% { background: rgba(255,255,255,0.1); } 50%, 90% { background: #4ade80; } 100% { background: rgba(255,255,255,0.1); } }
    .mini-stock { width: 36px; height: 28px; display: flex; align-items: flex-end; justify-content: center; gap: 3px; position: relative; }
    .mini-bottle { position: relative; width: 12px; height: 22px; }
    .mini-bottle-body { position: absolute; bottom: 0; width: 12px; height: 15px; background: rgba(6,182,212,0.15); border: 1.5px solid #06B6D4; border-radius: 2px; overflow: hidden; }
    .mini-bottle-neck { position: absolute; bottom: 14px; left: 3px; width: 6px; height: 5px; background: rgba(6,182,212,0.15); border: 1.5px solid #06B6D4; border-bottom: none; border-radius: 2px 2px 0 0; }
    .mini-bottle-cap { position: absolute; bottom: 18px; left: 2px; width: 8px; height: 3px; background: #06B6D4; border-radius: 1px; }
    .mini-bottle-fill { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, #22D3EE, #06B6D4); border-radius: 0 0 1px 1px; }
    .mini-bottle-1 .mini-bottle-fill { animation: bottleEmpty 3s ease-in-out infinite; }
    .mini-bottle-2 .mini-bottle-fill { animation: bottleFill 3s ease-in-out infinite; }
    @keyframes bottleEmpty { 0%, 10% { height: 75%; } 45%, 55% { height: 15%; } 90%, 100% { height: 75%; } }
    @keyframes bottleFill { 0%, 10% { height: 15%; } 45%, 55% { height: 75%; } 90%, 100% { height: 15%; } }
    .mini-stock-count { position: absolute; top: -2px; right: -4px; width: 12px; height: 12px; background: #06B6D4; border-radius: 50%; font-size: 7px; font-weight: 700; color: #083344; display: flex; align-items: center; justify-content: center; }
    .mini-paie { width: 32px; height: 28px; display: flex; align-items: center; justify-content: center; position: relative; }
    .mini-paie-people { display: flex; align-items: flex-end; gap: 1px; position: absolute; animation: paiePeopleToEuro 3.5s ease-in-out infinite; }
    .mini-paie-person { display: flex; flex-direction: column; align-items: center; }
    .mini-paie-head { width: 5px; height: 5px; border-radius: 50%; background: white; margin-bottom: 1px; }
    .mini-paie-body { width: 7px; height: 7px; background: white; border-radius: 2px 2px 1px 1px; }
    @keyframes paiePeopleToEuro { 0%, 50% { opacity: 1; } 60%, 90% { opacity: 0; } 100% { opacity: 1; } }
    .mini-paie-euro { position: absolute; font-size: 18px; font-weight: 800; color: white; opacity: 0; animation: paieEuroAppear 3.5s ease-in-out infinite; }
    @keyframes paieEuroAppear { 0%, 50% { opacity: 0; transform: scale(0.5); } 65% { opacity: 1; transform: scale(1.1); } 75%, 85% { opacity: 1; transform: scale(1); } 95%, 100% { opacity: 0; transform: scale(0.8); } }

    /* Modules List */
    .modules-list { display: flex; flex-direction: column; gap: 8px; }
    .module-list-item { display: flex; align-items: center; gap: 14px; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; cursor: pointer; transition: all 0.2s; }
    .module-list-item:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); }
    .module-list-item.active { background: rgba(255,107,53,0.1); border-color: rgba(255,107,53,0.3); }
    .module-list-color { width: 44px; height: 44px; border-radius: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .module-list-info { flex: 1; min-width: 0; }
    .module-list-name { font-size: 15px; font-weight: 500; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .module-list-meta { font-size: 12px; color: rgba(255,255,255,0.4); display: flex; gap: 16px; }
    .module-list-badge { padding: 3px 10px; border-radius: 8px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .module-list-badge.draft { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .module-list-badge.beta { background: rgba(168,85,247,0.15); color: #c084fc; }
    .module-list-badge.public { background: rgba(34,197,94,0.15); color: #4ade80; }
    .module-list-actions { display: flex; gap: 8px; }

    /* Users Table */
    .table-container { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden; }
    .users-table { width: 100%; border-collapse: collapse; }
    .users-table th { text-align: left; padding: 14px 20px; background: rgba(255,255,255,0.02); color: rgba(255,255,255,0.5); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .users-table td { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
    .users-table tr:last-child td { border-bottom: none; }
    .users-table tr:hover td { background: rgba(255,255,255,0.02); }
    .user-cell { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,107,53,0.3); }
    .user-name { font-weight: 500; font-size: 14px; }
    .user-email { font-size: 12px; color: rgba(255,255,255,0.4); }
    .user-badges { display: flex; flex-wrap: wrap; gap: 6px; }
    .user-badge { font-size: 11px; padding: 4px 10px; border-radius: 8px; font-weight: 500; }
    .user-badge.active { background: rgba(34,197,94,0.15); color: #4ade80; }
    .user-badge.tester { background: rgba(168,85,247,0.15); color: #c084fc; }
    .user-badge.trialing { background: rgba(59,130,246,0.15); color: #60a5fa; }

    /* Chat Support */
    .chat-container { display: grid; grid-template-columns: 300px 1fr; gap: 24px; height: calc(100vh - 200px); min-height: 500px; }
    .chat-sidebar { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; }
    .chat-sidebar-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .chat-list { flex: 1; overflow-y: auto; }
    .chat-item { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.04); cursor: pointer; transition: all 0.2s; }
    .chat-item:hover { background: rgba(255,255,255,0.02); }
    .chat-item.active { background: rgba(255,107,53,0.1); }
    .chat-item.unread { border-left: 3px solid #FF6B35; }
    .chat-item-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .chat-item-name { font-weight: 500; font-size: 14px; }
    .chat-item-time { font-size: 11px; color: rgba(255,255,255,0.3); }
    .chat-item-preview { font-size: 12px; color: rgba(255,255,255,0.4); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-main { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; display: flex; flex-direction: column; }
    .chat-header { padding: 16px 24px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 12px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; }
    .chat-message { max-width: 70%; }
    .chat-message.incoming { align-self: flex-start; }
    .chat-message.outgoing { align-self: flex-end; }
    .chat-bubble { padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; }
    .chat-message.incoming .chat-bubble { background: rgba(255,255,255,0.06); border-bottom-left-radius: 4px; }
    .chat-message.outgoing .chat-bubble { background: rgba(255,107,53,0.2); border-bottom-right-radius: 4px; }
    .chat-message-time { font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 4px; }
    .chat-input-area { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.06); display: flex; gap: 12px; }
    .chat-input { flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; color: white; font-size: 14px; resize: none; }
    .chat-input:focus { outline: none; border-color: rgba(255,107,53,0.5); }
    .chat-empty { flex: 1; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.3); font-size: 14px; }

    /* URL Box */
    .url-box { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .url-label { font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .url-value { display: flex; align-items: center; gap: 12px; }
    .url-text { flex: 1; font-size: 13px; font-family: monospace; color: rgba(255,255,255,0.7); word-break: break-all; }
    .url-copy { padding: 6px 12px; background: rgba(255,255,255,0.06); border: none; border-radius: 8px; color: rgba(255,255,255,0.6); font-size: 11px; cursor: pointer; transition: all 0.2s; }
    .url-copy:hover { background: rgba(255,255,255,0.1); color: white; }
    .url-copy.copied { background: rgba(34,197,94,0.2); color: #4ade80; }

    /* Editor Tabs */
    .editor-tabs { display: flex; gap: 4px; margin-bottom: 24px; background: rgba(255,255,255,0.02); padding: 4px; border-radius: 14px; }
    .editor-tab { flex: 1; padding: 12px 16px; background: transparent; border: none; border-radius: 10px; color: rgba(255,255,255,0.5); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .editor-tab:hover { color: white; }
    .editor-tab.active { background: rgba(255,107,53,0.15); color: #FF6B35; }
    .editor-panel { display: none; }
    .editor-panel.active { display: block; }

    /* Setup Builder */
    .setup-steps { display: flex; flex-direction: column; gap: 8px; min-height: 60px; padding: 16px; background: rgba(255,255,255,0.02); border: 2px dashed rgba(255,255,255,0.1); border-radius: 14px; }
    .setup-steps.drag-over { border-color: #FF6B35; background: rgba(255,107,53,0.05); }
    .setup-steps-empty { text-align: center; padding: 24px; color: rgba(255,255,255,0.3); font-size: 13px; }
    .setup-step { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; cursor: grab; transition: all 0.2s; }
    .setup-step:hover { background: rgba(255,255,255,0.06); }
    .setup-step.dragging { opacity: 0.5; }
    .setup-step-handle { color: rgba(255,255,255,0.3); cursor: grab; }
    .setup-step-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .setup-step-info { flex: 1; }
    .setup-step-title { font-size: 14px; font-weight: 500; }
    .setup-step-type { font-size: 11px; color: rgba(255,255,255,0.4); }
    .setup-step-delete { padding: 8px; border-radius: 8px; background: transparent; border: none; color: rgba(255,255,255,0.3); cursor: pointer; }
    .setup-step-delete:hover { background: rgba(239,68,68,0.1); color: #f87171; }
    .setup-add-bar { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
    .setup-add-btn { padding: 10px 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; color: rgba(255,255,255,0.6); font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .setup-add-btn:hover { background: rgba(255,255,255,0.08); color: white; }

    /* Activity Feed */
    .activity-feed { display: flex; flex-direction: column; gap: 4px; }
    .activity-item { display: flex; align-items: flex-start; gap: 12px; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .activity-content { flex: 1; }
    .activity-text { font-size: 13px; line-height: 1.4; }
    .activity-time { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 4px; }

    /* Settings */
    .settings-section { margin-bottom: 32px; }
    .settings-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .settings-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden; }
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.04); }
    .settings-item:last-child { border-bottom: none; }
    .settings-item-info { flex: 1; }
    .settings-item-label { font-size: 14px; font-weight: 500; }
    .settings-item-desc { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 2px; }
    .toggle { width: 44px; height: 24px; background: rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; position: relative; transition: all 0.2s; }
    .toggle.active { background: #FF6B35; }
    .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: all 0.2s; }
    .toggle.active::after { left: 22px; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal { background: #0f0f0f; border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 18px; font-weight: 600; }
    .modal-close { width: 36px; height: 36px; background: rgba(255,255,255,0.04); border: none; border-radius: 10px; color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: rgba(255,255,255,0.1); color: white; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.06); display: flex; gap: 12px; justify-content: flex-end; }

    /* Tester Modal */
    #tester-modal { display: flex; }
    .modal-content { background: #0f0f0f; border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; max-width: 450px; width: 100%; }
    .modal-content .modal-header { padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: space-between; }
    .modal-content .modal-header h3 { font-size: 18px; font-weight: 600; margin: 0; }
    .modal-content .modal-body { padding: 20px 24px; }
    .tester-modules-list { display: flex; flex-direction: column; gap: 12px; }
    .tester-module-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; }
    .tester-module-info { display: flex; align-items: center; gap: 12px; }
    .tester-module-color { width: 12px; height: 12px; border-radius: 4px; }
    .toggle-switch { position: relative; width: 44px; height: 24px; cursor: pointer; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: rgba(255,255,255,0.1); border-radius: 24px; transition: 0.2s; }
    .toggle-slider::before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.2s; }
    .toggle-switch input:checked + .toggle-slider { background: #22c55e; }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }

    /* Animation Gallery */
    .animation-gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .animation-gallery-item { padding: 16px; background: rgba(255,255,255,0.02); border: 2px solid rgba(255,255,255,0.06); border-radius: 14px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .animation-gallery-item:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.12); transform: translateY(-2px); }
    .animation-gallery-item.selected { border-color: #FF6B35; background: rgba(255,107,53,0.1); }
    .animation-gallery-preview { width: 60px; height: 60px; margin: 0 auto 12px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .animation-gallery-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .animation-gallery-desc { font-size: 11px; color: rgba(255,255,255,0.4); line-height: 1.4; }
    .ai-suggestion-card { padding: 16px; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; }
    .ai-suggestion-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }

    /* Toast */
    /* Notification Bell */
    .notif-bell { width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); cursor: pointer; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.6); transition: all 0.2s; position: relative; }
    .notif-bell:hover { background: rgba(255,255,255,0.08); color: white; }
    .notif-bell.has-notif { animation: bellRing 0.5s ease; }
    .notif-bell.has-notif::after { content: ''; position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #FF6B35; border-radius: 50%; animation: pulse 1s infinite; }
    @keyframes bellRing { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(15deg); } 50% { transform: rotate(-15deg); } 75% { transform: rotate(5deg); } }

    .toast { position: fixed; top: 24px; right: 24px; padding: 16px 24px; background: rgba(34,197,94,0.9); backdrop-filter: blur(12px); border-radius: 14px; color: white; font-size: 14px; font-weight: 500; opacity: 0; transform: translateY(-20px); transition: all 0.3s; z-index: 10000; display: flex; align-items: center; gap: 10px; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: rgba(239,68,68,0.9); }
    .toast.info { background: rgba(59,130,246,0.9); }

    /* Search */
    .search-input { width: 100%; max-width: 320px; padding: 12px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; color: white; font-size: 14px; }
    .search-input:focus { outline: none; border-color: #FF6B35; }
    .search-input::placeholder { color: rgba(255,255,255,0.3); }

    /* Auth Screen */
    .auth-screen { position: fixed; inset: 0; background: #0a0a0a; display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .auth-box { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 28px; padding: 48px; max-width: 420px; width: 90%; text-align: center; }
    .auth-icon { width: 72px; height: 72px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 20px; margin: 0 auto 28px; display: flex; align-items: center; justify-content: center; }
    .auth-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .auth-subtitle { color: rgba(255,255,255,0.4); font-size: 15px; margin-bottom: 36px; }
    .auth-btn { width: 100%; padding: 18px 24px; background: white; border: none; border-radius: 16px; color: #333; font-weight: 600; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 14px; transition: all 0.2s; }
    .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(255,255,255,0.2); }
    .auth-error { color: #ef4444; margin-top: 20px; font-size: 14px; display: none; }
    .auth-loading { color: rgba(255,255,255,0.5); margin-top: 20px; font-size: 14px; display: none; }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.4); }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
    .empty-state p { font-size: 15px; }

    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; padding: 60px; }
    .spinner { width: 28px; height: 28px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #FF6B35; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-screen" id="auth-screen">
    <div class="auth-box">
      <div class="auth-icon">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      </div>
      <h2 class="auth-title">Admin iArmy</h2>
      <p class="auth-subtitle">Connexion reservee aux administrateurs</p>
      <button class="auth-btn" onclick="signInWithGoogle()">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Connexion avec Google
      </button>
      <p class="auth-error" id="auth-error"></p>
      <p class="auth-loading" id="auth-loading">Verification...</p>
    </div>
  </div>

  <!-- Main App -->
  <div class="app" id="main-app" style="display: none;">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo" style="gap: 10px;">
          <div class="logo-i" style="width: 36px; height: 36px; min-width: 36px; min-height: 36px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 139.61 327.81">
              <defs><style>.logo-body{fill:#fff;stroke:#fff;stroke-miterlimit:10}.logo-shadow{fill:#cecdd1;stroke-miterlimit:10}.logo-shadow-stroke{fill:#cecdd1;stroke:#cecdd1;stroke-miterlimit:10}.logo-helmet-band{fill:#FF6B35;stroke:#FF6B35;stroke-miterlimit:10}</style></defs>
              <g id="i-body"><path class="logo-body" d="M85.32,142.54c-2.41.32-5.05.57-7.21.96-8.54,1.56-33.88,6.95-43.99,9.8-12.24,3.46-13.3,11.97-14.1,17.56-.8,5.59,1.41,17.88,11.17,17.88,8.54,0,8.25,10.59,8.25,10.59,0,0,.14,68.63,0,84.86-.16,17.89-10.64,17.82-10.64,17.82,0,0-7.71,0-7.71,12.24,0,13.39,14.1,13.03,14.1,13.03h85.12c10.91,0,11.7-14.63,11.7-14.63,0,0,1.6-13.83-10.64-13.83-8.78,0-8.25-15.69-8.25-15.69v-112.79s1.05-15.65-4.69-20.55c-7.08-6.86-15.9-8.21-23.11-7.24Z"/><path class="logo-shadow" d="M51.63,148.52c-15.07,6.79-15.86,21.93-15.86,21.93,0,0-1.5,12.05,11.76,14.95,6.69,1.42,6.63,13.69,6.63,13.69v85.37c0,16.21-8.04,17.97-8.04,17.97,0,0-7.31.55-7.31,12.31,0,13.47,11.31,13.07,11.31,13.07h-14.97s-14.9.36-14.89-13.11c0-12.31,7.71-13.2,7.71-13.2,0,0,10.92.15,10.92-17.04v-85.37s.24-9.76-7.67-9.76c-10.37,0-12.68-13.36-11.88-18.98.8-5.62,2.46-14.33,14.77-17.81l17.49-4.02Z"/></g>
              <g id="i-head"><circle class="logo-body" cx="71.97" cy="86.29" r="47.78"/><path class="logo-shadow-stroke" d="M28.09,105.24c-2.51-5.81-3.9-12.22-3.9-18.95,0-26.39,21.39-47.78,47.78-47.78,21.31,0,39.36,13.95,45.52,33.22,0,0-57.76-3.29-89.39,33.5Z"/><path class="logo-shadow" d="M11.18,94.6c7.57,0,22.75-16.13,22.75-16.13,0,0,9.63-8.94,22.45-13.62,0,0-15.61,5.19-20.22,5.09-5.54-.13-18.51-29.21,3.34-53.81-18.29,6.35-31.42,23.73-31.42,44.18,0,0,.43,7.31,1.24,10.76,0,0,2.7,9.61,1.85,23.53Z"/><path class="logo-shadow" d="M90.21,58.98c22.66-6.38,45.01-.4,37.63-3.02-8.45-2.99-7.62-11.85-7.62-11.85,0,0-3.34,4.39-30,14.86Z"/></g>
              <g id="i-helmet"><path class="logo-body" d="M.66,106s-1.06-3.33,2.22-6.38c4.51-4.19-.15-23.54-.15-23.54-1.07-4.54-1.64-9.28-1.64-14.14C1.09,28.01,28.6.5,62.53.5c28.39,0,52.29,19.26,59.33,45.43,0,0,.69,6.19,7.75,9.4,4.72,2.14,9.06,4.39,9.43,7.55,0,0-22.99-6.11-65.67,3.07-25.04,4.53-39.22,19.55-39.22,19.55,0,0-23.43,24.08-33.47,20.51Z"/><path class="logo-helmet-band" d="M.66,106c.84,4.08,18.82,3.64,28.44,2.78,44.27-4.52,100.5-34,107.13-40.41,2.2-2.13,2.98-3.92,2.8-5.49,0,0-22.99-6.11-65.67,3.07-25.04,4.53-39.22,19.55-39.22,19.55,0,0-23.43,24.08-33.47,20.51"/><path class="logo-helmet-band" d="M.66,106c10.04,3.58,33.47-20.51,33.47-20.51,0,0,14.19-15.02,39.22-19.55,42.68-9.18,65.67-3.07,65.67-3.07.14,1.18-.2,2.38-1.34,3.86l-.02.03c-5.59-1.12-27.75-4.42-64.31,3.45-25.04,4.53-39.22,19.55-39.22,19.55,0,0-13.82,14.38-24.79,19.32,0,0-8.43-.46-8.68-3.09Z"/></g>
            </svg>
          </div>
          <div><span style="color: #FF6B35;">i</span>Army Admin</div>
        </div>
      </div>
      <nav class="nav">
        <div class="nav-section">
          <div class="nav-title">Vue d'ensemble</div>
          <div class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
            Dashboard
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-title">Gestion</div>
          <div class="nav-item" data-tab="modules" onclick="switchTab('modules')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            Modules
            <span class="nav-badge" id="modules-count">0</span>
          </div>
          <div class="nav-item" data-tab="users" onclick="switchTab('users')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Utilisateurs
            <span class="nav-badge" id="users-count">0</span>
          </div>
          <div class="nav-item" data-tab="telegram" onclick="switchTab('telegram')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            Telegram
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-title">Support</div>
          <div class="nav-item" data-tab="support" onclick="switchTab('support')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            Chat Support
            <span class="nav-badge green" id="support-count" style="display:none;">0</span>
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-title">Statistiques</div>
          <div class="nav-item" data-tab="analytics" onclick="switchTab('analytics')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
            Analytics
          </div>
        </div>
        <div class="nav-footer">
          <div class="nav-item" data-tab="settings" onclick="switchTab('settings')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            Parametres
          </div>
          <div class="nav-item" onclick="window.location.href='/'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Retour au site
          </div>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main">
      <div class="main-header">
        <div>
          <h1 class="main-title" id="page-title">Dashboard</h1>
          <p class="main-subtitle" id="page-subtitle">Vue d'ensemble de votre application</p>
        </div>
        <div style="display:flex;align-items:center;gap:16px;">
          <button class="notif-bell" id="notif-bell" onclick="switchTab('support')" title="Notifications">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          </button>
          <div class="main-actions" id="header-actions"></div>
        </div>
      </div>
      <div class="main-content" id="main-content">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ==================
    // CONFIG
    // ==================
    const SUPABASE_URL = IARMY_CONFIG?.SUPABASE_URL || 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = IARMY_CONFIG?.SUPABASE_ANON_KEY || 'sb_publishable_8mpFx9ubrV29KfKtgAb3eg_dyazidfT';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Data
    let modules = [];
    let users = [];
    let analytics = {};
    let conversations = [];
    let adminUsers = [];
    let currentTab = 'dashboard';
    let currentModule = null;
    let currentEditorTab = 'general';
    let currentSetupSteps = [];
    let selectedColor = '#22c55e';
    let selectedIconType = 'telegram_sheets';
    let selectedBadge = null;
    let selectedVisibility = 'draft';
    let currentUser = null;

    // Config
    const COLOR_PRESETS = [
      { name: 'Vert', color: '#22c55e' },
      { name: 'Cyan', color: '#06b6d4' },
      { name: 'Orange', color: '#f59e0b' },
      { name: 'Violet', color: '#8b5cf6' },
      { name: 'Rose', color: '#ec4899' },
      { name: 'Jaune', color: '#eab308' },
      { name: 'Bleu', color: '#3b82f6' },
      { name: 'Rouge', color: '#ef4444' },
      { name: 'Indigo', color: '#6366f1' },
      { name: 'Emeraude', color: '#10b981' },
      { name: 'Fuchsia', color: '#d946ef' },
      { name: 'Lime', color: '#84cc16' }
    ];

    const ICON_TYPES = [
      { id: 'telegram_sheets', name: 'Tableur', desc: 'Cellules qui se remplissent - ideal pour donn√©es/sync' },
      { id: 'bottles_count', name: 'Bouteilles', desc: 'Transfert de liquide - ideal pour inventaire/stock' },
      { id: 'people_pdf', name: 'Equipe', desc: 'Personnes ‚Üí Euro - ideal pour paie/RH' },
      { id: 'calendar', name: 'Calendrier', desc: 'Calendrier simple - ideal pour planning' },
      { id: 'reservation', name: 'Check', desc: 'Case coch√©e - ideal pour r√©servations/t√¢ches' },
      { id: 'star', name: 'Etoile', desc: 'Etoile simple - ideal pour fid√©lit√©/avis' }
    ];

    const BADGE_OPTIONS = [
      { id: null, name: 'Auto', desc: 'Nouveau si < 14j' },
      { id: 'nouveau', name: 'üÜï Nouveau' },
      { id: 'populaire', name: 'üî• Populaire' },
      { id: 'promo', name: 'üí∞ Promo' },
      { id: 'none', name: 'Aucun' }
    ];

    const SETUP_STEP_TYPES = [
      { id: 'google_auth', name: 'Google', icon: 'üîó', color: '#4285f4', title: 'Connexion Google', desc: 'Connecte ton compte Google' },
      { id: 'telegram_link', name: 'Telegram', icon: 'üì±', color: '#0088cc', title: 'Connexion Telegram', desc: 'Lie ton compte Telegram' },
      { id: 'stripe_checkout', name: 'Paiement', icon: 'üí≥', color: '#635bff', title: 'Paiement', desc: 'Active ton abonnement' },
      { id: 'file_upload', name: 'Fichier', icon: 'üìÑ', color: '#22c55e', title: 'Upload fichier', desc: 'Envoie un fichier' },
      { id: 'photo_upload', name: 'Photo', icon: 'üì∏', color: '#f59e0b', title: 'Upload photo', desc: 'Prends une photo' },
      { id: 'ai_analysis', name: 'Analyse IA', icon: 'ü§ñ', color: '#8b5cf6', title: 'Analyse IA', desc: 'Analyse automatique' },
      { id: 'config_validation', name: 'Config', icon: '‚öôÔ∏è', color: '#6b7280', title: 'Validation', desc: 'Verifie la config' }
    ];

    // ==================
    // AUTH
    // ==================
    async function signInWithGoogle() {
      document.getElementById('auth-loading').style.display = 'block';
      sessionStorage.setItem('auth_redirect', window.location.href);
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin + '/auth/callback' }
      });
      if (error) {
        document.getElementById('auth-loading').style.display = 'none';
        document.getElementById('auth-error').textContent = error.message;
        document.getElementById('auth-error').style.display = 'block';
      }
    }

    async function checkAuth() {
      document.getElementById('auth-loading').style.display = 'block';
      const { data: { session } } = await supabaseClient.auth.getSession();

      if (session) {
        // Check if user is admin
        const { data: adminData } = await supabaseClient
          .from('admin_users')
          .select('email, role')
          .eq('email', session.user.email)
          .single();

        if (adminData) {
          currentUser = { ...session.user, role: adminData.role };
          document.getElementById('auth-screen').style.display = 'none';
          document.getElementById('main-app').style.display = 'flex';
          init();
        } else {
          document.getElementById('auth-error').textContent = 'Email non autorise: ' + session.user.email;
          document.getElementById('auth-error').style.display = 'block';
          document.getElementById('auth-loading').style.display = 'none';
          await supabaseClient.auth.signOut();
        }
      } else {
        document.getElementById('auth-loading').style.display = 'none';
      }
    }

    checkAuth();
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) checkAuth();
    });

    // ==================
    // INIT
    // ==================
    async function init() {
      await Promise.all([loadModules(), loadUsers(), loadAnalytics(), loadAdminUsers(), loadConversations()]);
      renderTab();
      setupRealtimeSubscriptions();
      requestNotificationPermission();
    }

    // ==================
    // REALTIME & NOTIFICATIONS
    // ==================
    function setupRealtimeSubscriptions() {
      // Ecouter les nouveaux messages support
      supabaseClient
        .channel('support-messages')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'support_messages'
        }, async (payload) => {
          const msg = payload.new;
          if (msg.sender_type === 'user') {
            // Nouveau message utilisateur
            showNotification('Nouveau message', msg.content.substring(0, 50) + '...');
            await loadConversations();
            if (currentTab === 'support') renderSupportTab();
          }
        })
        .subscribe();

      // Ecouter les nouvelles conversations
      supabaseClient
        .channel('support-conversations')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'support_conversations'
        }, async () => {
          showNotification('Nouvelle conversation', 'Un utilisateur a ouvert une conversation');
          await loadConversations();
          if (currentTab === 'support') renderSupportTab();
        })
        .subscribe();

      // Ecouter les nouveaux utilisateurs
      supabaseClient
        .channel('new-profiles')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'profiles'
        }, async () => {
          await loadUsers();
          if (currentTab === 'users' || currentTab === 'dashboard') renderTab();
        })
        .subscribe();
    }

    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function showNotification(title, body) {
      // Afficher dans l'UI
      const notifBell = document.getElementById('notif-bell');
      if (notifBell) {
        notifBell.classList.add('has-notif');
        setTimeout(() => notifBell.classList.remove('has-notif'), 3000);
      }

      // Notification navigateur
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
          body: body,
          icon: '/img/logo.png',
          badge: '/img/logo.png'
        });
      }

      // Son de notification
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleREAOeli7GhPZHma3PG3h1QdAIe/');
        audio.volume = 0.3;
        audio.play().catch(() => {});
      } catch (e) {}
    }

    // ==================
    // DATA LOADING
    // ==================
    async function loadModules() {
      const { data, error } = await supabaseClient.from('modules').select('*').order('sort_order');
      if (!error) {
        modules = data || [];
        document.getElementById('modules-count').textContent = modules.length;
      }
    }

    async function loadUsers() {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;

        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-data`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
            'apikey': SUPABASE_ANON_KEY
          }
        });

        if (response.ok) {
          const data = await response.json();
          users = (data.users || []).map(u => ({
            ...u,
            subscriptions: (data.subscriptions || []).filter(s => s.user_id === u.user_id),
            telegram: (data.telegramLinks || []).some(t => t.user_id === u.user_id)
          }));
          document.getElementById('users-count').textContent = users.length;
        }
      } catch (e) {
        console.error('Error loading users:', e);
      }
    }

    async function loadAnalytics() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
      const fiveMinAgo = new Date(now - 5 * 60 * 1000).toISOString();

      const [onlineRes, todayRes, recentRes] = await Promise.all([
        supabaseClient.from('page_visits').select('visitor_id').gte('created_at', fiveMinAgo),
        supabaseClient.from('page_visits').select('*', { count: 'exact', head: true }).gte('created_at', today),
        supabaseClient.from('page_visits').select('*').order('created_at', { ascending: false }).limit(20)
      ]);

      analytics = {
        online: new Set((onlineRes.data || []).map(v => v.visitor_id)).size,
        today: todayRes.count || 0,
        recent: recentRes.data || []
      };
    }

    async function loadAdminUsers() {
      const { data } = await supabaseClient.from('admin_users').select('*').order('created_at');
      adminUsers = data || [];
    }

    async function loadConversations() {
      // Charger les conversations support depuis Supabase
      const { data } = await supabaseClient
        .from('support_conversations')
        .select('*, support_messages(id, content, sender_type, is_read, created_at)')
        .order('last_message_at', { ascending: false })
        .limit(50);

      conversations = (data || []).map(c => {
        const lastMsg = c.support_messages?.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
        const unreadCount = c.support_messages?.filter(m => m.sender_type === 'user' && !m.is_read).length || 0;
        return {
          ...c,
          last_message: lastMsg?.content || '',
          unread_count: unreadCount
        };
      });

      // Compter les conversations avec messages non-lus
      const unread = conversations.filter(c => c.unread_count > 0).length;
      const badge = document.getElementById('support-count');
      if (badge) {
        if (unread > 0) {
          badge.textContent = unread;
          badge.style.display = 'block';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    let currentConversation = null;
    let currentMessages = [];

    async function openConversation(convId) {
      currentConversation = conversations.find(c => c.id === convId);
      if (!currentConversation) return;

      // Charger les messages
      const { data } = await supabaseClient
        .from('support_messages')
        .select('*')
        .eq('conversation_id', convId)
        .order('created_at', { ascending: true });

      currentMessages = data || [];

      // Marquer comme lus
      await supabaseClient
        .from('support_messages')
        .update({ is_read: true })
        .eq('conversation_id', convId)
        .eq('sender_type', 'user');

      renderSupportTab();
    }

    async function sendSupportMessage() {
      if (!currentConversation) return;
      const input = document.getElementById('chat-input');
      const content = input.value.trim();
      if (!content) return;

      const { error } = await supabaseClient
        .from('support_messages')
        .insert({
          conversation_id: currentConversation.id,
          sender_type: 'admin',
          sender_name: 'Admin',
          content: content
        });

      if (error) {
        showToast('Erreur: ' + error.message, 'error');
        return;
      }

      input.value = '';
      await openConversation(currentConversation.id);
    }

    async function updateConversationStatus(status) {
      if (!currentConversation) return;
      await supabaseClient
        .from('support_conversations')
        .update({ status })
        .eq('id', currentConversation.id);

      showToast('Statut mis a jour');
      await loadConversations();
      renderSupportTab();
    }

    // ==================
    // TAB SWITCHING
    // ==================
    function switchTab(tab) {
      currentTab = tab;
      currentModule = null;
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`.nav-item[data-tab="${tab}"]`)?.classList.add('active');
      renderTab();
    }

    function renderTab() {
      const titles = {
        dashboard: ['Dashboard', 'Vue d\'ensemble de votre application'],
        modules: ['Modules', 'Gerez vos soldats'],
        users: ['Utilisateurs', 'Gerez vos utilisateurs'],
        telegram: ['Telegram Bot', 'Messages et reponses du bot'],
        support: ['Chat Support', 'Conversations avec les utilisateurs'],
        analytics: ['Analytics', 'Statistiques en temps reel'],
        settings: ['Parametres', 'Configuration de l\'application']
      };

      const [title, subtitle] = titles[currentTab] || ['Admin', ''];
      document.getElementById('page-title').textContent = title;
      document.getElementById('page-subtitle').textContent = subtitle;

      switch(currentTab) {
        case 'dashboard': renderDashboard(); break;
        case 'modules': renderModulesTab(); break;
        case 'users': renderUsersTab(); break;
        case 'telegram': renderTelegramTab(); break;
        case 'support': renderSupportTab(); break;
        case 'analytics': renderAnalyticsTab(); break;
        case 'settings': renderSettingsTab(); break;
      }
    }

    // ==================
    // DASHBOARD
    // ==================
    function renderDashboard() {
      document.getElementById('header-actions').innerHTML = '';

      const activeModules = modules.filter(m => m.visibility === 'public').length;
      const testers = users.filter(u => u.subscriptions?.some(s => s.is_tester)).length;
      const revenue = users.reduce((sum, u) => {
        const paid = u.subscriptions?.filter(s => s.status === 'active' && !s.is_tester) || [];
        return sum + paid.length * 39;
      }, 0);

      document.getElementById('main-content').innerHTML = `
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card live">
            <div class="stat-icon" style="background:rgba(34,197,94,0.15);">üë•</div>
            <div class="stat-value" style="color:#fff;font-size:32px;">${analytics?.online ?? 0}</div>
            <div class="stat-label" style="color:#999;">Visiteurs en ligne</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:rgba(255,107,53,0.15);">üìä</div>
            <div class="stat-value">${analytics.today || 0}</div>
            <div class="stat-label">Visites aujourd'hui</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:rgba(139,92,246,0.15);">üì¶</div>
            <div class="stat-value">${activeModules}</div>
            <div class="stat-label">Modules actifs</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:rgba(6,182,212,0.15);">üë§</div>
            <div class="stat-value">${users.length}</div>
            <div class="stat-label">Utilisateurs</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:rgba(236,72,153,0.15);">üß™</div>
            <div class="stat-value">${testers}</div>
            <div class="stat-label">Testeurs</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:rgba(234,179,8,0.15);">üí∞</div>
            <div class="stat-value">${revenue}‚Ç¨</div>
            <div class="stat-label">Revenu mensuel</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card-header"><div class="card-title">Actions rapides</div></div>
        <div class="quick-actions">
          <div class="quick-action" onclick="switchTab('modules');createNewModule();">
            <div class="quick-action-icon">‚ûï</div>
            <div class="quick-action-label">Nouveau module</div>
          </div>
          <div class="quick-action" onclick="switchTab('users');">
            <div class="quick-action-icon">üë•</div>
            <div class="quick-action-label">Voir utilisateurs</div>
          </div>
          <div class="quick-action" onclick="switchTab('support');">
            <div class="quick-action-icon">üí¨</div>
            <div class="quick-action-label">Chat support</div>
          </div>
          <div class="quick-action" onclick="switchTab('analytics');">
            <div class="quick-action-icon">üìä</div>
            <div class="quick-action-label">Analytics</div>
          </div>
          <div class="quick-action" onclick="switchTab('settings');">
            <div class="quick-action-icon">‚öôÔ∏è</div>
            <div class="quick-action-label">Parametres</div>
          </div>
          <div class="quick-action" onclick="window.open('https://dashboard.stripe.com', '_blank');">
            <div class="quick-action-icon">üí≥</div>
            <div class="quick-action-label">Stripe</div>
          </div>
        </div>

        <!-- Grid -->
        <div class="grid-2">
          <!-- Recent Activity -->
          <div class="card">
            <div class="card-header"><div class="card-title">Activite recente</div></div>
            <div class="activity-feed">
              ${(analytics.recent || []).slice(0, 8).map(v => {
                const time = new Date(v.created_at);
                return `
                  <div class="activity-item">
                    <div class="activity-icon" style="background:rgba(255,107,53,0.15);">üìç</div>
                    <div class="activity-content">
                      <div class="activity-text">Visite sur <strong>${v.page_path === '/' ? 'Accueil' : v.page_path}</strong></div>
                      <div class="activity-time">${time.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}</div>
                    </div>
                  </div>
                `;
              }).join('') || '<div class="empty-state"><p>Aucune activite</p></div>'}
            </div>
          </div>

          <!-- Modules Overview -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Modules</div>
              <button class="btn btn-sm btn-secondary" onclick="switchTab('modules')">Voir tous</button>
            </div>
            <div class="modules-list">
              ${modules.slice(0, 5).map(m => `
                <div class="module-list-item" onclick="switchTab('modules');selectModule('${m.id}');">
                  <div class="module-list-color" style="background:${m.color};">
                    ${getModuleIcon(m.icon_type, 'white')}
                  </div>
                  <div class="module-list-info">
                    <div class="module-list-name">${m.name}</div>
                    <div class="module-list-meta"><span>${m.price || 0}‚Ç¨/mois</span></div>
                  </div>
                  <span class="module-list-badge ${m.visibility || 'draft'}">${m.visibility === 'public' ? 'üåç' : m.visibility === 'beta' ? 'üß™' : 'üîí'}</span>
                </div>
              `).join('') || '<div class="empty-state"><p>Aucun module</p></div>'}
            </div>
          </div>
        </div>
      `;
    }

    // Continue in next part...
    // (Le fichier est tr√®s long, je le coupe ici et continue)

    // ==================
    // MODULES TAB
    // ==================
    function renderModulesTab() {
      document.getElementById('header-actions').innerHTML = `<button class="btn btn-primary" onclick="createNewModule()">+ Nouveau Soldat</button>`;

      if (currentModule !== null) {
        renderModuleEditor();
        return;
      }

      document.getElementById('main-content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">${modules.length}</div><div class="stat-label">Modules total</div></div>
          <div class="stat-card"><div class="stat-value">${modules.filter(m => m.visibility === 'public').length}</div><div class="stat-label">Publics</div></div>
          <div class="stat-card"><div class="stat-value">${modules.filter(m => m.visibility === 'beta').length}</div><div class="stat-label">Beta</div></div>
          <div class="stat-card"><div class="stat-value">${modules.filter(m => m.visibility === 'draft').length}</div><div class="stat-label">Brouillons</div></div>
        </div>
        <div class="modules-list">
          ${modules.map(m => {
            const badge = getModuleBadgeText(m);
            return `
              <div class="module-list-item" onclick="selectModule('${m.id}')">
                <div class="module-list-color" style="background:${m.color};">
                  ${getModuleIcon(m.icon_type, 'white')}
                </div>
                <div class="module-list-info">
                  <div class="module-list-name">${m.name} ${badge ? `<span style="font-size:12px;">${badge}</span>` : ''}</div>
                  <div class="module-list-meta">
                    <span class="module-list-badge ${m.visibility || 'draft'}">${m.visibility === 'draft' ? 'üîí Brouillon' : m.visibility === 'beta' ? 'üß™ Beta' : 'üåç Public'}</span>
                    <span>${m.price || 0}‚Ç¨/mois</span>
                    <span>${m.trial_days || 7}j essai</span>
                  </div>
                </div>
                <div class="module-list-actions">
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();duplicateModule('${m.id}');">Dupliquer</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function getModuleBadgeText(m) {
      if (m.badge === 'none') return '';
      if (m.badge === 'nouveau') return 'üÜï';
      if (m.badge === 'populaire') return 'üî•';
      if (m.badge === 'promo') return 'üí∞';
      if (!m.badge && m.created_at) {
        const daysSince = (Date.now() - new Date(m.created_at).getTime()) / (1000 * 60 * 60 * 24);
        if (daysSince < 14) return 'üÜï';
      }
      return '';
    }

    function selectModule(id) {
      currentModule = modules.find(m => m.id === id) || null;
      if (currentModule) {
        selectedColor = currentModule.color || '#22c55e';
        selectedIconType = currentModule.icon_type || 'telegram_sheets';
        selectedBadge = currentModule.badge;
        selectedVisibility = currentModule.visibility || 'draft';
        currentSetupSteps = currentModule.setup_steps ? [...currentModule.setup_steps] : [];
      }
      currentEditorTab = 'general';
      renderModulesTab();
    }

    function createNewModule() {
      currentModule = {};
      selectedColor = '#22c55e';
      selectedIconType = 'telegram_sheets';
      selectedBadge = null;
      selectedVisibility = 'draft';
      currentSetupSteps = [];
      currentEditorTab = 'general';
      renderModulesTab();
    }

    async function duplicateModule(id) {
      const original = modules.find(m => m.id === id);
      if (!original) return;

      const newModule = {
        ...original,
        id: undefined,
        slug: original.slug + '_copy',
        name: original.name + ' (copie)',
        visibility: 'draft',
        created_at: undefined
      };
      delete newModule.id;
      delete newModule.created_at;

      const { error } = await supabaseClient.from('modules').insert(newModule);
      if (error) {
        showToast('Erreur: ' + error.message, 'error');
        return;
      }

      showToast('Module duplique !');
      await loadModules();
      renderModulesTab();
    }

    // Categories disponibles
    const CATEGORIES = [
      { id: 'restaurant', label: 'üçΩÔ∏è Restaurant', color: '#f59e0b' },
      { id: 'bar', label: 'üç∏ Bar', color: '#8b5cf6' },
      { id: 'hotel', label: 'üè® Hotel', color: '#3b82f6' },
      { id: 'commerce', label: 'üõí Commerce', color: '#22c55e' },
      { id: 'service', label: 'üîß Service', color: '#06b6d4' }
    ];
    let selectedCategories = [];

    function renderModuleEditor() {
      const isNew = !currentModule.id;
      const slug = currentModule.slug || '';

      // Defaults pour nouveau module
      if (isNew && !selectedBadge) selectedBadge = 'nouveau';
      if (currentModule.categories) selectedCategories = [...currentModule.categories];

      document.getElementById('header-actions').innerHTML = `
        <button class="btn btn-secondary" onclick="currentModule=null;renderModulesTab();">‚Üê Retour</button>
        ${!isNew ? `<button class="btn btn-danger" onclick="deleteModule()">Supprimer</button>` : ''}
        <button class="btn btn-primary" onclick="saveModule()">üíæ Sauver</button>
      `;

      document.getElementById('main-content').innerHTML = `
        <style>
          .module-studio { max-width:900px; margin:0 auto; }
          .studio-preview {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 24px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
          }
          .studio-card {
            width: 300px;
            height: 300px;
            border-radius: 32px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            transition: all 0.3s;
            margin-bottom: 32px;
          }
          .studio-card:hover { transform: scale(1.02); }
          .studio-icon {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            cursor: pointer;
            position: relative;
          }
          .studio-icon:hover::after {
            content: '‚ú® Changer';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
          }
          .studio-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            cursor: text;
            padding: 4px 12px;
            border-radius: 8px;
            transition: all 0.2s;
            min-width: 100px;
            outline: none;
          }
          .studio-name:hover, .studio-name:focus { background: rgba(255,255,255,0.1); }
          .studio-desc {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            line-height: 1.5;
            cursor: text;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
            max-width: 250px;
            outline: none;
          }
          .studio-desc:hover, .studio-desc:focus { background: rgba(255,255,255,0.1); }
          .studio-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
          }
          .studio-price { font-size: 42px; font-weight: 800; margin-bottom: 4px; }
          .studio-trial { font-size: 14px; color: rgba(255,255,255,0.4); }
          .studio-toolbar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 24px;
          }
          .toolbar-btn {
            padding: 10px 16px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
          }
          .toolbar-btn:hover { background: rgba(255,255,255,0.08); color: white; }
          .toolbar-btn.active { background: rgba(255,107,53,0.15); border-color: rgba(255,107,53,0.3); color: #FF6B35; }
          .toolbar-btn.ai { background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(139,92,246,0.1)); border-color: rgba(139,92,246,0.3); color: #a78bfa; }
          .toolbar-btn.ai:hover { background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(139,92,246,0.15)); }
          .studio-section { margin-bottom: 20px; }
          .section-title { font-size: 11px; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
          .color-dots { display: flex; gap: 8px; flex-wrap: wrap; }
          .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
          .color-dot:hover { transform: scale(1.15); }
          .color-dot.active { border-color: white; transform: scale(1.15); }
          .category-chips { display: flex; gap: 8px; flex-wrap: wrap; }
          .category-chip { padding: 8px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s; }
          .category-chip:hover { background: rgba(255,255,255,0.08); }
          .category-chip.active { border-color: currentColor; }
          .studio-footer { display: flex; gap: 16px; flex-wrap: wrap; }
          .footer-field { flex: 1; min-width: 120px; }
          .footer-label { font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 6px; }
          .footer-input { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; color: white; font-size: 14px; }
          .footer-input:focus { outline: none; border-color: rgba(255,107,53,0.5); }
          @keyframes sparkle { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
          .generating { animation: sparkle 0.5s infinite; }
        </style>

        <div class="module-studio">
          <!-- ZONE PREVIEW -->
          <div class="studio-preview">
            <!-- Card -->
            <div class="studio-card" id="preview-card">
              <div class="studio-badge" id="preview-badge" onclick="cycleBadge()">Nouveau</div>
              <div class="studio-icon" id="preview-icon" onclick="openIconPicker()"></div>
              <div class="studio-name" id="preview-name" contenteditable="true" onblur="syncName()" oninput="syncNameLive()">${currentModule.name || 'Nom du module'}</div>
              <div class="studio-desc" id="preview-desc" contenteditable="true" onblur="syncDesc()" oninput="syncDescLive()">${currentModule.description || 'Clique pour ajouter une description...'}</div>
            </div>

            <!-- Prix -->
            <div style="text-align:center;">
              <div class="studio-price"><span id="preview-price-value">${currentModule.price || 29}</span>‚Ç¨<span style="font-size:18px;font-weight:400;color:rgba(255,255,255,0.4);">/mois</span></div>
              <div class="studio-trial"><span id="preview-trial-value">${currentModule.trial_days || 7}</span> jours d'essai gratuit</div>
            </div>

            <!-- Toolbar IA -->
            <div class="studio-toolbar">
              <button class="toolbar-btn ai" onclick="generateFullModule()" id="btn-ai-full">
                ‚ú® Generer tout avec l'IA
              </button>
              <button class="toolbar-btn ai" onclick="generateDescriptionAI()" id="btn-ai-desc">
                ‚ú® Refaire le texte
              </button>
              <button class="toolbar-btn ai" onclick="suggestIconAI()" id="btn-ai-icon">
                ‚ú® Suggerer icone
              </button>
            </div>
          </div>

          <!-- COULEURS -->
          <div class="studio-section">
            <div class="section-title">Couleur</div>
            <div class="color-dots" id="color-dots"></div>
          </div>

          <!-- CATEGORIES -->
          <div class="studio-section">
            <div class="section-title">Categories</div>
            <div class="category-chips" id="category-chips"></div>
          </div>

          <!-- PARAMETRES -->
          <div class="studio-section">
            <div class="section-title">Parametres</div>
            <div class="studio-footer">
              <div class="footer-field">
                <div class="footer-label">ID technique</div>
                <input type="text" class="footer-input" id="field-slug" value="${slug}" placeholder="mon_module" ${!isNew ? 'disabled style="opacity:0.5;"' : ''}>
              </div>
              <div class="footer-field">
                <div class="footer-label">Prix ‚Ç¨/mois</div>
                <input type="number" class="footer-input" id="field-price" value="${currentModule.price || 29}" oninput="updatePriceDisplay()">
              </div>
              <div class="footer-field">
                <div class="footer-label">Essai (jours)</div>
                <input type="number" class="footer-input" id="field-trial" value="${currentModule.trial_days || 7}" oninput="updateTrialDisplay()">
              </div>
              <div class="footer-field">
                <div class="footer-label">Visibilite</div>
                <select class="footer-input" id="field-visibility" onchange="selectedVisibility=this.value;">
                  <option value="draft" ${selectedVisibility === 'draft' ? 'selected' : ''}>üîí Brouillon</option>
                  <option value="beta" ${selectedVisibility === 'beta' ? 'selected' : ''}>üß™ Beta</option>
                  <option value="public" ${selectedVisibility === 'public' ? 'selected' : ''}>üåç Public</option>
                </select>
              </div>
              <div class="footer-field">
                <div class="footer-label">Stripe Price ID</div>
                <input type="text" class="footer-input" id="field-stripe" value="${currentModule.stripe_price_id || ''}" placeholder="price_xxx">
              </div>
            </div>
          </div>

          <!-- Hidden fields -->
          <input type="hidden" id="field-name" value="${currentModule.name || ''}">
          <input type="hidden" id="field-description" value="${currentModule.description || ''}">
        </div>
      `;

      renderColorDots();
      renderCategoryChips();
      updateStudioPreview();
    }

    // Sync contenteditable to hidden field
    function syncName() {
      const name = document.getElementById('preview-name').textContent.trim();
      document.getElementById('field-name').value = name;
      if (!currentModule.id) {
        document.getElementById('field-slug').value = name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
      }
    }
    function syncNameLive() { document.getElementById('field-name').value = document.getElementById('preview-name').textContent.trim(); }
    function syncDesc() { document.getElementById('field-description').value = document.getElementById('preview-desc').innerHTML; }
    function syncDescLive() { document.getElementById('field-description').value = document.getElementById('preview-desc').innerHTML; }

    // Update displays
    function updatePriceDisplay() { document.getElementById('preview-price-value').textContent = document.getElementById('field-price').value || '29'; }
    function updateTrialDisplay() { document.getElementById('preview-trial-value').textContent = document.getElementById('field-trial').value || '7'; }

    // Cycle badge on click
    function cycleBadge() {
      const badges = ['nouveau', 'populaire', 'promo', null];
      const idx = badges.indexOf(selectedBadge);
      selectedBadge = badges[(idx + 1) % badges.length];
      updateStudioPreview();
    }

    // Color dots
    function renderColorDots() {
      const container = document.getElementById('color-dots');
      if (!container) return;
      container.innerHTML = COLOR_PRESETS.map(c => `
        <div class="color-dot ${selectedColor === c.color ? 'active' : ''}" style="background:${c.color};" onclick="selectColorStudio('${c.color}')" title="${c.name}"></div>
      `).join('');
    }
    function selectColorStudio(color) {
      selectedColor = color;
      renderColorDots();
      updateStudioPreview();
    }

    // Category chips
    function renderCategoryChips() {
      const container = document.getElementById('category-chips');
      if (!container) return;
      container.innerHTML = CATEGORIES.map(c => `
        <div class="category-chip ${selectedCategories.includes(c.id) ? 'active' : ''}" style="${selectedCategories.includes(c.id) ? 'color:' + c.color + ';border-color:' + c.color + ';background:' + c.color + '20;' : ''}" onclick="toggleCategory('${c.id}')">${c.label}</div>
      `).join('');
    }
    function toggleCategory(id) {
      if (selectedCategories.includes(id)) {
        selectedCategories = selectedCategories.filter(c => c !== id);
      } else {
        selectedCategories.push(id);
      }
      renderCategoryChips();
    }

    // Icon picker (simple)
    function openIconPicker() {
      const icons = ICON_TYPES;
      const html = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;" onclick="if(event.target===this)this.remove()">
          <div style="background:#111;border-radius:20px;padding:24px;max-width:400px;">
            <div style="font-weight:600;margin-bottom:16px;">Choisis une icone</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
              ${icons.map(i => `
                <div onclick="selectIconStudio('${i.id}');this.closest('[style*=fixed]').remove();" style="padding:20px;background:rgba(255,255,255,0.04);border:2px solid ${selectedIconType === i.id ? '#FF6B35' : 'rgba(255,255,255,0.08)'};border-radius:16px;cursor:pointer;text-align:center;">
                  <div style="width:48px;height:48px;margin:0 auto 8px;background:${selectedColor};border-radius:50%;display:flex;align-items:center;justify-content:center;">
                    ${getModuleIconMini(i.id)}
                  </div>
                  <div style="font-size:12px;color:rgba(255,255,255,0.6);">${i.name}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    function selectIconStudio(iconType) {
      selectedIconType = iconType;
      updateStudioPreview();
    }

    // Update studio preview
    function updateStudioPreview() {
      const card = document.getElementById('preview-card');
      if (!card) return;

      card.style.background = `linear-gradient(145deg, ${selectedColor}30, ${selectedColor}10)`;
      card.style.border = `2px solid ${selectedColor}40`;

      const icon = document.getElementById('preview-icon');
      if (icon) {
        icon.style.background = `linear-gradient(180deg, ${selectedColor}, ${darkenColorHex(selectedColor)})`;
        icon.innerHTML = getModuleIcon(selectedIconType, 'white');
      }

      const badge = document.getElementById('preview-badge');
      if (badge) {
        if (selectedBadge) {
          badge.style.display = 'block';
          const styles = { nouveau: ['#22c55e', 'Nouveau'], populaire: ['#f59e0b', 'Populaire'], promo: ['#ef4444', 'Promo'] };
          const [bg, text] = styles[selectedBadge] || ['#22c55e', 'Nouveau'];
          badge.style.background = bg;
          badge.style.color = 'white';
          badge.textContent = text;
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // Generate full module with AI
    async function generateFullModule() {
      const btn = document.getElementById('btn-ai-full');
      btn.classList.add('generating');
      btn.textContent = '‚ú® Generation...';

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const prompt = document.getElementById('preview-name').textContent.trim() || 'un nouveau module';
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-ai-generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`, 'apikey': SUPABASE_ANON_KEY },
          body: JSON.stringify({ type: 'module_full', prompt })
        });
        const data = await response.json();
        if (data.result) {
          if (data.result.name) document.getElementById('preview-name').textContent = data.result.name;
          if (data.result.description) document.getElementById('preview-desc').innerHTML = data.result.description;
          if (data.result.color) { selectedColor = data.result.color; renderColorDots(); }
          if (data.result.icon_type) selectedIconType = data.result.icon_type;
          if (data.result.price) document.getElementById('field-price').value = data.result.price;
          syncName(); syncDesc(); updatePriceDisplay();
          updateStudioPreview();
          showToast('‚ú® Module genere !');
        }
      } catch (e) { showToast('Erreur: ' + e.message, 'error'); }

      btn.classList.remove('generating');
      btn.textContent = '‚ú® Generer tout avec l\'IA';
    }
      `).join('');
    }

    // Mini icon for bar
    function getModuleIconMini(type) {
      const icons = {
        'telegram_sheets': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>',
        'bottles_count': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2h8v4l2 2v12a2 2 0 01-2 2H8a2 2 0 01-2-2V8l2-2V2z"/></svg>',
        'people_pdf': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M5 21v-2a4 4 0 014-4h6a4 4 0 014 4v2"/></svg>',
        'calendar': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
        'reservation': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>',
        'star': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>'
      };
      return icons[type] || icons['telegram_sheets'];
    }

    function selectBadge(badge) {
      selectedBadge = badge;
      renderBadgeBar();
      updatePreview();
    }

    // Auto-generate slug from name
    function autoSlug() {
      const nameField = document.getElementById('field-name');
      const slugField = document.getElementById('field-slug');
      if (slugField && !slugField.disabled && nameField) {
        slugField.value = nameField.value.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
      }
    }

    // Generate description with AI
    async function generateDescriptionAI() {
      const nameEl = document.getElementById('preview-name');
      const name = nameEl?.textContent?.trim() || document.getElementById('field-name')?.value || '';
      if (!name || name === 'Nom du module') { showToast('Donne un nom au module d\'abord', 'error'); return; }

      const btn = document.getElementById('btn-ai-desc') || document.getElementById('btn-gen-desc');
      const originalText = btn?.textContent;
      if (btn) { btn.classList.add('generating'); btn.textContent = '‚ú® Generation...'; }

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const currentDesc = document.getElementById('preview-desc')?.innerHTML || document.getElementById('field-description')?.value || '';
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-ai-generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`, 'apikey': SUPABASE_ANON_KEY },
          body: JSON.stringify({ type: 'description', name, currentDescription: currentDesc, color: selectedColor })
        });
        const data = await response.json();
        if (data.result) {
          const descEl = document.getElementById('preview-desc');
          if (descEl) descEl.innerHTML = data.result;
          const hiddenDesc = document.getElementById('field-description');
          if (hiddenDesc) hiddenDesc.value = data.result;
          showToast('‚ú® Texte regenere !');
        }
      } catch (e) { showToast('Erreur: ' + e.message, 'error'); }

      if (btn) { btn.classList.remove('generating'); btn.textContent = originalText; }
    }

    // Suggest icon with AI
    async function suggestIconAI() {
      const nameEl = document.getElementById('preview-name');
      const name = nameEl?.textContent?.trim() || document.getElementById('field-name')?.value || '';
      const desc = document.getElementById('preview-desc')?.innerHTML || document.getElementById('field-description')?.value || '';
      if (!name || name === 'Nom du module') { showToast('Donne un nom au module d\'abord', 'error'); return; }

      const btn = document.getElementById('btn-ai-icon') || document.getElementById('btn-gen-icon');
      const originalText = btn?.textContent;
      if (btn) { btn.classList.add('generating'); btn.textContent = '‚ú® Recherche...'; }

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-ai-generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`, 'apikey': SUPABASE_ANON_KEY },
          body: JSON.stringify({ type: 'suggest_icon', name, description: desc, availableIcons: ICON_TYPES.map(i => i.id) })
        });
        const data = await response.json();
        if (data.result && data.result.icon_type) {
          selectedIconType = data.result.icon_type;
          if (typeof updateStudioPreview === 'function') updateStudioPreview();
          if (typeof renderIconGrid === 'function') renderIconGrid();
          if (typeof updatePreview === 'function') updatePreview();
          showToast('‚ú® Icone: ' + (ICON_TYPES.find(i => i.id === data.result.icon_type)?.name || data.result.icon_type));
        }
      } catch (e) { showToast('Erreur: ' + e.message, 'error'); }

      btn.innerHTML = originalText;
      btn.disabled = false;
    }

    // Randomize module (fun!)
    function randomizeModule() {
      const randomColor = COLOR_PRESETS[Math.floor(Math.random() * COLOR_PRESETS.length)];
      const randomIcon = ICON_TYPES[Math.floor(Math.random() * ICON_TYPES.length)];
      selectedColor = randomColor.color;
      selectedIconType = randomIcon.id;
      renderColorGrid();
      renderIconGrid();
      updatePreview();
      showToast('üé≤ Couleur: ' + randomColor.name + ', Icone: ' + randomIcon.name);
    }

    // Reset module
    function resetModule() {
      if (currentModule.id) {
        selectedColor = currentModule.color || '#22c55e';
        selectedIconType = currentModule.icon_type || 'telegram_sheets';
        selectedVisibility = currentModule.visibility || 'draft';
        document.getElementById('field-name').value = currentModule.name || '';
        document.getElementById('field-description').value = currentModule.description || '';
        document.getElementById('field-price').value = currentModule.price || '';
      } else {
        selectedColor = '#22c55e';
        selectedIconType = 'telegram_sheets';
        selectedVisibility = 'draft';
        document.getElementById('field-name').value = '';
        document.getElementById('field-slug').value = '';
        document.getElementById('field-description').value = '';
        document.getElementById('field-price').value = '';
      }
      renderColorGrid();
      renderIconGrid();
      updatePreview();
      showToast('üîÑ Module reinitialise');
    }

    function switchEditorTab(tab) {
      currentEditorTab = tab;
      document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.editor-panel').forEach(p => p.classList.remove('active'));
      document.querySelector(`.editor-tab:nth-child(${tab === 'general' ? 1 : tab === 'setup' ? 2 : 3})`)?.classList.add('active');
      document.getElementById(`panel-${tab}`)?.classList.add('active');
    }

    function copyUrl(url, btn) {
      navigator.clipboard.writeText(url);
      btn.textContent = 'Copie !';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = 'Copier';
        btn.classList.remove('copied');
      }, 2000);
    }

    function renderColorGrid() {
      const grid = document.getElementById('color-grid');
      if (!grid) return;
      grid.innerHTML = COLOR_PRESETS.map(c => `
        <div class="color-option ${selectedColor === c.color ? 'selected' : ''}" style="background:${c.color};" onclick="selectColor('${c.color}')" title="${c.name}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
      `).join('');
    }

    function renderIconGrid() {
      const grid = document.getElementById('icon-grid');
      if (!grid) return;
      grid.innerHTML = ICON_TYPES.map(icon => {
        const iconHtml = getModuleIcon(icon.id, 'white');
        return `
          <div class="icon-option ${selectedIconType === icon.id ? 'selected' : ''}" onclick="selectIcon('${icon.id}')" title="${icon.desc || ''}">
            <div class="icon-option-preview">${iconHtml}</div>
            <div class="icon-option-label">${icon.name}</div>
          </div>
        `;
      }).join('') + `
        <div class="icon-option" onclick="openAnimationGallery()" style="background:rgba(139,92,246,0.1);border-color:rgba(139,92,246,0.3);">
          <div class="icon-option-preview" style="font-size:24px;">‚ú®</div>
          <div class="icon-option-label" style="color:#a78bfa;">Galerie IA</div>
        </div>
      `;
    }

    function openAnimationGallery() {
      const modalHtml = `
        <div class="modal-overlay" id="animation-gallery-modal" onclick="if(event.target===this)closeAnimationGallery()" style="display:flex;">
          <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
              <h3>üé® Galerie d'Animations</h3>
              <button class="modal-close" onclick="closeAnimationGallery()">&times;</button>
            </div>
            <div class="modal-body">
              <div class="animation-gallery-section">
                <h4 style="font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:12px;">ANIMATIONS DISPONIBLES</h4>
                <div class="animation-gallery-grid">
                  ${ICON_TYPES.map(icon => {
                    const iconHtml = getModuleIcon(icon.id, 'white');
                    return `
                      <div class="animation-gallery-item ${selectedIconType === icon.id ? 'selected' : ''}" onclick="selectIconFromGallery('${icon.id}')">
                        <div class="animation-gallery-preview" style="background:${selectedColor}20;">${iconHtml}</div>
                        <div class="animation-gallery-name">${icon.name}</div>
                        <div class="animation-gallery-desc">${icon.desc || ''}</div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>

              <div class="animation-gallery-section" style="margin-top:24px;">
                <h4 style="font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:12px;">‚ú® GENERER AVEC CLAUDE</h4>
                <div class="ai-animation-generator">
                  <textarea class="form-textarea" id="ai-animation-prompt" placeholder="Decris ton module... Ex: Un module pour g√©rer les r√©servations de tables au restaurant, avec un calendrier et des confirmations"></textarea>
                  <button class="btn btn-ai" onclick="generateAnimationWithAI()" style="margin-top:12px;width:100%;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
                    Suggerer une animation
                  </button>
                  <div id="ai-animation-result" style="margin-top:16px;display:none;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function closeAnimationGallery() {
      document.getElementById('animation-gallery-modal')?.remove();
    }

    function selectIconFromGallery(iconType) {
      selectedIconType = iconType;
      closeAnimationGallery();
      renderIconGrid();
      updatePreview();
      showToast('Animation selectionnee: ' + ICON_TYPES.find(i => i.id === iconType)?.name);
    }

    async function generateAnimationWithAI() {
      const prompt = document.getElementById('ai-animation-prompt').value.trim();
      if (!prompt) { showToast('Decris ton module', 'error'); return; }

      const resultDiv = document.getElementById('ai-animation-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.5);"><div class="spinner" style="margin:0 auto 12px;"></div>Claude reflechit...</div>';

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const response = await fetch('https://byqfnpdcnifauhwgetcq.supabase.co/functions/v1/admin-ai-generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            type: 'animation_suggestion',
            prompt: prompt,
            available_animations: ICON_TYPES.map(i => ({ id: i.id, name: i.name, desc: i.desc }))
          })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error);

        const suggestion = data.result;
        resultDiv.innerHTML = `
          <div class="ai-suggestion-card">
            <div class="ai-suggestion-header">
              <span style="font-size:24px;">${suggestion.emoji || 'üéØ'}</span>
              <div>
                <div style="font-weight:600;">${suggestion.animation_name || 'Animation sugg√©r√©e'}</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.5);">${suggestion.animation_id || ''}</div>
              </div>
            </div>
            <p style="margin:12px 0;color:rgba(255,255,255,0.7);font-size:14px;">${suggestion.reason || ''}</p>
            ${suggestion.animation_id && ICON_TYPES.some(i => i.id === suggestion.animation_id) ? `
              <button class="btn btn-primary" onclick="selectIconFromGallery('${suggestion.animation_id}')" style="width:100%;">
                Utiliser cette animation
              </button>
            ` : `
              <div style="padding:12px;background:rgba(255,107,53,0.1);border-radius:8px;font-size:13px;color:#FF6B35;">
                üí° Animation personnalis√©e sugg√©r√©e - contacte le dev pour la cr√©er !
              </div>
            `}
          </div>
        `;
      } catch (e) {
        resultDiv.innerHTML = '<div style="color:#f87171;">Erreur: ' + e.message + '</div>';
      }
    }

    function renderBadgeGrid() {
      const grid = document.getElementById('badge-grid');
      if (!grid) return;
      grid.innerHTML = BADGE_OPTIONS.map(b => `
        <div class="badge-option ${selectedBadge === b.id ? 'selected' : ''}" onclick="selectBadge(${b.id === null ? 'null' : `'${b.id}'`})">${b.name}</div>
      `).join('');
    }

    function selectColor(color) { selectedColor = color; if(typeof renderColorBar==='function')renderColorBar(); if(typeof renderColorGrid==='function')renderColorGrid(); if(typeof renderIconBar==='function')renderIconBar(); if(typeof renderIconGrid==='function')renderIconGrid(); updatePreview(); }
    function selectIcon(iconType) { selectedIconType = iconType; if(typeof renderIconBar==='function')renderIconBar(); if(typeof renderIconGrid==='function')renderIconGrid(); updatePreview(); }

    function updatePreview() {
      const name = document.getElementById('field-name')?.value || 'Nom';
      const desc = document.getElementById('field-description')?.value || '';
      const price = document.getElementById('field-price')?.value || '29';
      const trial = document.getElementById('field-trial')?.value || '7';

      const card = document.getElementById('preview-card');
      if (!card) return;

      // Card background
      card.style.background = `linear-gradient(145deg, ${selectedColor}35, ${selectedColor}15)`;
      card.style.border = `2px solid ${selectedColor}50`;

      // Icon
      const icon = document.getElementById('preview-icon');
      if (icon) {
        icon.style.background = `linear-gradient(180deg, ${selectedColor}, ${darkenColorHex(selectedColor)})`;
        icon.innerHTML = getModuleIcon(selectedIconType, 'white');
      }

      // Name
      const nameEl = document.getElementById('preview-name');
      if (nameEl) nameEl.textContent = name;

      // Description (with HTML support)
      const descEl = document.getElementById('preview-desc');
      if (descEl) descEl.innerHTML = desc || '<span style="opacity:0.4;">Ajoute une description...</span>';

      // Badge
      const badgeEl = document.getElementById('preview-badge');
      if (badgeEl) {
        if (selectedBadge && selectedBadge !== 'none') {
          badgeEl.style.display = 'block';
          const badgeStyles = {
            'nouveau': { bg: 'linear-gradient(135deg, #22c55e, #4ade80)', text: 'Nouveau' },
            'populaire': { bg: 'linear-gradient(135deg, #f59e0b, #fbbf24)', text: 'Populaire' },
            'promo': { bg: 'linear-gradient(135deg, #ef4444, #f87171)', text: 'Promo' }
          };
          const style = badgeStyles[selectedBadge] || badgeStyles['nouveau'];
          badgeEl.style.background = style.bg;
          badgeEl.style.color = 'white';
          badgeEl.textContent = style.text;
        } else {
          badgeEl.style.display = 'none';
        }
      }

      // Price (big)
      const priceBig = document.getElementById('preview-price-big');
      if (priceBig) priceBig.textContent = price + '‚Ç¨';

      // Trial
      const trialText = document.getElementById('preview-trial-text');
      if (trialText) trialText.textContent = trial + ' jours d\'essai';

      // Also update bars
      if (typeof renderColorBar === 'function') renderColorBar();
    }

    function darkenColorHex(hex, amount = 30) {
      const num = parseInt(hex.replace('#', ''), 16);
      const r = Math.max(0, (num >> 16) - amount);
      const g = Math.max(0, ((num >> 8) & 0xFF) - amount);
      const b = Math.max(0, (num & 0xFF) - amount);
      return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
    }

    // Setup Steps
    function renderSetupSteps() {
      const container = document.getElementById('setup-steps-list');
      if (!container) return;

      if (currentSetupSteps.length === 0) {
        container.innerHTML = '<div class="setup-steps-empty">Aucune etape - Ajoute des etapes ci-dessous</div>';
      } else {
        container.innerHTML = currentSetupSteps.map((step, i) => {
          const type = SETUP_STEP_TYPES.find(t => t.id === step.type) || SETUP_STEP_TYPES[0];
          return `
            <div class="setup-step" draggable="true" data-index="${i}">
              <div class="setup-step-handle">‚ãÆ‚ãÆ</div>
              <div class="setup-step-icon" style="background:${type.color}20;color:${type.color};">${type.icon}</div>
              <div class="setup-step-info">
                <div class="setup-step-title">${step.title || type.title}</div>
                <div class="setup-step-type">${type.name}</div>
              </div>
              <button class="setup-step-delete" onclick="removeSetupStep(${i})">‚úï</button>
            </div>
          `;
        }).join('');
      }
    }

    function addSetupStep(typeId) {
      const type = SETUP_STEP_TYPES.find(t => t.id === typeId);
      if (!type) return;
      currentSetupSteps.push({ id: `${typeId}_${Date.now()}`, type: typeId, title: type.title, description: type.desc });
      renderSetupSteps();
      showToast(`Etape "${type.name}" ajoutee`);
    }

    function removeSetupStep(index) {
      currentSetupSteps.splice(index, 1);
      renderSetupSteps();
    }

    async function saveModule() {
      const isNew = !currentModule.id;
      const slug = document.getElementById('field-slug')?.value?.trim() || '';
      // Get name from contenteditable or hidden field
      const nameEl = document.getElementById('preview-name');
      let name = nameEl?.textContent?.trim() || document.getElementById('field-name')?.value?.trim() || '';
      if (name === 'Nom du module') name = '';

      // Auto-generate slug if empty
      let finalSlug = slug;
      if (!finalSlug && name) {
        finalSlug = name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
      }

      if (!name || !finalSlug) {
        showToast('Nom requis', 'error');
        return;
      }

      // Get description from contenteditable or hidden field
      const descEl = document.getElementById('preview-desc');
      let description = descEl?.innerHTML || document.getElementById('field-description')?.value || '';
      if (description === 'Clique pour ajouter une description...') description = '';

      const data = {
        slug: finalSlug,
        name,
        description,
        color: selectedColor,
        icon_type: selectedIconType,
        status: 'available',
        visibility: selectedVisibility,
        badge: selectedBadge,
        price: document.getElementById('field-price')?.value || null,
        trial_days: parseInt(document.getElementById('field-trial')?.value) || 7,
        stripe_price_id: document.getElementById('field-stripe')?.value || null,
        setup_url: `/${finalSlug}/setup/`,
        settings_url: `/?soldat=${finalSlug}`,
        categories: selectedCategories.length > 0 ? selectedCategories : null,
        setup_steps: currentSetupSteps || []
      };

      let error;
      if (isNew) {
        data.sort_order = modules.length;
        const res = await supabaseClient.from('modules').insert(data);
        error = res.error;
      } else {
        const res = await supabaseClient.from('modules').update(data).eq('id', currentModule.id);
        error = res.error;
      }

      if (error) {
        showToast('Erreur: ' + error.message, 'error');
        return;
      }

      showToast('Module enregistre !');
      await loadModules();
      currentModule = null;
      renderModulesTab();
    }

    async function deleteModule() {
      if (!confirm('Supprimer ce module ?')) return;
      const { error } = await supabaseClient.from('modules').delete().eq('id', currentModule.id);
      if (error) { showToast('Erreur: ' + error.message, 'error'); return; }
      showToast('Module supprime');
      await loadModules();
      currentModule = null;
      renderModulesTab();
    }

    // AI Generation
    async function generateWithAI() {
      const prompt = document.getElementById('ai-prompt').value.trim();
      if (!prompt) { showToast('Decris ton soldat d\'abord', 'error'); return; }

      const btn = document.querySelector('.ai-suggest-btn');
      btn.innerHTML = '<div class="spinner" style="width:12px;height:12px;border-width:2px;"></div>';
      btn.disabled = true;

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-ai-generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ type: 'module_full', prompt })
        });

        const data = await response.json();
        if (data.result && typeof data.result === 'object') {
          if (data.result.name) document.getElementById('field-name').value = data.result.name;
          if (data.result.name) document.getElementById('field-slug').value = data.result.name.toLowerCase().replace(/[^a-z]/g, '_');
          if (data.result.description) document.getElementById('field-description').value = data.result.description;
          if (data.result.color) { selectedColor = data.result.color; renderColorGrid(); renderIconGrid(); }
          if (data.result.icon_type) { selectedIconType = data.result.icon_type; renderIconGrid(); }
          if (data.result.price) document.getElementById('field-price').value = data.result.price;
          updatePreview();
          showToast('Module genere par Claude !');
        }
      } catch (e) {
        showToast('Erreur IA: ' + e.message, 'error');
      }

      btn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg> Generer`;
      btn.disabled = false;
    }

    // ==================
    // OTHER TABS (simplified)
    // ==================
    function renderUsersTab() {
      document.getElementById('header-actions').innerHTML = `<input type="text" class="search-input" placeholder="Rechercher..." oninput="filterUsers(this.value)">`;
      document.getElementById('main-content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">${users.length}</div><div class="stat-label">Utilisateurs</div></div>
          <div class="stat-card"><div class="stat-value">${users.filter(u => u.subscriptions?.some(s => s.is_tester)).length}</div><div class="stat-label">Testeurs</div></div>
          <div class="stat-card"><div class="stat-value">${users.filter(u => u.telegram).length}</div><div class="stat-label">Telegram</div></div>
        </div>
        <div class="table-container">
          <table class="users-table">
            <thead><tr><th>Utilisateur</th><th>Modules</th><th>Telegram</th><th>Actions</th></tr></thead>
            <tbody id="users-tbody">${renderUsersRows(users)}</tbody>
          </table>
        </div>
      `;
    }

    function renderUsersRows(list) {
      if (!list.length) return '<tr><td colspan="4" style="text-align:center;padding:40px;color:rgba(255,255,255,0.4);">Aucun utilisateur</td></tr>';
      return list.map(u => {
        const badges = (u.subscriptions || []).map(s => `<span class="user-badge ${s.is_tester ? 'tester' : s.status}">${s.module_name}${s.is_tester ? ' üß™' : ''}</span>`).join('') || '-';
        return `<tr>
          <td><div class="user-cell"><img src="${u.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.full_name || 'U')}&background=FF6B35&color=fff`}" class="user-avatar"><div><div class="user-name">${u.full_name || 'Utilisateur'}</div><div class="user-email">${u.email || ''}</div></div></div></td>
          <td><div class="user-badges">${badges}</div></td>
          <td>${u.telegram ? '‚úÖ' : '‚Äî'}</td>
          <td><button class="btn btn-sm btn-secondary" onclick="openTesterModal('${u.user_id}', '${u.full_name || u.email || 'Utilisateur'}')">Gerer Testeur</button></td>
        </tr>`;
      }).join('');
    }

    function filterUsers(query) {
      const q = query.toLowerCase();
      const filtered = users.filter(u => (u.email || '').toLowerCase().includes(q) || (u.full_name || '').toLowerCase().includes(q));
      document.getElementById('users-tbody').innerHTML = renderUsersRows(filtered);
    }

    let testerModalUserId = null;

    function openTesterModal(userId, userName) {
      testerModalUserId = userId;
      const user = users.find(u => u.user_id === userId);
      const userSubs = user?.subscriptions || [];

      const modalHtml = `
        <div class="modal-overlay" id="tester-modal" onclick="if(event.target===this)closeTesterModal()">
          <div class="modal-content">
            <div class="modal-header">
              <h3>Gerer les acces testeur</h3>
              <button class="modal-close" onclick="closeTesterModal()">&times;</button>
            </div>
            <div class="modal-body">
              <p style="color:rgba(255,255,255,0.6);margin-bottom:16px;">Utilisateur: <strong>${userName}</strong></p>
              <div class="tester-modules-list">
                ${modules.map(m => {
                  const sub = userSubs.find(s => s.module_name === m.name || s.module_slug === m.slug);
                  const isTester = sub?.is_tester || false;
                  return `
                    <div class="tester-module-item">
                      <div class="tester-module-info">
                        <div class="tester-module-color" style="background:${m.color};"></div>
                        <span>${m.name}</span>
                      </div>
                      <label class="toggle-switch">
                        <input type="checkbox" ${isTester ? 'checked' : ''} onchange="toggleModuleTester('${userId}', '${m.slug}', '${m.name}', this.checked)">
                        <span class="toggle-slider"></span>
                      </label>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function closeTesterModal() {
      document.getElementById('tester-modal')?.remove();
      testerModalUserId = null;
    }

    async function toggleModuleTester(userId, moduleSlug, moduleName, setTester) {
      const { data: existing } = await supabaseClient
        .from('subscriptions')
        .select('id')
        .eq('user_id', userId)
        .or(`module_name.eq.${moduleName},module_slug.eq.${moduleSlug}`)
        .maybeSingle();

      if (existing) {
        await supabaseClient
          .from('subscriptions')
          .update({ is_tester: setTester, status: setTester ? 'tester' : 'canceled' })
          .eq('id', existing.id);
      } else if (setTester) {
        await supabaseClient
          .from('subscriptions')
          .insert({
            user_id: userId,
            module_name: moduleName,
            module_slug: moduleSlug,
            is_tester: true,
            status: 'tester'
          });
      }

      showToast(setTester ? `Testeur ${moduleName} ajoute` : `Testeur ${moduleName} retire`);
      await loadUsers();
    }

    function renderTelegramTab() {
      document.getElementById('header-actions').innerHTML = `<button class="btn btn-primary" onclick="showToast('Bientot disponible', 'info')">+ Nouveau message</button>`;
      document.getElementById('main-content').innerHTML = `
        <div class="card">
          <div class="card-header"><div class="card-title">Messages du bot Telegram</div></div>
          <div class="empty-state">
            <div class="empty-state-icon">üì±</div>
            <p>Gestion des messages Telegram bientot disponible</p>
          </div>
        </div>
      `;
    }

    function renderSupportTab() {
      const statusColors = { open: '#4ade80', pending: '#fbbf24', resolved: '#60a5fa', closed: '#6b7280' };
      const statusLabels = { open: 'Ouvert', pending: 'En attente', resolved: 'Resolu', closed: 'Ferme' };

      document.getElementById('header-actions').innerHTML = currentConversation ? `
        <select class="form-select" style="width:auto;" onchange="updateConversationStatus(this.value)">
          <option value="open" ${currentConversation.status === 'open' ? 'selected' : ''}>üü¢ Ouvert</option>
          <option value="pending" ${currentConversation.status === 'pending' ? 'selected' : ''}>üü° En attente</option>
          <option value="resolved" ${currentConversation.status === 'resolved' ? 'selected' : ''}>üîµ Resolu</option>
          <option value="closed" ${currentConversation.status === 'closed' ? 'selected' : ''}>‚ö´ Ferme</option>
        </select>
      ` : '';

      document.getElementById('main-content').innerHTML = `
        <div class="chat-container">
          <div class="chat-sidebar">
            <div class="chat-sidebar-header">
              <input type="text" class="search-input" placeholder="Rechercher..." style="width:100%;" oninput="filterConversations(this.value)">
            </div>
            <div class="chat-list" id="chat-list">
              ${conversations.length === 0 ? '<div class="empty-state" style="padding:40px;text-align:center;"><p style="color:rgba(255,255,255,0.4);">Aucune conversation</p></div>' : conversations.map(c => `
                <div class="chat-item ${c.unread_count > 0 ? 'unread' : ''} ${currentConversation?.id === c.id ? 'active' : ''}" onclick="openConversation('${c.id}')">
                  <div class="chat-item-header">
                    <span class="chat-item-name">${c.user_name || c.user_email || 'Utilisateur'}</span>
                    <span class="chat-item-time">${formatTime(c.last_message_at)}</span>
                  </div>
                  <div class="chat-item-preview">
                    ${c.unread_count > 0 ? `<span style="background:#FF6B35;color:white;padding:1px 6px;border-radius:8px;font-size:10px;margin-right:6px;">${c.unread_count}</span>` : ''}
                    ${c.last_message || c.subject || 'Nouvelle conversation'}
                  </div>
                  <div style="margin-top:6px;"><span style="font-size:10px;padding:2px 8px;border-radius:6px;background:${statusColors[c.status]}20;color:${statusColors[c.status]};">${statusLabels[c.status]}</span></div>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="chat-main">
            ${currentConversation ? `
              <div class="chat-header">
                <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#FF6B35,#FF8B5E);display:flex;align-items:center;justify-content:center;font-weight:700;">${(currentConversation.user_name || currentConversation.user_email || 'U')[0].toUpperCase()}</div>
                <div>
                  <div style="font-weight:600;">${currentConversation.user_name || currentConversation.user_email || 'Utilisateur'}</div>
                  <div style="font-size:12px;color:rgba(255,255,255,0.4);">${currentConversation.subject || 'Conversation'}</div>
                </div>
                ${currentConversation.module_slug ? `<span style="margin-left:auto;padding:4px 12px;background:rgba(255,107,53,0.15);border-radius:8px;font-size:12px;color:#FF6B35;">${currentConversation.module_slug}</span>` : ''}
              </div>
              <div class="chat-messages" id="chat-messages">
                ${currentMessages.length === 0 ? '<div style="text-align:center;color:rgba(255,255,255,0.3);padding:40px;">Aucun message</div>' : currentMessages.map(m => `
                  <div class="chat-message ${m.sender_type === 'admin' ? 'outgoing' : 'incoming'}">
                    <div class="chat-bubble">${m.content}</div>
                    <div class="chat-message-time" style="text-align:${m.sender_type === 'admin' ? 'right' : 'left'};">${formatTime(m.created_at)}</div>
                  </div>
                `).join('')}
              </div>
              <div class="chat-input-area">
                <textarea class="chat-input" id="chat-input" placeholder="Tapez votre message..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendSupportMessage();}"></textarea>
                <button class="btn btn-primary" onclick="sendSupportMessage()">Envoyer</button>
              </div>
            ` : `
              <div class="chat-empty">
                <div style="text-align:center;">
                  <div style="font-size:48px;margin-bottom:16px;">üí¨</div>
                  <div style="color:rgba(255,255,255,0.5);">Selectionnez une conversation</div>
                </div>
              </div>
            `}
          </div>
        </div>
      `;

      // Scroll to bottom of messages
      if (currentConversation) {
        const messagesDiv = document.getElementById('chat-messages');
        if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    }

    function formatTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      if (diff < 60000) return 'A l\'instant';
      if (diff < 3600000) return Math.floor(diff/60000) + 'min';
      if (diff < 86400000) return date.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'});
      return date.toLocaleDateString('fr-FR', {day:'numeric',month:'short'});
    }

    function filterConversations(query) {
      const items = document.querySelectorAll('.chat-item');
      items.forEach(item => {
        const name = item.querySelector('.chat-item-name')?.textContent.toLowerCase() || '';
        const preview = item.querySelector('.chat-item-preview')?.textContent.toLowerCase() || '';
        item.style.display = (name.includes(query.toLowerCase()) || preview.includes(query.toLowerCase())) ? 'block' : 'none';
      });
    }

    function renderAnalyticsTab() {
      document.getElementById('header-actions').innerHTML = `<button class="btn btn-secondary" onclick="loadAnalytics().then(renderAnalyticsTab)">Actualiser</button>`;
      document.getElementById('main-content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card live"><div class="stat-value">${analytics.online || 0}</div><div class="stat-label">En ligne</div></div>
          <div class="stat-card"><div class="stat-value">${analytics.today || 0}</div><div class="stat-label">Visites aujourd'hui</div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Dernieres visites</div></div>
          <div class="activity-feed">
            ${(analytics.recent || []).map(v => {
              const time = new Date(v.created_at);
              const isRecent = (Date.now() - time.getTime()) < 5 * 60 * 1000;
              return `<div class="activity-item"><div class="activity-icon" style="background:${isRecent ? 'rgba(34,197,94,0.15)' : 'rgba(255,107,53,0.15)'};">${isRecent ? 'üü¢' : 'üìç'}</div><div class="activity-content"><div class="activity-text">${v.page_path === '/' ? 'Accueil' : v.page_path}</div><div class="activity-time">${time.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}</div></div></div>`;
            }).join('') || '<div class="empty-state"><p>Aucune visite</p></div>'}
          </div>
        </div>
      `;
    }

    function renderSettingsTab() {
      document.getElementById('header-actions').innerHTML = '';
      document.getElementById('main-content').innerHTML = `
        <div class="settings-section">
          <div class="settings-title">Administrateurs</div>
          <div class="settings-card">
            ${adminUsers.map(a => `
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">${a.email}</div>
                  <div class="settings-item-desc">${a.role === 'super_admin' ? 'Super Admin' : 'Admin'}</div>
                </div>
                ${a.role !== 'super_admin' ? `<button class="btn btn-sm btn-danger" onclick="removeAdmin('${a.id}')">Retirer</button>` : ''}
              </div>
            `).join('')}
            <div class="settings-item">
              <input type="email" class="form-input" id="new-admin-email" placeholder="Email du nouvel admin" style="flex:1;">
              <button class="btn btn-sm btn-primary" onclick="addAdmin()">Ajouter</button>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-title">Liens utiles</div>
          <div class="settings-card">
            <div class="settings-item">
              <div class="settings-item-info"><div class="settings-item-label">Supabase Dashboard</div></div>
              <button class="btn btn-sm btn-secondary" onclick="window.open('https://supabase.com/dashboard/project/byqfnpdcnifauhwgetcq', '_blank')">Ouvrir</button>
            </div>
            <div class="settings-item">
              <div class="settings-item-info"><div class="settings-item-label">Stripe Dashboard</div></div>
              <button class="btn btn-sm btn-secondary" onclick="window.open('https://dashboard.stripe.com', '_blank')">Ouvrir</button>
            </div>
            <div class="settings-item">
              <div class="settings-item-info"><div class="settings-item-label">Render (Bot)</div></div>
              <button class="btn btn-sm btn-secondary" onclick="window.open('https://dashboard.render.com', '_blank')">Ouvrir</button>
            </div>
            <div class="settings-item">
              <div class="settings-item-info"><div class="settings-item-label">GitHub (App)</div></div>
              <button class="btn btn-sm btn-secondary" onclick="window.open('https://github.com/iarmy-dev/iarmy-app', '_blank')">Ouvrir</button>
            </div>
          </div>
        </div>
      `;
    }

    async function addAdmin() {
      const email = document.getElementById('new-admin-email').value.trim();
      if (!email) { showToast('Email requis', 'error'); return; }

      const { error } = await supabaseClient.from('admin_users').insert({ email, role: 'admin' });
      if (error) { showToast('Erreur: ' + error.message, 'error'); return; }

      showToast('Admin ajoute !');
      await loadAdminUsers();
      renderSettingsTab();
    }

    async function removeAdmin(id) {
      if (!confirm('Retirer cet admin ?')) return;
      await supabaseClient.from('admin_users').delete().eq('id', id);
      showToast('Admin retire');
      await loadAdminUsers();
      renderSettingsTab();
    }

    // ==================
    // UTILS
    // ==================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (type === 'error' ? ' error' : type === 'info' ? ' info' : '');
      setTimeout(() => toast.className = 'toast', 3000);
    }
  </script>
</body>
</html>
