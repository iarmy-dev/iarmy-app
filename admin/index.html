<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23FF6B35'/%3E%3Ctext x='50' y='65' font-family='Arial' font-size='40' font-weight='bold' fill='white' text-anchor='middle'%3EA%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a0a; color: white; min-height: 100vh; }

    /* Layout */
    .app { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: #0f0f0f;
      border-right: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 18px;
    }
    .sidebar-logo span { color: #FF6B35; }

    /* Nav */
    .nav { padding: 12px; flex: 1; }
    .nav-section { margin-bottom: 24px; }
    .nav-title { font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1px; padding: 8px 12px; }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      color: rgba(255,255,255,0.6);
    }
    .nav-item:hover { background: rgba(255,255,255,0.04); color: white; }
    .nav-item.active { background: rgba(255,107,53,0.15); color: #FF6B35; }
    .nav-item svg { width: 18px; height: 18px; }
    .nav-badge { margin-left: auto; background: rgba(255,107,53,0.2); color: #FF6B35; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }

    /* Main */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .main-header {
      padding: 20px 32px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .main-title { font-size: 20px; font-weight: 700; }
    .main-content { flex: 1; overflow-y: auto; padding: 32px; }

    /* Buttons */
    .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: linear-gradient(135deg, #FF6B35, #FF8B5E); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,107,53,0.3); }
    .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .btn-danger { background: rgba(239,68,68,0.1); color: #f87171; }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }
    .btn-ai { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; }
    .btn-ai:hover { box-shadow: 0 8px 20px rgba(139,92,246,0.3); }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 20px; position: relative; }
    .stat-value { font-size: 28px; font-weight: 700; color: #FF6B35; }
    .stat-label { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 4px; }
    .stat-card.live { border-color: rgba(34,197,94,0.3); }
    .stat-card.live .stat-value { color: #4ade80; }
    .stat-card.live::after { content: ''; position: absolute; top: 16px; right: 16px; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Module Editor Split */
    .editor-split { display: grid; grid-template-columns: 1fr 360px; gap: 32px; }
    @media (max-width: 1000px) { .editor-split { grid-template-columns: 1fr; } }

    /* Form */
    .form-section { margin-bottom: 28px; }
    .form-section-title { font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.6); margin-bottom: 8px; }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      color: white;
      font-size: 14px;
      transition: all 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: rgba(255,107,53,0.5);
      background: rgba(255,255,255,0.06);
    }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-hint { font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 6px; }

    /* AI Input */
    .ai-input-wrapper { position: relative; }
    .ai-input-wrapper .form-textarea { padding-right: 100px; }
    .ai-suggest-btn { position: absolute; right: 8px; bottom: 8px; padding: 6px 12px; background: linear-gradient(135deg, #8b5cf6, #a78bfa); border: none; border-radius: 8px; color: white; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .ai-suggest-btn:hover { opacity: 0.9; }

    /* Color Grid */
    .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
    .color-option {
      aspect-ratio: 1;
      border-radius: 10px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .color-option:hover { transform: scale(1.1); }
    .color-option.selected { border-color: white; box-shadow: 0 0 20px currentColor; }
    .color-option svg { opacity: 0; }
    .color-option.selected svg { opacity: 1; }

    /* Icon Grid */
    .icon-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .icon-option {
      padding: 12px;
      background: rgba(255,255,255,0.02);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .icon-option:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.15); }
    .icon-option.selected { border-color: #FF6B35; background: rgba(255,107,53,0.1); }
    .icon-option-preview { height: 36px; display: flex; align-items: center; justify-content: center; margin-bottom: 6px; }
    .icon-option-label { font-size: 10px; color: rgba(255,255,255,0.5); }

    /* Badge Options */
    .badge-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .badge-option {
      padding: 8px 16px;
      background: rgba(255,255,255,0.04);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .badge-option:hover { background: rgba(255,255,255,0.08); }
    .badge-option.selected { border-color: #FF6B35; background: rgba(255,107,53,0.15); color: #FF6B35; }

    /* Preview Panel */
    .preview-panel {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 20px;
      padding: 24px;
      position: sticky;
      top: 32px;
    }
    .preview-title { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; text-align: center; }

    /* Preview Card - exactement comme sur le site */
    .preview-card {
      width: 160px;
      height: 160px;
      border-radius: 20px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin: 0 auto 20px;
      position: relative;
      transition: all 0.3s;
    }
    .preview-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .preview-badge.nouveau { background: linear-gradient(135deg, #22c55e, #4ade80); color: white; }
    .preview-badge.populaire { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
    .preview-badge.promo { background: linear-gradient(135deg, #ef4444, #f87171); color: white; }
    .preview-badge.beta { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; }
    .preview-visibility {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 9px;
      font-weight: 600;
    }
    .preview-visibility.draft { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .preview-visibility.beta { background: rgba(168,85,247,0.2); color: #c084fc; }
    .preview-visibility.public { background: rgba(34,197,94,0.2); color: #4ade80; }
    .preview-icon { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
    .preview-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .preview-desc { font-size: 10px; color: rgba(255,255,255,0.5); }

    .preview-info { background: rgba(255,255,255,0.04); border-radius: 12px; padding: 16px; }
    .preview-info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 12px; }
    .preview-info-row:last-child { border-bottom: none; }
    .preview-info-label { color: rgba(255,255,255,0.4); }
    .preview-info-value { font-weight: 500; }

    /* Mini icon animations */
    .mini-sheet { width: 28px; height: 28px; background: rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden; }
    .mini-sheet-row { display: flex; height: 7px; }
    .mini-sheet-cell { flex: 1; background: rgba(255,255,255,0.1); margin: 1px; border-radius: 1px; }
    .mini-sheet-cell.fill { animation: cellFill 2s ease-in-out infinite; }
    .mini-sheet-cell.fill-1 { animation-delay: 0s; }
    .mini-sheet-cell.fill-2 { animation-delay: 0.3s; }
    .mini-sheet-cell.fill-3 { animation-delay: 0.6s; }
    .mini-sheet-cell.fill-4 { animation-delay: 0.9s; }
    .mini-sheet-cell.fill-5 { animation-delay: 1.2s; }
    .mini-sheet-cell.fill-6 { animation-delay: 1.5s; }
    @keyframes cellFill { 0%, 40% { background: rgba(255,255,255,0.1); } 50%, 90% { background: #4ade80; } 100% { background: rgba(255,255,255,0.1); } }

    .mini-stock { width: 32px; height: 24px; display: flex; align-items: flex-end; justify-content: center; gap: 2px; position: relative; }
    .mini-bottle { position: relative; width: 10px; height: 20px; }
    .mini-bottle-body { position: absolute; bottom: 0; width: 10px; height: 14px; background: rgba(6,182,212,0.15); border: 1.5px solid #06B6D4; border-radius: 2px; overflow: hidden; }
    .mini-bottle-neck { position: absolute; bottom: 13px; left: 2.5px; width: 5px; height: 5px; background: rgba(6,182,212,0.15); border: 1.5px solid #06B6D4; border-bottom: none; border-radius: 2px 2px 0 0; }
    .mini-bottle-cap { position: absolute; bottom: 17px; left: 1.5px; width: 7px; height: 3px; background: #06B6D4; border-radius: 1px; }
    .mini-bottle-fill { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, #22D3EE, #06B6D4); border-radius: 0 0 1px 1px; }
    .mini-bottle-1 .mini-bottle-fill { animation: bottleEmpty 3s ease-in-out infinite; }
    .mini-bottle-2 .mini-bottle-fill { animation: bottleFill 3s ease-in-out infinite; }
    @keyframes bottleEmpty { 0%, 10% { height: 75%; } 45%, 55% { height: 15%; } 90%, 100% { height: 75%; } }
    @keyframes bottleFill { 0%, 10% { height: 15%; } 45%, 55% { height: 75%; } 90%, 100% { height: 15%; } }
    .mini-stock-count { position: absolute; top: -2px; right: -4px; width: 10px; height: 10px; background: #06B6D4; border-radius: 50%; font-size: 6px; font-weight: 700; color: #083344; display: flex; align-items: center; justify-content: center; animation: countPop 3s ease-in-out infinite; }
    @keyframes countPop { 0%, 35% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.2); } 60%, 80% { opacity: 1; transform: scale(1); } 90%, 100% { opacity: 0; transform: scale(0.8); } }

    .mini-paie { width: 28px; height: 24px; display: flex; align-items: center; justify-content: center; position: relative; }
    .mini-paie-people { display: flex; align-items: flex-end; gap: 1px; position: absolute; animation: paiePeopleToEuro 3.5s ease-in-out infinite; }
    .mini-paie-person { display: flex; flex-direction: column; align-items: center; }
    .mini-paie-head { width: 4px; height: 4px; border-radius: 50%; background: white; margin-bottom: 1px; }
    .mini-paie-body { width: 6px; height: 6px; background: white; border-radius: 2px 2px 1px 1px; }
    @keyframes paiePeopleToEuro { 0%, 50% { opacity: 1; } 60%, 90% { opacity: 0; } 100% { opacity: 1; } }
    .mini-paie-euro { position: absolute; font-size: 16px; font-weight: 800; color: white; opacity: 0; animation: paieEuroAppear 3.5s ease-in-out infinite; }
    @keyframes paieEuroAppear { 0%, 50% { opacity: 0; transform: scale(0.5); } 65% { opacity: 1; transform: scale(1.1); } 75%, 85% { opacity: 1; transform: scale(1); } 95%, 100% { opacity: 0; transform: scale(0.8); } }

    /* Modules List */
    .modules-list { display: flex; flex-direction: column; gap: 8px; }
    .module-list-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .module-list-item:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); }
    .module-list-item.active { background: rgba(255,107,53,0.1); border-color: rgba(255,107,53,0.3); }
    .module-list-color { width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0; }
    .module-list-info { flex: 1; min-width: 0; }
    .module-list-name { font-size: 14px; font-weight: 500; margin-bottom: 2px; display: flex; align-items: center; gap: 8px; }
    .module-list-meta { font-size: 11px; color: rgba(255,255,255,0.4); display: flex; gap: 12px; }
    .module-list-badge { padding: 2px 8px; border-radius: 6px; font-size: 9px; font-weight: 600; text-transform: uppercase; }
    .module-list-badge.draft { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .module-list-badge.beta { background: rgba(168,85,247,0.15); color: #c084fc; }
    .module-list-badge.public { background: rgba(34,197,94,0.15); color: #4ade80; }

    /* Users Table */
    .users-table { width: 100%; border-collapse: collapse; }
    .users-table th { text-align: left; padding: 12px 16px; background: rgba(255,255,255,0.02); color: rgba(255,255,255,0.5); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .users-table td { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
    .users-table tr:hover td { background: rgba(255,255,255,0.02); }
    .user-cell { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,107,53,0.3); }
    .user-name { font-weight: 500; font-size: 13px; }
    .user-email { font-size: 11px; color: rgba(255,255,255,0.4); }
    .user-badges { display: flex; flex-wrap: wrap; gap: 4px; }
    .user-badge { font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 500; }
    .user-badge.active { background: rgba(34,197,94,0.15); color: #4ade80; }
    .user-badge.tester { background: rgba(168,85,247,0.15); color: #c084fc; }
    .user-badge.trialing { background: rgba(59,130,246,0.15); color: #60a5fa; }

    /* Analytics */
    .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 900px) { .analytics-grid { grid-template-columns: 1fr; } }
    .analytics-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 20px; }
    .analytics-card h3 { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 16px; }
    .visits-list { max-height: 280px; overflow-y: auto; }
    .visit-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 12px; }
    .visit-item:last-child { border-bottom: none; }
    .visit-dot { width: 8px; height: 8px; border-radius: 50%; background: #FF6B35; }
    .visit-dot.online { background: #4ade80; animation: pulse 2s infinite; }
    .visit-page { flex: 1; }
    .visit-time { color: rgba(255,255,255,0.4); }

    /* Search */
    .search-input { width: 100%; max-width: 320px; padding: 10px 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; color: white; font-size: 13px; }
    .search-input:focus { outline: none; border-color: #FF6B35; }
    .search-input::placeholder { color: rgba(255,255,255,0.3); }

    /* Auth Screen */
    .auth-screen { position: fixed; inset: 0; background: #0a0a0a; display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .auth-box { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 24px; padding: 48px; max-width: 400px; width: 90%; text-align: center; }
    .auth-icon { width: 64px; height: 64px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 18px; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center; }
    .auth-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
    .auth-subtitle { color: rgba(255,255,255,0.4); font-size: 14px; margin-bottom: 32px; }
    .auth-btn { width: 100%; padding: 16px 24px; background: white; border: none; border-radius: 14px; color: #333; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; }
    .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255,255,255,0.2); }
    .auth-error { color: #ef4444; margin-top: 16px; font-size: 13px; display: none; }
    .auth-loading { color: rgba(255,255,255,0.5); margin-top: 16px; font-size: 13px; display: none; }

    /* Toast */
    .toast { position: fixed; top: 20px; right: 20px; padding: 14px 24px; background: rgba(34,197,94,0.9); backdrop-filter: blur(12px); border-radius: 12px; color: white; font-size: 13px; font-weight: 500; opacity: 0; transform: translateY(-20px); transition: all 0.3s; z-index: 10000; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: rgba(239,68,68,0.9); }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.4); }
    .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.3; }
    .empty-state p { font-size: 14px; }

    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; padding: 60px; }
    .spinner { width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.1); border-top-color: #FF6B35; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Setup Builder */
    .setup-builder { margin-top: 8px; }
    .setup-steps { display: flex; flex-direction: column; gap: 8px; min-height: 60px; padding: 12px; background: rgba(255,255,255,0.02); border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px; }
    .setup-steps.drag-over { border-color: #FF6B35; background: rgba(255,107,53,0.05); }
    .setup-steps-empty { text-align: center; padding: 20px; color: rgba(255,255,255,0.3); font-size: 12px; }

    .setup-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      cursor: grab;
      transition: all 0.2s;
    }
    .setup-step:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.15); }
    .setup-step.dragging { opacity: 0.5; transform: scale(0.98); }
    .setup-step.drag-target { border-color: #FF6B35; box-shadow: 0 0 0 2px rgba(255,107,53,0.2); }

    .setup-step-handle { color: rgba(255,255,255,0.3); cursor: grab; }
    .setup-step-handle:active { cursor: grabbing; }
    .setup-step-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .setup-step-info { flex: 1; min-width: 0; }
    .setup-step-title { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
    .setup-step-type { font-size: 10px; color: rgba(255,255,255,0.4); }
    .setup-step-delete { padding: 6px; border-radius: 6px; background: transparent; border: none; color: rgba(255,255,255,0.3); cursor: pointer; transition: all 0.2s; }
    .setup-step-delete:hover { background: rgba(239,68,68,0.1); color: #f87171; }

    .setup-add-bar { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .setup-add-btn {
      padding: 8px 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      color: rgba(255,255,255,0.6);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .setup-add-btn:hover { background: rgba(255,255,255,0.08); color: white; border-color: rgba(255,255,255,0.15); }
    .setup-add-btn .step-icon { font-size: 12px; }

    /* Setup Preview */
    .setup-preview { margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.06); }
    .setup-preview-title { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }
    .setup-preview-flow { display: flex; flex-direction: column; gap: 0; }
    .setup-preview-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      position: relative;
    }
    .setup-preview-step::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 36px;
      bottom: -12px;
      width: 2px;
      background: linear-gradient(180deg, var(--step-color, #FF6B35), transparent);
    }
    .setup-preview-step:last-child::before { display: none; }
    .setup-preview-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
      z-index: 1;
    }
    .setup-preview-content { flex: 1; }
    .setup-preview-step-title { font-size: 12px; font-weight: 500; }
    .setup-preview-step-desc { font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 2px; }

    /* Tabs in editor */
    .editor-tabs { display: flex; gap: 4px; margin-bottom: 24px; background: rgba(255,255,255,0.02); padding: 4px; border-radius: 12px; }
    .editor-tab {
      flex: 1;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: 10px;
      color: rgba(255,255,255,0.5);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .editor-tab:hover { color: white; }
    .editor-tab.active { background: rgba(255,107,53,0.15); color: #FF6B35; }
    .editor-panel { display: none; }
    .editor-panel.active { display: block; }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-screen" id="auth-screen">
    <div class="auth-box">
      <div class="auth-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      </div>
      <h2 class="auth-title">Admin iArmy</h2>
      <p class="auth-subtitle">Connexion reservee aux administrateurs</p>
      <button class="auth-btn" onclick="signInWithGoogle()">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Connexion avec Google
      </button>
      <p class="auth-error" id="auth-error"></p>
      <p class="auth-loading" id="auth-loading">Verification...</p>
    </div>
  </div>

  <!-- Main App -->
  <div class="app" id="main-app" style="display: none;">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo"><span>i</span>Army Admin</div>
      </div>
      <nav class="nav">
        <div class="nav-section">
          <div class="nav-title">Gestion</div>
          <div class="nav-item active" data-tab="modules" onclick="switchTab('modules')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            Modules
            <span class="nav-badge" id="modules-count">0</span>
          </div>
          <div class="nav-item" data-tab="users" onclick="switchTab('users')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Utilisateurs
            <span class="nav-badge" id="users-count">0</span>
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-title">Statistiques</div>
          <div class="nav-item" data-tab="analytics" onclick="switchTab('analytics')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
            Analytics
          </div>
        </div>
        <div class="nav-section" style="margin-top: auto;">
          <div class="nav-item" onclick="window.location.href='/'">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Retour au site
          </div>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main">
      <div class="main-header">
        <h1 class="main-title" id="page-title">Modules</h1>
        <div id="header-actions"></div>
      </div>
      <div class="main-content" id="main-content">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_8mpFx9ubrV29KfKtgAb3eg_dyazidfT';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ADMIN_EMAILS = ['ludovikh@gmail.com'];

    // Data
    let modules = [];
    let users = [];
    let analytics = {};
    let currentTab = 'modules';
    let currentModule = null;
    let selectedColor = '#22c55e';
    let selectedIconType = 'telegram_sheets';
    let selectedBadge = null;
    let selectedVisibility = 'draft';

    // Color presets
    const COLOR_PRESETS = [
      { name: 'Vert', color: '#22c55e' },
      { name: 'Cyan', color: '#06b6d4' },
      { name: 'Orange', color: '#f59e0b' },
      { name: 'Violet', color: '#8b5cf6' },
      { name: 'Rose', color: '#ec4899' },
      { name: 'Jaune', color: '#eab308' },
      { name: 'Bleu', color: '#3b82f6' },
      { name: 'Rouge', color: '#ef4444' },
      { name: 'Indigo', color: '#6366f1' },
      { name: 'Emeraude', color: '#10b981' },
      { name: 'Fuchsia', color: '#d946ef' },
      { name: 'Lime', color: '#84cc16' }
    ];

    // Icon types
    const ICON_TYPES = [
      { id: 'telegram_sheets', name: 'Tableur' },
      { id: 'bottles_count', name: 'Bouteilles' },
      { id: 'people_pdf', name: 'Equipe' },
      { id: 'calendar', name: 'Calendrier' },
      { id: 'reservation', name: 'Check' },
      { id: 'star', name: 'Etoile' }
    ];

    // Icon templates
    const MINI_ICON_TEMPLATES = {
      telegram_sheets: () => `<div class="mini-sheet"><div class="mini-sheet-row"><div class="mini-sheet-cell fill fill-1"></div><div class="mini-sheet-cell fill fill-2"></div></div><div class="mini-sheet-row"><div class="mini-sheet-cell fill fill-3"></div><div class="mini-sheet-cell fill fill-4"></div></div><div class="mini-sheet-row"><div class="mini-sheet-cell fill fill-5"></div><div class="mini-sheet-cell fill fill-6"></div></div></div>`,
      bottles_count: () => `<div class="mini-stock"><div class="mini-bottle mini-bottle-1"><div class="mini-bottle-cap"></div><div class="mini-bottle-neck"></div><div class="mini-bottle-body"><div class="mini-bottle-fill"></div></div></div><div class="mini-bottle mini-bottle-2"><div class="mini-bottle-cap"></div><div class="mini-bottle-neck"></div><div class="mini-bottle-body"><div class="mini-bottle-fill"></div></div></div><div class="mini-stock-count">12</div></div>`,
      people_pdf: () => `<div class="mini-paie"><div class="mini-paie-people"><div class="mini-paie-person"><div class="mini-paie-head"></div><div class="mini-paie-body"></div></div><div class="mini-paie-person"><div class="mini-paie-head"></div><div class="mini-paie-body"></div></div><div class="mini-paie-person"><div class="mini-paie-head"></div><div class="mini-paie-body"></div></div></div><div class="mini-paie-euro">‚Ç¨</div></div>`,
      calendar: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
      reservation: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>`,
      star: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`
    };

    // Badge options
    const BADGE_OPTIONS = [
      { id: null, name: 'Auto', desc: 'Nouveau si < 14j' },
      { id: 'nouveau', name: 'üÜï Nouveau' },
      { id: 'populaire', name: 'üî• Populaire' },
      { id: 'promo', name: 'üí∞ Promo' },
      { id: 'none', name: 'Aucun' }
    ];

    // Setup step types
    const SETUP_STEP_TYPES = [
      { id: 'google_auth', name: 'Google', icon: 'üîó', color: '#4285f4', title: 'Connexion Google', desc: 'Connecte ton compte Google pour acceder a Sheets' },
      { id: 'telegram_link', name: 'Telegram', icon: 'üì±', color: '#0088cc', title: 'Connexion Telegram', desc: 'Lie ton compte Telegram au soldat' },
      { id: 'stripe_checkout', name: 'Paiement', icon: 'üí≥', color: '#635bff', title: 'Paiement', desc: 'Active ton abonnement' },
      { id: 'file_upload', name: 'Fichier', icon: 'üìÑ', color: '#22c55e', title: 'Upload fichier', desc: 'Envoie un fichier (Excel, PDF)' },
      { id: 'photo_upload', name: 'Photo', icon: 'üì∏', color: '#f59e0b', title: 'Upload photo', desc: 'Prends ou envoie une photo' },
      { id: 'multi_photo_upload', name: 'Photos', icon: 'üñºÔ∏è', color: '#ec4899', title: 'Plusieurs photos', desc: 'Envoie plusieurs images' },
      { id: 'ai_analysis', name: 'Analyse IA', icon: 'ü§ñ', color: '#8b5cf6', title: 'Analyse IA', desc: 'L\'IA analyse tes donnees' },
      { id: 'config_validation', name: 'Config', icon: '‚öôÔ∏è', color: '#6b7280', title: 'Validation config', desc: 'Verifie ta configuration' },
      { id: 'list_validation', name: 'Liste', icon: '‚úÖ', color: '#10b981', title: 'Validation liste', desc: 'Verifie la liste extraite' },
      { id: 'team_validation', name: 'Equipe', icon: 'üë•', color: '#f97316', title: 'Validation equipe', desc: 'Verifie ton equipe' }
    ];

    // Current setup steps for the module being edited
    let currentSetupSteps = [];
    let currentEditorTab = 'general';
    let draggedStepIndex = null;

    // ==================
    // AUTH
    // ==================
    async function signInWithGoogle() {
      document.getElementById('auth-loading').style.display = 'block';
      sessionStorage.setItem('auth_redirect', window.location.href);
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin + '/auth/callback' }
      });
      if (error) {
        document.getElementById('auth-loading').style.display = 'none';
        document.getElementById('auth-error').textContent = error.message;
        document.getElementById('auth-error').style.display = 'block';
      }
    }

    async function checkAuth() {
      document.getElementById('auth-loading').style.display = 'block';
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session && ADMIN_EMAILS.includes(session.user.email)) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        init();
      } else if (session) {
        document.getElementById('auth-error').textContent = 'Email non autorise: ' + session.user.email;
        document.getElementById('auth-error').style.display = 'block';
        document.getElementById('auth-loading').style.display = 'none';
        await supabaseClient.auth.signOut();
      } else {
        document.getElementById('auth-loading').style.display = 'none';
      }
    }

    checkAuth();
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) checkAuth();
    });

    // ==================
    // INIT
    // ==================
    async function init() {
      await Promise.all([loadModules(), loadUsers(), loadAnalytics()]);
      renderTab();
    }

    // ==================
    // DATA LOADING
    // ==================
    async function loadModules() {
      const { data, error } = await supabaseClient.from('modules').select('*').order('sort_order');
      if (!error) {
        modules = data || [];
        document.getElementById('modules-count').textContent = modules.length;
      }
    }

    async function loadUsers() {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;

        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-data`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
            'apikey': SUPABASE_ANON_KEY
          }
        });

        if (response.ok) {
          const data = await response.json();
          users = (data.users || []).map(u => ({
            ...u,
            subscriptions: (data.subscriptions || []).filter(s => s.user_id === u.user_id),
            telegram: (data.telegramLinks || []).some(t => t.user_id === u.user_id)
          }));
          document.getElementById('users-count').textContent = users.length;
        }
      } catch (e) {
        console.error('Error loading users:', e);
      }
    }

    async function loadAnalytics() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
      const fiveMinAgo = new Date(now - 5 * 60 * 1000).toISOString();

      const [onlineRes, todayRes, recentRes] = await Promise.all([
        supabaseClient.from('page_visits').select('visitor_id').gte('created_at', fiveMinAgo),
        supabaseClient.from('page_visits').select('*', { count: 'exact', head: true }).gte('created_at', today),
        supabaseClient.from('page_visits').select('*').order('created_at', { ascending: false }).limit(20)
      ]);

      analytics = {
        online: new Set((onlineRes.data || []).map(v => v.visitor_id)).size,
        today: todayRes.count || 0,
        recent: recentRes.data || []
      };
    }

    // ==================
    // TAB SWITCHING
    // ==================
    function switchTab(tab) {
      currentTab = tab;
      currentModule = null;
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`.nav-item[data-tab="${tab}"]`)?.classList.add('active');
      renderTab();
    }

    function renderTab() {
      const titles = { modules: 'Modules', users: 'Utilisateurs', analytics: 'Analytics' };
      document.getElementById('page-title').textContent = titles[currentTab] || 'Admin';

      if (currentTab === 'modules') renderModulesTab();
      else if (currentTab === 'users') renderUsersTab();
      else if (currentTab === 'analytics') renderAnalyticsTab();
    }

    // ==================
    // MODULES TAB
    // ==================
    function renderModulesTab() {
      document.getElementById('header-actions').innerHTML = `<button class="btn btn-primary" onclick="createNewModule()">+ Nouveau Soldat</button>`;

      if (currentModule !== null) {
        renderModuleEditor();
        return;
      }

      document.getElementById('main-content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">${modules.length}</div><div class="stat-label">Modules total</div></div>
          <div class="stat-card"><div class="stat-value">${modules.filter(m => m.visibility === 'public').length}</div><div class="stat-label">Publics</div></div>
          <div class="stat-card"><div class="stat-value">${modules.filter(m => m.visibility === 'beta').length}</div><div class="stat-label">Beta</div></div>
          <div class="stat-card"><div class="stat-value">${modules.filter(m => m.visibility === 'draft').length}</div><div class="stat-label">Brouillons</div></div>
        </div>
        <div class="modules-list">
          ${modules.map(m => renderModuleListItem(m)).join('')}
        </div>
      `;
    }

    function renderModuleListItem(m) {
      const badgeText = getBadgeForModule(m);
      return `
        <div class="module-list-item" onclick="selectModule('${m.id}')">
          <div class="module-list-color" style="background: ${m.color};"></div>
          <div class="module-list-info">
            <div class="module-list-name">
              ${m.name}
              ${badgeText ? `<span style="font-size:11px;">${badgeText}</span>` : ''}
            </div>
            <div class="module-list-meta">
              <span class="module-list-badge ${m.visibility || 'draft'}">${m.visibility === 'draft' ? 'üîí Brouillon' : m.visibility === 'beta' ? 'üß™ Beta' : 'üåç Public'}</span>
              <span>${m.price || 0}‚Ç¨/mois</span>
              <span>${m.trial_days || 7}j essai</span>
            </div>
          </div>
        </div>
      `;
    }

    function getBadgeForModule(m) {
      if (m.badge === 'none') return '';
      if (m.badge === 'nouveau') return 'üÜï';
      if (m.badge === 'populaire') return 'üî•';
      if (m.badge === 'promo') return 'üí∞';
      // Auto: nouveau si < 14 jours
      if (!m.badge && m.created_at) {
        const created = new Date(m.created_at);
        const daysSince = (Date.now() - created.getTime()) / (1000 * 60 * 60 * 24);
        if (daysSince < 14) return 'üÜï';
      }
      return '';
    }

    function selectModule(id) {
      currentModule = modules.find(m => m.id === id) || null;
      if (currentModule) {
        selectedColor = currentModule.color || '#22c55e';
        selectedIconType = currentModule.icon_type || 'telegram_sheets';
        selectedBadge = currentModule.badge;
        selectedVisibility = currentModule.visibility || 'draft';
        currentSetupSteps = currentModule.setup_steps ? [...currentModule.setup_steps] : [];
      }
      currentEditorTab = 'general';
      renderModulesTab();
    }

    function createNewModule() {
      currentModule = {};
      selectedColor = '#22c55e';
      selectedIconType = 'telegram_sheets';
      selectedBadge = null;
      selectedVisibility = 'draft';
      currentSetupSteps = [];
      currentEditorTab = 'general';
      renderModulesTab();
    }

    function renderModuleEditor() {
      const isNew = !currentModule.id;

      // Initialize setup steps from module
      currentSetupSteps = currentModule.setup_steps ? [...currentModule.setup_steps] : [];

      document.getElementById('header-actions').innerHTML = `
        <button class="btn btn-secondary" onclick="currentModule=null;currentEditorTab='general';renderModulesTab();">Annuler</button>
        ${!isNew ? `<button class="btn btn-danger" onclick="deleteModule()">Supprimer</button>` : ''}
        <button class="btn btn-primary" onclick="saveModule()">Enregistrer</button>
      `;

      document.getElementById('main-content').innerHTML = `
        <div class="editor-split">
          <div class="editor-form">
            <!-- Tabs -->
            <div class="editor-tabs">
              <button class="editor-tab ${currentEditorTab === 'general' ? 'active' : ''}" onclick="switchEditorTab('general')">General</button>
              <button class="editor-tab ${currentEditorTab === 'setup' ? 'active' : ''}" onclick="switchEditorTab('setup')">Setup <span style="opacity:0.5;font-size:11px;">(${currentSetupSteps.length})</span></button>
            </div>

            <!-- General Panel -->
            <div class="editor-panel ${currentEditorTab === 'general' ? 'active' : ''}" id="panel-general">
              <!-- AI Generator -->
              <div class="form-section">
                <div class="form-section-title">‚ú® Generation IA</div>
                <div class="ai-input-wrapper">
                  <textarea class="form-textarea" id="ai-prompt" placeholder="Decris ton soldat... Ex: Un module pour gerer les reservations de restaurant, style rose/violet"></textarea>
                  <button class="ai-suggest-btn" onclick="generateWithAI()">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
                    Generer
                  </button>
                </div>
              </div>

              <!-- Basic Info -->
              <div class="form-section">
                <div class="form-section-title">Informations</div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Nom *</label>
                    <input type="text" class="form-input" id="field-name" value="${currentModule.name || ''}" placeholder="Ex: Compta" oninput="updatePreview()">
                  </div>
                  <div class="form-group">
                    <label class="form-label">ID technique *</label>
                    <input type="text" class="form-input" id="field-slug" value="${currentModule.slug || ''}" placeholder="ex: compta" ${!isNew ? 'disabled' : ''} oninput="updatePreview()">
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Description</label>
                  <textarea class="form-textarea" id="field-description" placeholder="Decris ce que fait ce soldat..." oninput="updatePreview()">${currentModule.description || ''}</textarea>
                </div>
              </div>

              <!-- Couleur -->
              <div class="form-section">
                <div class="form-section-title">Couleur</div>
                <div class="color-grid" id="color-grid"></div>
              </div>

              <!-- Icon -->
              <div class="form-section">
                <div class="form-section-title">Animation</div>
                <div class="icon-grid" id="icon-grid"></div>
              </div>

              <!-- Badge -->
              <div class="form-section">
                <div class="form-section-title">Badge</div>
                <div class="badge-grid" id="badge-grid"></div>
              </div>

              <!-- Settings -->
              <div class="form-section">
                <div class="form-section-title">Parametres</div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Visibilite</label>
                    <select class="form-select" id="field-visibility" onchange="selectedVisibility=this.value;updatePreview();">
                      <option value="draft" ${selectedVisibility === 'draft' ? 'selected' : ''}>üîí Brouillon (moi seul)</option>
                      <option value="beta" ${selectedVisibility === 'beta' ? 'selected' : ''}>üß™ Beta (testeurs)</option>
                      <option value="public" ${selectedVisibility === 'public' ? 'selected' : ''}>üåç Public (tous)</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select class="form-select" id="field-status">
                      <option value="available" ${currentModule.status === 'available' ? 'selected' : ''}>Disponible</option>
                      <option value="beta" ${currentModule.status === 'beta' ? 'selected' : ''}>Beta</option>
                      <option value="coming_soon" ${currentModule.status === 'coming_soon' ? 'selected' : ''}>Bientot</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Prix mensuel (‚Ç¨)</label>
                    <input type="text" class="form-input" id="field-price" value="${currentModule.price || ''}" placeholder="19.99" oninput="updatePreview()">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Essai gratuit (jours)</label>
                    <input type="number" class="form-input" id="field-trial" value="${currentModule.trial_days || 7}" placeholder="7" oninput="updatePreview()">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Duree abo (mois)</label>
                    <input type="number" class="form-input" id="field-duration" value="${currentModule.duration_months || ''}" placeholder="Vide = illimite">
                    <p class="form-hint">Vide = abonnement illimite</p>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Stripe Price ID</label>
                    <input type="text" class="form-input" id="field-stripe" value="${currentModule.stripe_price_id || ''}" placeholder="price_xxx">
                  </div>
                </div>
              </div>
            </div>

            <!-- Setup Panel -->
            <div class="editor-panel ${currentEditorTab === 'setup' ? 'active' : ''}" id="panel-setup">
              <div class="form-section">
                <div class="form-section-title">Etapes du Setup</div>
                <p class="form-hint" style="margin-bottom:16px;">Glisse-depose pour reordonner les etapes. L'utilisateur passera par ces etapes lors de la configuration.</p>

                <div class="setup-builder">
                  <div class="setup-steps" id="setup-steps-list">
                    ${currentSetupSteps.length === 0 ? '<div class="setup-steps-empty">Aucune etape - Ajoute des etapes ci-dessous</div>' : ''}
                  </div>

                  <div class="setup-add-bar">
                    ${SETUP_STEP_TYPES.map(type => `
                      <button class="setup-add-btn" onclick="addSetupStep('${type.id}')" title="${type.desc}">
                        <span class="step-icon">${type.icon}</span>
                        ${type.name}
                      </button>
                    `).join('')}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Preview Panel -->
          <div class="preview-panel">
            <div class="preview-title">Apercu en temps reel</div>
            <div class="preview-card" id="preview-card">
              <div class="preview-badge" id="preview-badge" style="display:none;"></div>
              <div class="preview-visibility" id="preview-visibility"></div>
              <div class="preview-icon" id="preview-icon"></div>
              <div class="preview-name" id="preview-name">Nom</div>
              <div class="preview-desc" id="preview-desc">Description</div>
            </div>
            <div class="preview-info">
              <div class="preview-info-row">
                <span class="preview-info-label">Prix</span>
                <span class="preview-info-value" id="preview-price">0‚Ç¨/mois</span>
              </div>
              <div class="preview-info-row">
                <span class="preview-info-label">Essai</span>
                <span class="preview-info-value" id="preview-trial">7 jours</span>
              </div>
              <div class="preview-info-row">
                <span class="preview-info-label">Duree</span>
                <span class="preview-info-value" id="preview-duration">Illimite</span>
              </div>
              <div class="preview-info-row">
                <span class="preview-info-label">Visibilite</span>
                <span class="preview-info-value" id="preview-vis-text">Brouillon</span>
              </div>
            </div>

            <!-- Setup Preview -->
            <div class="setup-preview" id="setup-preview" style="display:none;">
              <div class="setup-preview-title">Parcours Setup</div>
              <div class="setup-preview-flow" id="setup-preview-flow"></div>
            </div>
          </div>
        </div>
      `;

      renderColorGrid();
      renderIconGrid();
      renderBadgeGrid();
      renderSetupSteps();
      updatePreview();
    }

    function switchEditorTab(tab) {
      currentEditorTab = tab;
      document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.editor-panel').forEach(p => p.classList.remove('active'));
      document.querySelector(`.editor-tab:nth-child(${tab === 'general' ? 1 : 2})`)?.classList.add('active');
      document.getElementById(`panel-${tab}`)?.classList.add('active');
      updateSetupPreview();
    }

    // ==================
    // SETUP BUILDER
    // ==================
    function renderSetupSteps() {
      const container = document.getElementById('setup-steps-list');
      if (!container) return;

      if (currentSetupSteps.length === 0) {
        container.innerHTML = '<div class="setup-steps-empty">Aucune etape - Ajoute des etapes ci-dessous</div>';
      } else {
        container.innerHTML = currentSetupSteps.map((step, index) => {
          const type = SETUP_STEP_TYPES.find(t => t.id === step.type) || SETUP_STEP_TYPES[0];
          return `
            <div class="setup-step" draggable="true" data-index="${index}"
                 ondragstart="onStepDragStart(event, ${index})"
                 ondragover="onStepDragOver(event, ${index})"
                 ondragleave="onStepDragLeave(event)"
                 ondrop="onStepDrop(event, ${index})"
                 ondragend="onStepDragEnd(event)">
              <div class="setup-step-handle">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/></svg>
              </div>
              <div class="setup-step-icon" style="background:${type.color}20;color:${type.color};">
                ${type.icon}
              </div>
              <div class="setup-step-info">
                <div class="setup-step-title">${step.title || type.title}</div>
                <div class="setup-step-type">${type.name}</div>
              </div>
              <button class="setup-step-delete" onclick="removeSetupStep(${index})" title="Supprimer">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
          `;
        }).join('');
      }

      // Update the step count in tab
      const tabBtn = document.querySelector('.editor-tab:nth-child(2)');
      if (tabBtn) {
        tabBtn.innerHTML = `Setup <span style="opacity:0.5;font-size:11px;">(${currentSetupSteps.length})</span>`;
      }

      updateSetupPreview();
    }

    function addSetupStep(typeId) {
      const type = SETUP_STEP_TYPES.find(t => t.id === typeId);
      if (!type) return;

      currentSetupSteps.push({
        id: `${typeId}_${Date.now()}`,
        type: typeId,
        title: type.title,
        description: type.desc
      });

      renderSetupSteps();
      showToast(`Etape "${type.name}" ajoutee`);
    }

    function removeSetupStep(index) {
      currentSetupSteps.splice(index, 1);
      renderSetupSteps();
    }

    // Drag and Drop
    function onStepDragStart(event, index) {
      draggedStepIndex = index;
      event.target.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
    }

    function onStepDragOver(event, index) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';

      const step = event.target.closest('.setup-step');
      if (step && draggedStepIndex !== index) {
        step.classList.add('drag-target');
      }
    }

    function onStepDragLeave(event) {
      const step = event.target.closest('.setup-step');
      if (step) {
        step.classList.remove('drag-target');
      }
    }

    function onStepDrop(event, targetIndex) {
      event.preventDefault();

      const step = event.target.closest('.setup-step');
      if (step) {
        step.classList.remove('drag-target');
      }

      if (draggedStepIndex === null || draggedStepIndex === targetIndex) return;

      // Reorder
      const [movedStep] = currentSetupSteps.splice(draggedStepIndex, 1);
      currentSetupSteps.splice(targetIndex, 0, movedStep);

      renderSetupSteps();
    }

    function onStepDragEnd(event) {
      event.target.classList.remove('dragging');
      draggedStepIndex = null;
      document.querySelectorAll('.setup-step').forEach(s => s.classList.remove('drag-target'));
    }

    function updateSetupPreview() {
      const previewContainer = document.getElementById('setup-preview');
      const flowContainer = document.getElementById('setup-preview-flow');

      if (!previewContainer || !flowContainer) return;

      if (currentSetupSteps.length === 0) {
        previewContainer.style.display = 'none';
        return;
      }

      previewContainer.style.display = 'block';

      flowContainer.innerHTML = currentSetupSteps.map((step, index) => {
        const type = SETUP_STEP_TYPES.find(t => t.id === step.type) || SETUP_STEP_TYPES[0];
        return `
          <div class="setup-preview-step" style="--step-color:${type.color};">
            <div class="setup-preview-num" style="background:${type.color}20;color:${type.color};">
              ${type.icon}
            </div>
            <div class="setup-preview-content">
              <div class="setup-preview-step-title">${step.title}</div>
              <div class="setup-preview-step-desc">${step.description}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderColorGrid() {
      const grid = document.getElementById('color-grid');
      grid.innerHTML = COLOR_PRESETS.map(c => `
        <div class="color-option ${selectedColor === c.color ? 'selected' : ''}" style="background:${c.color};" onclick="selectColor('${c.color}')" title="${c.name}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
      `).join('');
    }

    function renderIconGrid() {
      const grid = document.getElementById('icon-grid');
      grid.innerHTML = ICON_TYPES.map(icon => `
        <div class="icon-option ${selectedIconType === icon.id ? 'selected' : ''}" onclick="selectIcon('${icon.id}')">
          <div class="icon-option-preview">${MINI_ICON_TEMPLATES[icon.id]()}</div>
          <div class="icon-option-label">${icon.name}</div>
        </div>
      `).join('');
    }

    function renderBadgeGrid() {
      const grid = document.getElementById('badge-grid');
      grid.innerHTML = BADGE_OPTIONS.map(b => `
        <div class="badge-option ${selectedBadge === b.id ? 'selected' : ''}" onclick="selectBadge(${b.id === null ? 'null' : `'${b.id}'`})">
          ${b.name}
        </div>
      `).join('');
    }

    function selectColor(color) {
      selectedColor = color;
      renderColorGrid();
      updatePreview();
    }

    function selectIcon(iconType) {
      selectedIconType = iconType;
      renderIconGrid();
      updatePreview();
    }

    function selectBadge(badge) {
      selectedBadge = badge;
      renderBadgeGrid();
      updatePreview();
    }

    function darkenColor(hex) {
      const num = parseInt(hex.replace('#', ''), 16);
      const R = Math.max(0, (num >> 16) - 40);
      const G = Math.max(0, ((num >> 8) & 0xFF) - 40);
      const B = Math.max(0, (num & 0xFF) - 40);
      return `#${(0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1)}`;
    }

    function updatePreview() {
      const name = document.getElementById('field-name')?.value || 'Nom';
      const desc = document.getElementById('field-description')?.value || 'Description';
      const price = document.getElementById('field-price')?.value || '0';
      const trial = document.getElementById('field-trial')?.value || '7';
      const duration = document.getElementById('field-duration')?.value;

      // Card
      const card = document.getElementById('preview-card');
      card.style.background = `linear-gradient(145deg, ${selectedColor}40, ${selectedColor}25)`;
      card.style.borderColor = `${selectedColor}60`;

      // Icon
      const icon = document.getElementById('preview-icon');
      icon.style.background = `linear-gradient(180deg, ${selectedColor}, ${darkenColor(selectedColor)})`;
      icon.innerHTML = MINI_ICON_TEMPLATES[selectedIconType]();

      // Text
      document.getElementById('preview-name').textContent = name;
      document.getElementById('preview-desc').textContent = desc.substring(0, 25) + (desc.length > 25 ? '...' : '');

      // Badge
      const badgeEl = document.getElementById('preview-badge');
      if (selectedBadge === 'none') {
        badgeEl.style.display = 'none';
      } else if (selectedBadge) {
        badgeEl.style.display = 'block';
        badgeEl.className = 'preview-badge ' + selectedBadge;
        badgeEl.textContent = selectedBadge === 'nouveau' ? 'üÜï Nouveau' : selectedBadge === 'populaire' ? 'üî• Populaire' : 'üí∞ Promo';
      } else {
        // Auto
        badgeEl.style.display = 'block';
        badgeEl.className = 'preview-badge nouveau';
        badgeEl.textContent = 'üÜï Nouveau';
      }

      // Visibility
      const visEl = document.getElementById('preview-visibility');
      visEl.className = 'preview-visibility ' + selectedVisibility;
      visEl.textContent = selectedVisibility === 'draft' ? 'üîí' : selectedVisibility === 'beta' ? 'üß™' : 'üåç';

      // Info
      document.getElementById('preview-price').textContent = price + '‚Ç¨/mois';
      document.getElementById('preview-trial').textContent = trial + ' jours';
      document.getElementById('preview-duration').textContent = duration ? duration + ' mois' : 'Illimite';
      document.getElementById('preview-vis-text').textContent = selectedVisibility === 'draft' ? 'Brouillon' : selectedVisibility === 'beta' ? 'Beta' : 'Public';
    }

    async function saveModule() {
      const isNew = !currentModule.id;
      const slug = document.getElementById('field-slug').value.trim();
      const name = document.getElementById('field-name').value.trim();

      if (!name || !slug) {
        showToast('Nom et ID requis', true);
        return;
      }

      const data = {
        slug,
        name,
        description: document.getElementById('field-description').value,
        color: selectedColor,
        icon_type: selectedIconType,
        status: document.getElementById('field-status').value,
        visibility: selectedVisibility,
        badge: selectedBadge,
        price: document.getElementById('field-price').value || null,
        trial_days: parseInt(document.getElementById('field-trial').value) || 7,
        duration_months: document.getElementById('field-duration').value ? parseInt(document.getElementById('field-duration').value) : null,
        stripe_price_id: document.getElementById('field-stripe').value || null,
        setup_url: `/${slug}/setup/`,
        settings_url: `/?soldat=${slug}`,
        setup_steps: currentSetupSteps
      };

      let error;
      if (isNew) {
        data.sort_order = modules.length;
        const res = await supabaseClient.from('modules').insert(data);
        error = res.error;
      } else {
        const res = await supabaseClient.from('modules').update(data).eq('id', currentModule.id);
        error = res.error;
      }

      if (error) {
        showToast('Erreur: ' + error.message, true);
        return;
      }

      showToast('Module enregistre !');
      await loadModules();
      currentModule = null;
      renderModulesTab();
    }

    async function deleteModule() {
      if (!confirm('Supprimer ce module ?')) return;
      const { error } = await supabaseClient.from('modules').delete().eq('id', currentModule.id);
      if (error) {
        showToast('Erreur: ' + error.message, true);
        return;
      }
      showToast('Module supprime');
      await loadModules();
      currentModule = null;
      renderModulesTab();
    }

    async function generateWithAI() {
      const prompt = document.getElementById('ai-prompt').value.trim();
      if (!prompt) {
        showToast('Decris ton soldat d\'abord', true);
        return;
      }

      showToast('Generation IA... (simulation)');

      // Pour l'instant, simulation - plus tard on connectera l'API Claude
      setTimeout(() => {
        // Extraire des mots-cl√©s pour sugg√©rer
        const lower = prompt.toLowerCase();

        let suggestedName = '';
        let suggestedColor = '#22c55e';
        let suggestedIcon = 'telegram_sheets';
        let suggestedDesc = prompt;

        if (lower.includes('reservation') || lower.includes('table')) {
          suggestedName = 'Reservations';
          suggestedColor = '#ec4899';
          suggestedIcon = 'reservation';
          suggestedDesc = 'Gere tes reservations de table en un clic';
        } else if (lower.includes('stock') || lower.includes('bouteille') || lower.includes('inventaire')) {
          suggestedName = 'Stock';
          suggestedColor = '#06b6d4';
          suggestedIcon = 'bottles_count';
          suggestedDesc = 'Suis ton stock de bouteilles en temps reel';
        } else if (lower.includes('paie') || lower.includes('salaire') || lower.includes('employe')) {
          suggestedName = 'Paie';
          suggestedColor = '#f59e0b';
          suggestedIcon = 'people_pdf';
          suggestedDesc = 'Genere les fiches de paie automatiquement';
        } else if (lower.includes('planning') || lower.includes('horaire') || lower.includes('calendrier')) {
          suggestedName = 'Planning';
          suggestedColor = '#8b5cf6';
          suggestedIcon = 'calendar';
          suggestedDesc = 'Organise les horaires de ton equipe';
        } else if (lower.includes('fidelite') || lower.includes('client') || lower.includes('point')) {
          suggestedName = 'Fidelite';
          suggestedColor = '#eab308';
          suggestedIcon = 'star';
          suggestedDesc = 'Recompense tes clients fideles';
        } else if (lower.includes('compta') || lower.includes('caisse') || lower.includes('ticket')) {
          suggestedName = 'Compta';
          suggestedColor = '#22c55e';
          suggestedIcon = 'telegram_sheets';
          suggestedDesc = 'Envoie ta caisse sur Telegram, elle atterrit dans Google Sheets';
        }

        // Appliquer les suggestions
        document.getElementById('field-name').value = suggestedName;
        document.getElementById('field-slug').value = suggestedName.toLowerCase().replace(/[^a-z]/g, '_');
        document.getElementById('field-description').value = suggestedDesc;
        selectedColor = suggestedColor;
        selectedIconType = suggestedIcon;

        renderColorGrid();
        renderIconGrid();
        updatePreview();

        showToast('Suggestion appliquee !');
      }, 1000);
    }

    // ==================
    // USERS TAB
    // ==================
    function renderUsersTab() {
      document.getElementById('header-actions').innerHTML = `<input type="text" class="search-input" placeholder="Rechercher..." oninput="filterUsers(this.value)">`;

      const testers = users.filter(u => u.subscriptions?.some(s => s.is_tester)).length;
      const withTelegram = users.filter(u => u.telegram).length;

      document.getElementById('main-content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">${users.length}</div><div class="stat-label">Utilisateurs</div></div>
          <div class="stat-card"><div class="stat-value">${testers}</div><div class="stat-label">Testeurs</div></div>
          <div class="stat-card"><div class="stat-value">${withTelegram}</div><div class="stat-label">Telegram</div></div>
        </div>
        <table class="users-table">
          <thead><tr><th>Utilisateur</th><th>Modules</th><th>Telegram</th><th>Actions</th></tr></thead>
          <tbody id="users-tbody">${renderUsersRows(users)}</tbody>
        </table>
      `;
    }

    function renderUsersRows(usersList) {
      if (!usersList.length) return '<tr><td colspan="4" style="text-align:center;color:rgba(255,255,255,0.4);padding:40px;">Aucun utilisateur</td></tr>';
      return usersList.map(u => {
        const isTester = u.subscriptions?.some(s => s.is_tester);
        const badges = (u.subscriptions || []).map(s => `<span class="user-badge ${s.is_tester ? 'tester' : s.status}">${s.module_name}</span>`).join('') || '-';
        return `
          <tr>
            <td>
              <div class="user-cell">
                <img src="${u.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.full_name || 'U')}&background=FF6B35&color=fff`}" class="user-avatar">
                <div>
                  <div class="user-name">${u.full_name || 'Utilisateur'} ${isTester ? '<span style="color:#c084fc;font-size:10px;">TESTEUR</span>' : ''}</div>
                  <div class="user-email">${u.email || u.user_id.substring(0,12)+'...'}</div>
                </div>
              </div>
            </td>
            <td><div class="user-badges">${badges}</div></td>
            <td>${u.telegram ? '‚úÖ' : '‚Äî'}</td>
            <td>
              <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px;" onclick="toggleTester('${u.user_id}', ${!isTester})">${isTester ? 'Retirer' : '+ Testeur'}</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterUsers(query) {
      const q = query.toLowerCase();
      const filtered = users.filter(u =>
        (u.email || '').toLowerCase().includes(q) ||
        (u.full_name || '').toLowerCase().includes(q)
      );
      document.getElementById('users-tbody').innerHTML = renderUsersRows(filtered);
    }

    async function toggleTester(userId, setTester) {
      const { data: existing } = await supabaseClient.from('subscriptions').select('id').eq('user_id', userId).eq('module_name', 'compta').maybeSingle();

      if (existing) {
        await supabaseClient.from('subscriptions').update({ is_tester: setTester, status: setTester ? 'tester' : 'trialing' }).eq('user_id', userId).eq('module_name', 'compta');
      } else {
        await supabaseClient.from('subscriptions').insert({ user_id: userId, module_name: 'compta', is_tester: setTester, status: setTester ? 'tester' : 'trialing' });
      }

      showToast(setTester ? 'Testeur ajoute' : 'Testeur retire');
      await loadUsers();
      renderUsersTab();
    }

    // ==================
    // ANALYTICS TAB
    // ==================
    function renderAnalyticsTab() {
      document.getElementById('header-actions').innerHTML = `<button class="btn btn-secondary" onclick="refreshAnalytics()">Actualiser</button>`;

      document.getElementById('main-content').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card live"><div class="stat-value">${analytics.online || 0}</div><div class="stat-label">En ligne</div></div>
          <div class="stat-card"><div class="stat-value">${analytics.today || 0}</div><div class="stat-label">Visites aujourd'hui</div></div>
        </div>
        <div class="analytics-grid">
          <div class="analytics-card">
            <h3>Dernieres visites</h3>
            <div class="visits-list">
              ${(analytics.recent || []).map(v => {
                const time = new Date(v.created_at);
                const isRecent = (Date.now() - time.getTime()) < 5 * 60 * 1000;
                return `<div class="visit-item"><div class="visit-dot ${isRecent ? 'online' : ''}"></div><div class="visit-page">${v.page_path === '/' ? 'Accueil' : v.page_path}</div><div class="visit-time">${time.toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}</div></div>`;
              }).join('') || '<div style="color:rgba(255,255,255,0.4);text-align:center;padding:20px;">Aucune visite</div>'}
            </div>
          </div>
        </div>
      `;
    }

    async function refreshAnalytics() {
      await loadAnalytics();
      renderAnalyticsTab();
      showToast('Actualise');
    }

    // ==================
    // UTILS
    // ==================
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.className = 'toast', 3000);
    }
  </script>
</body>
</html>
