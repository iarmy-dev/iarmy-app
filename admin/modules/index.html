<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Modules - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23FF6B35'/%3E%3Ctext x='50' y='65' font-family='Arial' font-size='40' font-weight='bold' fill='white' text-anchor='middle'%3EA%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f0f0f; color: white; min-height: 100vh; }

    .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }

    h1 { font-size: 24px; margin-bottom: 8px; }
    .subtitle { color: rgba(255,255,255,0.5); margin-bottom: 32px; }

    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }

    .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-size: 14px; }
    .btn-primary { background: linear-gradient(135deg, #FF6B35, #FF8B5E); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,107,53,0.3); }
    .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .btn-danger { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #f87171; }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }
    .btn-small { padding: 8px 16px; font-size: 12px; }

    /* Modules Grid */
    .modules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }

    .module-card {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 20px;
      position: relative;
    }
    .module-card.inactive { opacity: 0.5; }

    .module-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .module-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .module-name { font-size: 18px; font-weight: 600; }
    .module-status { position: absolute; top: 16px; right: 16px; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .module-status.available { background: rgba(34,197,94,0.15); color: #4ade80; }
    .module-status.coming_soon { background: rgba(251,191,36,0.15); color: #fbbf24; }
    .module-status.beta { background: rgba(59,130,246,0.15); color: #60a5fa; }

    .module-desc { color: rgba(255,255,255,0.5); font-size: 13px; margin-bottom: 16px; line-height: 1.5; }
    .module-meta { display: flex; gap: 16px; font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 16px; }
    .module-actions { display: flex; gap: 8px; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      background: #1a1a1a;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title { font-size: 20px; font-weight: 600; }
    .modal-close { background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 24px; }
    .modal-close:hover { color: white; }

    .modal-body { padding: 24px; }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.7); margin-bottom: 8px; }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: white;
      font-size: 14px;
      transition: all 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #FF6B35;
      background: rgba(255,255,255,0.08);
    }
    .form-textarea { min-height: 100px; resize: vertical; }
    .form-hint { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 500px) { .form-row { grid-template-columns: 1fr; } }

    .color-preview {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid rgba(255,255,255,0.2);
      cursor: pointer;
    }
    .color-row { display: flex; align-items: center; gap: 12px; }
    .color-row .form-input { flex: 1; }

    .icon-selector {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-top: 8px;
    }
    .icon-option {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.02);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s;
    }
    .icon-option:hover { border-color: rgba(255,255,255,0.3); }
    .icon-option.selected { border-color: #FF6B35; background: rgba(255,107,53,0.1); }

    .tags-input { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .tag { padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 6px; }
    .tag-remove { cursor: pointer; opacity: 0.5; }
    .tag-remove:hover { opacity: 1; }
    .tag-add { padding: 6px 12px; border: 1px dashed rgba(255,255,255,0.2); border-radius: 20px; font-size: 12px; cursor: pointer; }
    .tag-add:hover { border-color: rgba(255,255,255,0.4); }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .loading { text-align: center; padding: 60px; color: rgba(255,255,255,0.5); }
    .empty-state { text-align: center; padding: 60px; color: rgba(255,255,255,0.4); }

    .back-link { display: inline-flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.5); text-decoration: none; margin-bottom: 24px; font-size: 14px; }
    .back-link:hover { color: white; }

    /* Preview */
    .preview-section { margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.08); }
    .preview-title { font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.5); margin-bottom: 16px; }
    .preview-card {
      border-radius: 20px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      max-width: 280px;
      margin: 0 auto;
    }
    .preview-icons { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; height: 50px; }
    .preview-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .preview-dots { display: flex; gap: 4px; }
    .preview-dot { width: 8px; height: 8px; background: #FF6B35; border-radius: 50%; }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div id="auth-screen" style="position: fixed; inset: 0; background: #0f0f0f; display: flex; align-items: center; justify-content: center; z-index: 9999;">
    <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 40px; max-width: 400px; width: 90%; text-align: center;">
      <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 16px; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      </div>
      <h2 style="margin-bottom: 8px;">Admin iArmy</h2>
      <p style="color: rgba(255,255,255,0.5); margin-bottom: 24px; font-size: 14px;">Connexion reservee aux administrateurs</p>
      <button onclick="signInWithGoogle()" style="width: 100%; padding: 14px 20px; background: white; border: none; border-radius: 12px; color: #333; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px;">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Connexion avec Google
      </button>
      <p id="auth-error" style="color: #ef4444; margin-top: 16px; font-size: 13px; display: none;"></p>
      <p id="auth-loading" style="color: rgba(255,255,255,0.5); margin-top: 16px; font-size: 13px; display: none;">Verification...</p>
    </div>
  </div>

  <div class="container" id="main-content" style="display: none;">
    <a href="/admin/" class="back-link">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
      Retour Admin
    </a>

    <div class="header-row">
      <div>
        <h1>Gestion des Modules</h1>
        <p class="subtitle">Ajoute et modifie les modules iArmy</p>
      </div>
      <button class="btn btn-primary" onclick="openModal()">+ Nouveau Module</button>
    </div>

    <div id="modules-list" class="modules-grid">
      <div class="loading">Chargement...</div>
    </div>
  </div>

  <!-- Modal Add/Edit -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Nouveau Module</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="module-form">
          <input type="hidden" id="module-id">

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ID technique *</label>
              <input type="text" class="form-input" id="module-slug" placeholder="ex: compta, stock, paie" required pattern="[a-z_]+">
              <p class="form-hint">Lettres minuscules et underscore uniquement</p>
            </div>
            <div class="form-group">
              <label class="form-label">Nom affiche *</label>
              <input type="text" class="form-input" id="module-name" placeholder="ex: Compta" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Description (avec HTML pour les mots en couleur)</label>
            <textarea class="form-textarea" id="module-description" placeholder='ex: Envoie ta caisse sur <strong style="color:#0088cc;">Telegram</strong>'></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Couleur principale *</label>
              <div class="color-row">
                <input type="color" class="color-preview" id="module-color" value="#22c55e">
                <input type="text" class="form-input" id="module-color-text" value="#22c55e" placeholder="#22c55e">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Statut *</label>
              <select class="form-select" id="module-status">
                <option value="available">Disponible</option>
                <option value="coming_soon">Bientot</option>
                <option value="beta">Beta</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Prix</label>
              <input type="text" class="form-input" id="module-price" placeholder="9.99">
            </div>
            <div class="form-group">
              <label class="form-label">URL Setup</label>
              <input type="text" class="form-input" id="module-setup-url" placeholder="/compta/setup/">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Categories</label>
            <div style="display: flex; gap: 16px; margin-top: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="cat-restaurant" value="restaurant"> Restaurant
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="cat-bar" value="bar"> Bar
              </label>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Tags (appuie Entree pour ajouter)</label>
            <input type="text" class="form-input" id="tag-input" placeholder="ex: Restaurant, Commerce">
            <div class="tags-input" id="tags-container"></div>
          </div>

          <div class="form-group">
            <label class="form-label">Type d'icone</label>
            <select class="form-select" id="module-icon-type" onchange="updateIconPreview()">
              <option value="telegram_sheets">Telegram â†’ Sheets (Compta)</option>
              <option value="bottles_count">Bouteilles â†’ Compteur (Stock)</option>
              <option value="people_pdf">Personnes â†’ PDF (Paie)</option>
              <option value="calendar">Calendrier (Planning)</option>
              <option value="reservation">Reservation</option>
              <option value="star">Fidelite</option>
              <option value="custom">Personnalise (SVG)</option>
            </select>
          </div>

          <div class="form-group" id="custom-icon-group" style="display: none;">
            <label class="form-label">SVG Icone gauche</label>
            <textarea class="form-textarea" id="module-icon-left" placeholder="<svg>...</svg>"></textarea>
            <label class="form-label" style="margin-top: 12px;">SVG Icone droite</label>
            <textarea class="form-textarea" id="module-icon-right" placeholder="<svg>...</svg>"></textarea>
          </div>

          <!-- Preview -->
          <div class="preview-section">
            <p class="preview-title">Apercu de la carte</p>
            <div class="preview-card" id="preview-card">
              <div class="preview-icons">
                <div class="preview-icon" id="preview-icon-left"></div>
                <div class="preview-dots"><div class="preview-dot"></div><div class="preview-dot"></div><div class="preview-dot"></div></div>
                <div class="preview-icon" id="preview-icon-right"></div>
              </div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 6px;" id="preview-name">Nom</div>
              <div style="font-size: 12px; color: rgba(255,255,255,0.5);" id="preview-desc">Description</div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
        <button class="btn btn-primary" onclick="saveModule()">Enregistrer</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_8mpFx9ubrV29KfKtgAb3eg_dyazidfT';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let modules = [];
    let currentTags = [];
    let editingId = null;

    // Icon templates
    const ICON_TEMPLATES = {
      telegram_sheets: {
        left: `<svg width="24" height="24" viewBox="0 0 240 240"><circle cx="120" cy="120" r="120" fill="#229ED9"/><path fill="#fff" d="M81.486 130.178l-17.8-5.467s-2.006-.808-1.366-2.671c.143-.42.522-.72 1.773-1.5 5.912-3.686 108.297-41.223 108.297-41.223s1.928-.6 3.277-.138a1.7 1.7 0 011.377 1.152c.118.58.138 1.368.138 2.14 0 .663-.06 1.41-.06 2.292-.469 8.312-14.237 90.178-14.237 90.178s-.803 3.262-3.686 3.372c-1.99.067-5.104-1.29-6.897-2.352z"/></svg>`,
        right: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#22c55e"/><rect x="5" y="5" width="14" height="14" rx="2" fill="rgba(255,255,255,0.2)"/><line x1="5" y1="9" x2="19" y2="9" stroke="white" stroke-width="0.5"/><line x1="5" y1="13" x2="19" y2="13" stroke="white" stroke-width="0.5"/><line x1="9" y1="5" x2="9" y2="19" stroke="white" stroke-width="0.5"/><line x1="14" y1="5" x2="14" y2="19" stroke="white" stroke-width="0.5"/></svg>`
      },
      bottles_count: {
        left: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#06b6d4"/><rect x="7" y="10" width="4" height="8" rx="1" fill="white"/><rect x="8" y="7" width="2" height="3" fill="white"/><rect x="13" y="10" width="4" height="8" rx="1" fill="white"/><rect x="14" y="7" width="2" height="3" fill="white"/></svg>`,
        right: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#06b6d4"/><text x="12" y="16" font-family="Arial" font-size="10" font-weight="bold" fill="white" text-anchor="middle">12</text></svg>`
      },
      people_pdf: {
        left: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#f59e0b"/><circle cx="9" cy="8" r="2.5" fill="white"/><circle cx="15" cy="8" r="2" fill="rgba(255,255,255,0.7)"/><path d="M5 18c0-2.5 2-4.5 4.5-4.5s4.5 2 4.5 4.5" fill="white"/></svg>`,
        right: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#ef4444"/><rect x="7" y="5" width="10" height="14" rx="1" fill="white"/><text x="12" y="14" font-family="Arial" font-size="5" font-weight="bold" fill="#ef4444" text-anchor="middle">PDF</text></svg>`
      },
      calendar: {
        left: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#8b5cf6"/><rect x="5" y="6" width="14" height="12" rx="2" stroke="white" stroke-width="1.5" fill="none"/><line x1="5" y1="10" x2="19" y2="10" stroke="white" stroke-width="1.5"/><line x1="9" y1="4" x2="9" y2="8" stroke="white" stroke-width="1.5"/><line x1="15" y1="4" x2="15" y2="8" stroke="white" stroke-width="1.5"/></svg>`,
        right: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#8b5cf6"/><circle cx="12" cy="12" r="6" stroke="white" stroke-width="1.5" fill="none"/><polyline points="12 8 12 12 15 14" stroke="white" stroke-width="1.5" fill="none"/></svg>`
      },
      reservation: {
        left: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#ec4899"/><path d="M12 4a8 8 0 100 16 8 8 0 000-16zm-1 12l-4-4 1.4-1.4 2.6 2.6 5.6-5.6L18 9l-7 7z" fill="white"/></svg>`,
        right: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#ec4899"/><rect x="6" y="6" width="12" height="12" rx="2" stroke="white" stroke-width="1.5" fill="none"/><line x1="9" y1="9" x2="15" y2="9" stroke="white" stroke-width="1"/><line x1="9" y1="12" x2="15" y2="12" stroke="white" stroke-width="1"/><line x1="9" y1="15" x2="12" y2="15" stroke="white" stroke-width="1"/></svg>`
      },
      star: {
        left: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#eab308"/><path d="M12 6l1.5 3 3.5.5-2.5 2.5.5 3.5-3-1.5-3 1.5.5-3.5L7 9.5l3.5-.5z" fill="white"/></svg>`,
        right: `<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#eab308"/><path d="M12 6c-3 0-5.5 2-5.5 4.5 0 3 5.5 7.5 5.5 7.5s5.5-4.5 5.5-7.5C17.5 8 15 6 12 6z" fill="white"/></svg>`
      }
    };

    // Admin authentication - Google OAuth
    const ADMIN_EMAILS = ['ludovikh@gmail.com'];

    async function signInWithGoogle() {
      document.getElementById('auth-loading').style.display = 'block';
      document.getElementById('auth-error').style.display = 'none';

      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.href
        }
      });

      if (error) {
        document.getElementById('auth-loading').style.display = 'none';
        document.getElementById('auth-error').textContent = error.message;
        document.getElementById('auth-error').style.display = 'block';
      }
    }

    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();

      if (session && ADMIN_EMAILS.includes(session.user.email)) {
        showMainContent();
        return true;
      } else if (session) {
        // Logged in but not admin
        document.getElementById('auth-error').textContent = 'Acces refuse. Email non autorise.';
        document.getElementById('auth-error').style.display = 'block';
        document.getElementById('auth-loading').style.display = 'none';
        await supabase.auth.signOut();
        return false;
      }
      return false;
    }

    function showMainContent() {
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      init();
    }

    async function init() {
      await loadModules();
      setupTagInput();
      setupColorSync();
      setupPreview();
    }

    // Check auth on page load
    checkAuth();

    // Listen for auth state changes (after Google redirect)
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        checkAuth();
      }
    });

    async function loadModules() {
      const container = document.getElementById('modules-list');

      const { data, error } = await supabase
        .from('modules')
        .select('*')
        .order('sort_order', { ascending: true });

      if (error) {
        console.error('Error loading modules:', error);
        container.innerHTML = '<div class="empty-state">Erreur de chargement. La table "modules" existe-t-elle dans Supabase?</div>';
        return;
      }

      modules = data || [];

      if (modules.length === 0) {
        container.innerHTML = '<div class="empty-state">Aucun module. Clique sur "Nouveau Module" pour commencer.</div>';
        return;
      }

      container.innerHTML = modules.map(m => `
        <div class="module-card ${m.status !== 'available' ? 'inactive' : ''}">
          <span class="module-status ${m.status}">${m.status === 'available' ? 'Actif' : m.status === 'coming_soon' ? 'Bientot' : 'Beta'}</span>
          <div class="module-header">
            <div class="module-icon" style="background: ${m.color}20; color: ${m.color};">
              ${m.icon_type === 'custom' ? 'âœ¨' : getIconEmoji(m.icon_type)}
            </div>
            <div class="module-name">${m.name}</div>
          </div>
          <div class="module-desc">${stripHtml(m.description || '')}</div>
          <div class="module-meta">
            <span>${m.price || '0'}â‚¬/mois</span>
            <span>${(m.categories || []).join(', ')}</span>
          </div>
          <div class="module-actions">
            <button class="btn btn-secondary btn-small" onclick="editModule('${m.id}')">Modifier</button>
            <button class="btn btn-danger btn-small" onclick="deleteModule('${m.id}')">Supprimer</button>
          </div>
        </div>
      `).join('');
    }

    function getIconEmoji(type) {
      const emojis = {
        telegram_sheets: 'ðŸ“Š',
        bottles_count: 'ðŸ¾',
        people_pdf: 'ðŸ‘¥',
        calendar: 'ðŸ“…',
        reservation: 'ðŸ½ï¸',
        star: 'â­'
      };
      return emojis[type] || 'ðŸ“¦';
    }

    function stripHtml(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || '';
    }

    function openModal(module = null) {
      editingId = module?.id || null;
      document.getElementById('modal-title').textContent = module ? 'Modifier le module' : 'Nouveau Module';

      // Reset form
      document.getElementById('module-id').value = module?.id || '';
      document.getElementById('module-slug').value = module?.slug || '';
      document.getElementById('module-slug').disabled = !!module; // Can't change slug after creation
      document.getElementById('module-name').value = module?.name || '';
      document.getElementById('module-description').value = module?.description || '';
      document.getElementById('module-color').value = module?.color || '#22c55e';
      document.getElementById('module-color-text').value = module?.color || '#22c55e';
      document.getElementById('module-status').value = module?.status || 'available';
      document.getElementById('module-price').value = module?.price || '';
      document.getElementById('module-setup-url').value = module?.setup_url || '';
      document.getElementById('module-icon-type').value = module?.icon_type || 'telegram_sheets';
      document.getElementById('module-icon-left').value = module?.icon_left || '';
      document.getElementById('module-icon-right').value = module?.icon_right || '';

      // Categories
      document.getElementById('cat-restaurant').checked = (module?.categories || []).includes('restaurant');
      document.getElementById('cat-bar').checked = (module?.categories || []).includes('bar');

      // Tags
      currentTags = module?.tags || [];
      renderTags();

      // Show/hide custom icon fields
      updateIconTypeVisibility();
      updatePreview();

      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      editingId = null;
    }

    function updateIconTypeVisibility() {
      const type = document.getElementById('module-icon-type').value;
      document.getElementById('custom-icon-group').style.display = type === 'custom' ? 'block' : 'none';
    }

    async function saveModule() {
      const slug = document.getElementById('module-slug').value.trim();
      const name = document.getElementById('module-name').value.trim();
      const description = document.getElementById('module-description').value;
      const color = document.getElementById('module-color-text').value;
      const status = document.getElementById('module-status').value;
      const price = document.getElementById('module-price').value;
      const setupUrl = document.getElementById('module-setup-url').value;
      const iconType = document.getElementById('module-icon-type').value;

      const categories = [];
      if (document.getElementById('cat-restaurant').checked) categories.push('restaurant');
      if (document.getElementById('cat-bar').checked) categories.push('bar');

      // Get icon SVGs
      let iconLeft, iconRight;
      if (iconType === 'custom') {
        iconLeft = document.getElementById('module-icon-left').value;
        iconRight = document.getElementById('module-icon-right').value;
      } else {
        iconLeft = ICON_TEMPLATES[iconType]?.left || '';
        iconRight = ICON_TEMPLATES[iconType]?.right || '';
      }

      const moduleData = {
        slug,
        name,
        description,
        color,
        status,
        price: price || null,
        setup_url: setupUrl || `/${slug}/setup/`,
        settings_url: `/?soldat=${slug}`,
        icon_type: iconType,
        icon_left: iconLeft,
        icon_right: iconRight,
        categories,
        tags: currentTags
      };

      let error;
      if (editingId) {
        const result = await supabase.from('modules').update(moduleData).eq('id', editingId);
        error = result.error;
      } else {
        moduleData.sort_order = modules.length;
        const result = await supabase.from('modules').insert(moduleData);
        error = result.error;
      }

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      closeModal();
      await loadModules();
    }

    function editModule(id) {
      const module = modules.find(m => m.id === id);
      if (module) openModal(module);
    }

    async function deleteModule(id) {
      if (!confirm('Supprimer ce module ?')) return;

      const { error } = await supabase.from('modules').delete().eq('id', id);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadModules();
    }

    // Tags management
    function setupTagInput() {
      const input = document.getElementById('tag-input');
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const tag = input.value.trim();
          if (tag && !currentTags.includes(tag)) {
            currentTags.push(tag);
            renderTags();
          }
          input.value = '';
        }
      });
    }

    function renderTags() {
      const container = document.getElementById('tags-container');
      container.innerHTML = currentTags.map((tag, i) => `
        <span class="tag">${tag} <span class="tag-remove" onclick="removeTag(${i})">&times;</span></span>
      `).join('');
    }

    function removeTag(index) {
      currentTags.splice(index, 1);
      renderTags();
    }

    // Color sync
    function setupColorSync() {
      const colorPicker = document.getElementById('module-color');
      const colorText = document.getElementById('module-color-text');

      colorPicker.addEventListener('input', () => {
        colorText.value = colorPicker.value;
        updatePreview();
      });

      colorText.addEventListener('input', () => {
        if (/^#[0-9A-Fa-f]{6}$/.test(colorText.value)) {
          colorPicker.value = colorText.value;
        }
        updatePreview();
      });
    }

    // Preview
    function setupPreview() {
      document.getElementById('module-name').addEventListener('input', updatePreview);
      document.getElementById('module-description').addEventListener('input', updatePreview);
      document.getElementById('module-icon-type').addEventListener('change', () => {
        updateIconTypeVisibility();
        updatePreview();
      });
    }

    function updatePreview() {
      const name = document.getElementById('module-name').value || 'Nom';
      const desc = stripHtml(document.getElementById('module-description').value) || 'Description';
      const color = document.getElementById('module-color-text').value;
      const iconType = document.getElementById('module-icon-type').value;

      document.getElementById('preview-name').textContent = name;
      document.getElementById('preview-desc').textContent = desc;

      const card = document.getElementById('preview-card');
      card.style.background = `linear-gradient(145deg, ${color}40, ${color}20)`;
      card.style.border = `1px solid ${color}60`;

      const icons = ICON_TEMPLATES[iconType] || ICON_TEMPLATES.telegram_sheets;
      document.getElementById('preview-icon-left').innerHTML = icons.left;
      document.getElementById('preview-icon-left').style.background = color;
      document.getElementById('preview-icon-right').innerHTML = icons.right;
      document.getElementById('preview-icon-right').style.background = color;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
