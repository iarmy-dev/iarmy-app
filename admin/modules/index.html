<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Modules - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/icons.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a0a; color: white; min-height: 100vh; }

    .app { display: grid; grid-template-columns: 300px 1fr; min-height: 100vh; }
    @media (max-width: 800px) { .app { grid-template-columns: 1fr; } }

    /* Sidebar */
    .sidebar {
      background: #0f0f0f;
      border-right: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .sidebar-title a { color: rgba(255,255,255,0.4); text-decoration: none; }

    .modules-list { flex: 1; overflow-y: auto; padding: 12px; }
    .module-item {
      padding: 12px 14px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
      transition: background 0.15s;
    }
    .module-item:hover { background: rgba(255,255,255,0.04); }
    .module-item.active { background: rgba(255,107,53,0.15); }
    .module-item-color { width: 28px; height: 28px; border-radius: 8px; }
    .module-item-name { font-size: 14px; font-weight: 500; }

    .btn-new {
      margin: 12px;
      padding: 14px;
      background: linear-gradient(135deg, #FF6B35, #FF8B5E);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    /* Main */
    .main { padding: 40px; overflow-y: auto; }
    .main-empty { display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.3); }

    /* Editor */
    .editor { max-width: 600px; margin: 0 auto; }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .editor-title { font-size: 20px; font-weight: 700; }
    .editor-actions { display: flex; gap: 10px; }

    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
    }
    .btn-save { background: linear-gradient(135deg, #FF6B35, #FF8B5E); color: white; }
    .btn-save:hover { transform: translateY(-1px); }
    .btn-delete { background: transparent; color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
    .btn-delete:hover { background: rgba(239,68,68,0.1); }

    /* Card Preview */
    .card-preview {
      border-radius: 20px;
      padding: 32px 24px;
      text-align: center;
      margin-bottom: 32px;
      transition: all 0.2s;
    }

    .card-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
    }
    .card-icon:hover { transform: scale(1.1); }
    .card-icon::after {
      content: '‚úèÔ∏è';
      position: absolute;
      bottom: -4px;
      right: -4px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .card-icon:hover::after { opacity: 1; }

    .card-name {
      font-size: 22px;
      font-weight: 700;
      background: transparent;
      border: none;
      color: white;
      text-align: center;
      width: 100%;
      margin-bottom: 12px;
      padding: 4px;
      border-radius: 8px;
    }
    .card-name:focus { outline: none; background: rgba(255,255,255,0.05); }
    .card-name::placeholder { color: rgba(255,255,255,0.3); }

    .card-desc {
      font-size: 14px;
      line-height: 1.6;
      color: rgba(255,255,255,0.7);
      margin-bottom: 16px;
      min-height: 50px;
    }
    .card-desc-preview { margin-bottom: 12px; }
    .card-desc-edit {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      color: white;
      font-size: 14px;
      padding: 12px;
      resize: none;
      text-align: center;
      line-height: 1.6;
    }
    .card-desc-edit:focus { outline: none; border-color: rgba(255,255,255,0.2); }
    .card-desc-edit::placeholder { color: rgba(255,255,255,0.3); }

    .btn-improve {
      padding: 10px 24px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-improve:hover { background: rgba(255,255,255,0.12); }
    .btn-improve:disabled { opacity: 0.5; }

    /* Icon Generator - inline */
    .icon-generator {
      display: none;
      margin-top: 16px;
      padding: 16px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
    }
    .icon-generator.show { display: block; }
    .icon-generator textarea {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: white;
      font-size: 13px;
      padding: 12px;
      resize: none;
      margin-bottom: 12px;
    }
    .icon-generator textarea:focus { outline: none; border-color: rgba(255,255,255,0.2); }
    .icon-generator textarea::placeholder { color: rgba(255,255,255,0.4); }
    .icon-generator-btns { display: flex; gap: 8px; justify-content: center; }
    .icon-result {
      display: none;
      margin-top: 16px;
      padding: 16px;
      background: rgba(34,197,94,0.1);
      border: 1px solid rgba(34,197,94,0.2);
      border-radius: 12px;
      text-align: center;
    }
    .icon-result.show { display: block; }
    .icon-result-preview {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon-result-btns { display: flex; gap: 8px; justify-content: center; }

    /* Sections */
    .section {
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 11px;
      font-weight: 600;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    /* Colors */
    .colors {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .color-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    .color-btn:hover { transform: scale(1.1); }
    .color-btn.active { border-color: white; }

    /* Categories */
    .categories {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .cat-btn {
      padding: 8px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .cat-btn:hover { border-color: rgba(255,255,255,0.2); }
    .cat-btn.active { background: rgba(255,107,53,0.15); border-color: #FF6B35; color: white; }

    /* Params */
    .params {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }
    .param label {
      display: block;
      font-size: 11px;
      color: rgba(255,255,255,0.4);
      margin-bottom: 6px;
    }
    .param input, .param select {
      width: 100%;
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: white;
      font-size: 13px;
    }
    .param input:focus, .param select:focus { outline: none; border-color: rgba(255,255,255,0.2); }

    /* Auth */
    .auth-screen {
      position: fixed;
      inset: 0;
      background: #0a0a0a;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .auth-box {
      text-align: center;
      padding: 40px;
    }
    .auth-title { font-size: 20px; margin-bottom: 24px; }
    .auth-btn {
      padding: 14px 32px;
      background: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .auth-error { color: #f87171; margin-top: 16px; font-size: 13px; display: none; }

    /* Spinner */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Auth -->
  <div class="auth-screen" id="auth-screen">
    <div class="auth-box">
      <div class="auth-title">Admin iArmy</div>
      <button class="auth-btn" onclick="signIn()">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Connexion Google
      </button>
      <p class="auth-error" id="auth-error"></p>
    </div>
  </div>

  <!-- App -->
  <div class="app" id="app" style="display:none;">
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">
          <a href="/">‚Üê</a> Modules
        </div>
        <a href="/admin/testeurs/" style="font-size:11px; color:rgba(255,255,255,0.4); text-decoration:none;">üß™ Testeurs</a>
      </div>
      <div class="modules-list" id="modules-list"></div>
      <button class="btn-new" onclick="createModule()">+ Nouveau module</button>
    </div>

    <div class="main" id="main">
      <div class="main-empty">S√©lectionne un module</div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_8mpFx9ubrV29KfKtgAb3eg_dyazidfT';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const ADMIN_EMAILS = ['ludovikh@gmail.com'];

    const COLORS = ['#22c55e','#06b6d4','#f59e0b','#8b5cf6','#ec4899','#eab308','#3b82f6','#ef4444','#6366f1','#10b981','#d946ef','#84cc16'];
    const CATEGORIES = [
      { id: 'restaurant', name: 'üçΩÔ∏è Restaurant' },
      { id: 'bar', name: 'üç∏ Bar' },
      { id: 'hotel', name: 'üè® Hotel' },
      { id: 'commerce', name: 'üè™ Commerce' },
      { id: 'service', name: 'üîß Service' }
    ];

    let modules = [];
    let current = null;
    let color = COLORS[0];
    let categories = [];
    let iconType = 'telegram_sheets';
    let descHtml = '';
    let generatedSvg = null;

    // Auth
    async function signIn() {
      sessionStorage.setItem('auth_redirect', window.location.href);
      await supabaseClient.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: location.origin + '/auth/callback' }});
    }

    async function checkAuth() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session?.user?.email && ADMIN_EMAILS.includes(session.user.email)) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app').style.display = 'grid';
        loadModules();
      } else if (session) {
        document.getElementById('auth-error').textContent = 'Non autoris√©';
        document.getElementById('auth-error').style.display = 'block';
        supabaseClient.auth.signOut();
      }
    }
    checkAuth();
    supabaseClient.auth.onAuthStateChange(() => checkAuth());

    // Load modules
    async function loadModules() {
      const { data } = await supabaseClient.from('modules').select('*').order('sort_order');
      modules = data || [];
      renderList();
    }

    function renderList() {
      const el = document.getElementById('modules-list');
      el.innerHTML = modules.map(m => `
        <div class="module-item ${current?.id === m.id ? 'active' : ''}" onclick="selectModule('${m.id}')">
          <div class="module-item-color" style="background:${m.color}"></div>
          <div class="module-item-name">${m.name || 'Sans nom'}</div>
        </div>
      `).join('') || '<div style="padding:20px;color:rgba(255,255,255,0.3);text-align:center;">Aucun module</div>';
    }

    function selectModule(id) {
      current = modules.find(m => m.id === id);
      color = current?.color || COLORS[0];
      categories = current?.categories || [];
      iconType = current?.icon_type || 'telegram_sheets';
      descHtml = current?.description || '';
      generatedSvg = null;
      renderList();
      renderEditor();
    }

    function createModule() {
      current = null;
      color = COLORS[0];
      categories = [];
      iconType = 'telegram_sheets';
      descHtml = '';
      generatedSvg = null;
      renderList();
      renderEditor();
    }

    function renderEditor() {
      const main = document.getElementById('main');
      const isNew = !current;

      main.innerHTML = `
        <div class="editor">
          <div class="editor-header">
            <div class="editor-title">${isNew ? 'Nouveau module' : current.name}</div>
            <div class="editor-actions">
              ${!isNew ? '<button class="btn btn-delete" onclick="deleteModule()">Supprimer</button>' : ''}
              <button class="btn btn-save" onclick="save()">Enregistrer</button>
            </div>
          </div>

          <!-- Card Preview -->
          <div class="card-preview" id="card-preview" style="background:linear-gradient(145deg, ${color}30, ${color}15); border:2px solid ${color}40;">
            <div class="card-icon" id="card-icon" onclick="toggleIconGenerator()" style="background:linear-gradient(180deg, ${color}, ${darken(color)})">
              ${getModuleIcon(iconType, 'white')}
            </div>

            <input type="text" class="card-name" id="input-name" placeholder="Nom du module" value="${current?.name || ''}" oninput="updatePreview()">

            <div class="card-desc">
              <div class="card-desc-preview" id="desc-preview">${descHtml || '<span style="color:rgba(255,255,255,0.3)">Description...</span>'}</div>
              <textarea class="card-desc-edit" id="input-desc" rows="2" placeholder="D√©cris ce que fait ce module...">${stripHtml(descHtml)}</textarea>
            </div>

            <button class="btn-improve" id="btn-improve" onclick="improveText()">‚ú® Am√©liorer le texte</button>

            <!-- Icon Generator (inline) -->
            <div class="icon-generator" id="icon-generator">
              <textarea id="icon-prompt" rows="3" placeholder="D√©cris l'ic√¥ne que tu veux...&#10;Ex: un calendrier avec une horloge qui tourne"></textarea>
              <div class="icon-generator-btns">
                <button class="btn-improve" onclick="generateIcon()">‚ú® G√©n√©rer l'ic√¥ne</button>
                <button class="btn-improve" onclick="toggleIconGenerator()" style="background:transparent;">Annuler</button>
              </div>
              <div class="icon-result" id="icon-result">
                <div class="icon-result-preview" id="icon-result-preview"></div>
                <div class="icon-result-btns">
                  <button class="btn-improve" onclick="useIcon()" style="background:rgba(34,197,94,0.2);border-color:rgba(34,197,94,0.4);">‚úì Utiliser</button>
                  <button class="btn-improve" onclick="generateIcon()">‚Üª Autre</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Colors -->
          <div class="section">
            <div class="section-title">Couleur</div>
            <div class="colors" id="colors">
              ${COLORS.map(c => `<div class="color-btn ${c === color ? 'active' : ''}" style="background:${c}" onclick="setColor('${c}')"></div>`).join('')}
            </div>
          </div>

          <!-- Categories -->
          <div class="section">
            <div class="section-title">Cat√©gories</div>
            <div class="categories" id="categories">
              ${CATEGORIES.map(c => `<div class="cat-btn ${categories.includes(c.id) ? 'active' : ''}" onclick="toggleCat('${c.id}')">${c.name}</div>`).join('')}
            </div>
          </div>

          <!-- Params -->
          <div class="section">
            <div class="section-title">Param√®tres</div>
            <div class="params">
              <div class="param">
                <label>ID technique</label>
                <input type="text" id="input-slug" value="${current?.slug || ''}" placeholder="compta" ${current ? 'disabled' : ''}>
              </div>
              <div class="param">
                <label>Prix ‚Ç¨/mois</label>
                <input type="text" id="input-price" value="${current?.price || ''}" placeholder="9.99">
              </div>
              <div class="param">
                <label>Essai (jours)</label>
                <input type="number" id="input-trial" value="${current?.trial_days || 7}">
              </div>
              <div class="param">
                <label>Visibilit√©</label>
                <select id="input-visibility">
                  <option value="draft" ${current?.visibility === 'draft' ? 'selected' : ''}>üîí Priv√©</option>
                  <option value="beta" ${current?.visibility === 'beta' ? 'selected' : ''}>üß™ Beta</option>
                  <option value="public" ${current?.visibility === 'public' ? 'selected' : ''}>üåç Public</option>
                </select>
              </div>
              <div class="param">
                <label>Stripe Price ID</label>
                <input type="text" id="input-stripe" value="${current?.stripe_price_id || ''}" placeholder="price_xxx">
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function updatePreview() {
      const name = document.getElementById('input-name')?.value || 'Module';
      document.querySelector('.editor-title').textContent = name;
    }

    function setColor(c) {
      color = c;
      renderEditor();
    }

    function toggleCat(id) {
      if (categories.includes(id)) {
        categories = categories.filter(c => c !== id);
      } else {
        categories.push(id);
      }
      document.querySelectorAll('.cat-btn').forEach(btn => {
        const catId = btn.onclick.toString().match(/'([^']+)'/)?.[1];
        btn.classList.toggle('active', categories.includes(catId));
      });
    }

    function toggleIconGenerator() {
      document.getElementById('icon-generator').classList.toggle('show');
      document.getElementById('icon-result').classList.remove('show');
    }

    // Improve text with AI
    async function improveText() {
      const btn = document.getElementById('btn-improve');
      const textarea = document.getElementById('input-desc');
      const text = textarea.value.trim();

      if (!text) {
        textarea.focus();
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Am√©lioration...';

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const res = await fetch(SUPABASE_URL + '/functions/v1/admin-ai-generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token },
          body: JSON.stringify({ type: 'description', name: document.getElementById('input-name').value, currentDescription: text, color })
        });
        const data = await res.json();
        if (data.result) {
          descHtml = data.result;
          document.getElementById('desc-preview').innerHTML = descHtml;
          textarea.value = stripHtml(descHtml);
        }
      } catch (e) {
        alert('Erreur: ' + e.message);
      }

      btn.disabled = false;
      btn.textContent = '‚ú® Am√©liorer le texte';
    }

    // Generate icon with AI
    async function generateIcon() {
      const prompt = document.getElementById('icon-prompt').value.trim();
      if (!prompt) return;

      const btn = document.querySelector('#icon-generator .btn-improve');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const res = await fetch(SUPABASE_URL + '/functions/v1/admin-ai-generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token },
          body: JSON.stringify({ type: 'generate_svg', prompt, animated: true })
        });
        const data = await res.json();
        if (data.result?.svg) {
          generatedSvg = data.result.svg;
          const preview = document.getElementById('icon-result-preview');
          preview.style.background = `linear-gradient(180deg, ${color}, ${darken(color)})`;
          preview.innerHTML = generatedSvg.replace(/currentColor/g, 'white');
          document.getElementById('icon-result').classList.add('show');
        }
      } catch (e) {
        alert('Erreur: ' + e.message);
      }

      btn.disabled = false;
      btn.textContent = '‚ú® G√©n√©rer l\'ic√¥ne';
    }

    function useIcon() {
      if (!generatedSvg) return;
      iconType = 'custom';
      if (typeof MODULE_ICON_TEMPLATES !== 'undefined') {
        MODULE_ICON_TEMPLATES.custom = () => generatedSvg;
      }
      document.getElementById('card-icon').innerHTML = generatedSvg.replace(/currentColor/g, 'white');
      toggleIconGenerator();
    }

    // Save
    async function save() {
      const slug = document.getElementById('input-slug').value.trim();
      const name = document.getElementById('input-name').value.trim();

      if (!name || !slug) {
        alert('Nom et ID requis');
        return;
      }

      const moduleData = {
        slug,
        name,
        description: descHtml || document.getElementById('input-desc').value,
        color,
        icon_type: iconType,
        categories: categories.length ? categories : null,
        price: document.getElementById('input-price').value || null,
        trial_days: parseInt(document.getElementById('input-trial').value) || 7,
        visibility: document.getElementById('input-visibility').value,
        stripe_price_id: document.getElementById('input-stripe').value || null,
        status: 'available',
        setup_url: '/' + slug + '/setup/'
      };

      let error;
      if (current) {
        const res = await supabaseClient.from('modules').update(moduleData).eq('id', current.id);
        error = res.error;
      } else {
        moduleData.sort_order = modules.length;
        const res = await supabaseClient.from('modules').insert(moduleData);
        error = res.error;
      }

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadModules();
      const saved = modules.find(m => m.slug === slug);
      if (saved) selectModule(saved.id);
    }

    async function deleteModule() {
      if (!current || !confirm('Supprimer ce module ?')) return;
      await supabaseClient.from('modules').delete().eq('id', current.id);
      current = null;
      await loadModules();
      document.getElementById('main').innerHTML = '<div class="main-empty">S√©lectionne un module</div>';
    }

    // Utils
    function stripHtml(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent || '';
    }

    function darken(hex) {
      const num = parseInt(hex.replace('#', ''), 16);
      const r = Math.max(0, (num >> 16) - 40);
      const g = Math.max(0, ((num >> 8) & 0xFF) - 40);
      const b = Math.max(0, (num & 0xFF) - 40);
      return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
    }
  </script>
</body>
</html>
