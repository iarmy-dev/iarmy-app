<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nos Soldats - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
  <link rel="stylesheet" href="/css/header.css">
  <script src="/js/icons.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f0f0f; color: white; min-height: 100vh; overflow-x: hidden; }

    .orb { position: fixed; border-radius: 50%; filter: blur(100px); animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 1; }
    .orb-1 { width: 500px; height: 500px; background: linear-gradient(135deg, #FF6B35, #FF3D00); top: -200px; right: -100px; opacity: 0.25; }
    .orb-2 { width: 450px; height: 450px; background: linear-gradient(135deg, #06B6D4, #0891B2); bottom: -150px; left: -150px; opacity: 0.2; animation-delay: -5s; }
    .orb-3 { width: 350px; height: 350px; background: linear-gradient(135deg, #A855F7, #7C3AED); top: 40%; left: 60%; opacity: 0.15; animation-delay: -10s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }

    /* Telegram mode */
    body.telegram-mode nav { display: none; }
    body.telegram-mode .container { padding-top: 20px; }
    body.telegram-mode .orb-1 { opacity: 0.1; top: -300px; }

    .bg-grid {
      position: fixed;
      inset: 0;
      background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.03) 1px, transparent 0);
      background-size: 32px 32px;
      pointer-events: none;
      z-index: 0;
    }

    .container { max-width: 900px; margin: 0 auto; padding: 100px 20px 40px; position: relative; z-index: 10; }

    .page-header { text-align: center; margin-bottom: 32px; }
    .page-title {
      font-size: 14px;
      font-weight: 600;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    /* Category filter */
    .category-filter {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 40px;
    }
    .category-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .category-btn:hover {
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.8);
    }
    .category-btn.active {
      background: linear-gradient(135deg, #FF6B35, #FF8B5E);
      border-color: transparent;
      color: white;
    }

    /* Modules grid */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }
    @media (max-width: 900px) {
      .modules-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 500px) {
      .modules-grid { grid-template-columns: 1fr; }
    }

    /* Module card */
    .module-card {
      border-radius: 24px;
      padding: 28px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      text-align: center;
      border: 1px solid transparent;
      position: relative;
      text-decoration: none;
      color: white;
      overflow: hidden;
    }
    .module-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    }
    .module-card:hover { transform: translateY(-4px); }

    /* Badge */
    .card-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .card-badge.nouveau { background: rgba(34,197,94,0.2); color: #4ade80; }
    .card-badge.populaire { background: rgba(245,158,11,0.2); color: #fbbf24; }
    .card-badge.promo { background: rgba(239,68,68,0.2); color: #f87171; }
    .card-badge.installe { background: rgba(255,255,255,0.15); color: white; }

    /* Module icon in card */
    .module-icon-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 60px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .card-desc {
      color: rgba(255,255,255,0.5);
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    .card-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .card-tag {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 10px;
    }

    .loading { display: flex; align-items: center; justify-content: center; padding: 80px; }
    .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #FF6B35; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-state { text-align: center; padding: 60px; color: rgba(255,255,255,0.4); }
  </style>
</head>
<body>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>
  <div class="bg-grid"></div>

  <nav>
    <div class="nav-inner">
      <a id="logo-link" href="/" style="text-decoration: none; color: white; display: flex; align-items: center; gap: 10px;">
        <div class="logo-i">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 139.61 327.81">
            <g id="i-body">
              <path fill="#fff" d="M85.32,142.54c-2.41.32-5.05.57-7.21.96-8.54,1.56-33.88,6.95-43.99,9.8-12.24,3.46-13.3,11.97-14.1,17.56-.8,5.59,1.41,17.88,11.17,17.88,8.54,0,8.25,10.59,8.25,10.59,0,0,.14,68.63,0,84.86-.16,17.89-10.64,17.82-10.64,17.82,0,0-7.71,0-7.71,12.24,0,13.39,14.1,13.03,14.1,13.03h85.12c10.91,0,11.7-14.63,11.7-14.63,0,0,1.6-13.83-10.64-13.83-8.78,0-8.25-15.69-8.25-15.69v-112.79s1.05-15.65-4.69-20.55c-7.08-6.86-15.9-8.21-23.11-7.24Z"/>
              <path fill="#cecdd1" d="M51.63,148.52c-15.07,6.79-15.86,21.93-15.86,21.93,0,0-1.5,12.05,11.76,14.95,6.69,1.42,6.63,13.69,6.63,13.69v85.37c0,16.21-8.04,17.97-8.04,17.97,0,0-7.31.55-7.31,12.31,0,13.47,11.31,13.07,11.31,13.07h-14.97s-14.9.36-14.89-13.11c0-12.31,7.71-13.2,7.71-13.2,0,0,10.92.15,10.92-17.04v-85.37s.24-9.76-7.67-9.76c-10.37,0-12.68-13.36-11.88-18.98.8-5.62,2.46-14.33,14.77-17.81l17.49-4.02Z"/>
            </g>
            <g id="i-head">
              <circle fill="#fff" cx="71.97" cy="86.29" r="47.78"/>
              <path fill="#cecdd1" d="M28.09,105.24c-2.51-5.81-3.9-12.22-3.9-18.95,0-26.39,21.39-47.78,47.78-47.78,21.31,0,39.36,13.95,45.52,33.22,0,0-57.76-3.29-89.39,33.5Z"/>
              <path fill="#cecdd1" d="M11.18,94.6c7.57,0,22.75-16.13,22.75-16.13,0,0,9.63-8.94,22.45-13.62,0,0-15.61,5.19-20.22,5.09-5.54-.13-18.51-29.21,3.34-53.81-18.29,6.35-31.42,23.73-31.42,44.18,0,0,.43,7.31,1.24,10.76,0,0,2.7,9.61,1.85,23.53Z"/>
              <path fill="#cecdd1" d="M90.21,58.98c22.66-6.38,45.01-.4,37.63-3.02-8.45-2.99-7.62-11.85-7.62-11.85,0,0-3.34,4.39-30,14.86Z"/>
            </g>
            <g id="i-helmet">
              <path fill="#FF6B35" d="M.66,106c.84,4.08,18.82,3.64,28.44,2.78,44.27-4.52,100.5-34,107.13-40.41,2.2-2.13,2.98-3.92,2.8-5.49,0,0-22.99-6.11-65.67,3.07-25.04,4.53-39.22,19.55-39.22,19.55,0,0-23.43,24.08-33.47,20.51"/>
              <path fill="#fff" d="M.66,106s-1.06-3.33,2.22-6.38c4.51-4.19-.15-23.54-.15-23.54-1.07-4.54-1.64-9.28-1.64-14.14C1.09,28.01,28.6.5,62.53.5c28.39,0,52.29,19.26,59.33,45.43,0,0,.69,6.19,7.75,9.4,4.72,2.14,9.06,4.39,9.43,7.55,0,0-22.99-6.11-65.67,3.07-25.04,4.53-39.22,19.55-39.22,19.55,0,0-23.43,24.08-33.47,20.51Z"/>
              <path fill="#FF6B35" d="M.66,106c10.04,3.58,33.47-20.51,33.47-20.51,0,0,14.19-15.02,39.22-19.55,42.68-9.18,65.67-3.07,65.67-3.07.14,1.18-.2,2.38-1.34,3.86l-.02.03c-5.59-1.12-27.75-4.42-64.31,3.45-25.04,4.53-39.22,19.55-39.22,19.55,0,0-13.82,14.38-24.79,19.32,0,0-8.43-.46-8.68-3.09Z"/>
            </g>
          </svg>
        </div>
        <span style="font-weight: 700; font-size: 18px; letter-spacing: -0.5px;">iArmy</span>
      </a>
      <div class="nav-right" id="nav-right">
        <a href="/" class="nav-avatar-link" id="nav-avatar-link" title="Mon compte" style="display:none;">
          <img src="" class="nav-avatar" alt="Avatar" id="nav-avatar-img">
        </a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 class="page-title">Nos Soldats</h1>
    </div>

    <div class="category-filter">
      <button class="category-btn active" data-category="all">Tous</button>
      <button class="category-btn" data-category="restaurant">Restaurant</button>
      <button class="category-btn" data-category="bar">Bar</button>
    </div>

    <div id="modules-container" class="modules-grid">
      <div class="loading"><div class="spinner"></div></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cWZucGRjbmlmYXVod2dldGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY2MzQ4NDYsImV4cCI6MjA1MjIxMDg0Nn0.YjrRXPHBmag47WyLWOKPr7TIc0z3oN_AzNL5CSx3az8';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Icons centralises dans /js/icons.js

    let modulesData = [];
    let currentUser = null;
    let userModules = [];
    let currentCategory = 'all';
    let isTelegramMode = false;
    let telegramUserId = null;

    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const tg = window.Telegram?.WebApp;

      if (tg && tg.initData) {
        isTelegramMode = true;
        telegramUserId = urlParams.get('tguid') || tg.initDataUnsafe?.user?.id;
        document.body.classList.add('telegram-mode');
        tg.ready();
        tg.expand();
        tg.setBackgroundColor('#0f0f0f');
        tg.setHeaderColor('#0f0f0f');
        // Bouton retour - supprimer anciens handlers d'abord
        tg.BackButton.offClick();
        tg.BackButton.onClick(() => {
          window.location.href = '/?tg=1&tguid=' + telegramUserId;
        });
        tg.BackButton.show();
      }

      // Charger les modules depuis Supabase
      await loadModulesFromDB();

      // En mode Telegram, utiliser le sessionToken de la page compte
      if (isTelegramMode && telegramUserId) {
        try {
          const sessionToken = sessionStorage.getItem('tg_session_token');
          if (sessionToken) {
            // Valider le token et rÃ©cupÃ©rer userId
            const response = await fetch(SUPABASE_URL + '/functions/v1/telegram-validate-session', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionToken })
            });
            const data = await response.json();
            if (data.userId) {
              currentUser = { id: data.userId };
              await loadUserModulesFromTelegram(data.userId);
            }
          } else {
            // Fallback: appeler telegram-auth
            const tgApp = window.Telegram?.WebApp;
            const response = await fetch(SUPABASE_URL + '/functions/v1/telegram-auth', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                initData: tgApp?.initData || '',
                telegramUserId: telegramUserId
              })
            });
            const authData = await response.json();
            if (authData.userId) {
              currentUser = { id: authData.userId };
              if (authData.moduleConfig?.sheetId) {
                userModules.push('compta');
              }
              await loadUserModulesFromTelegram(authData.userId);
            }
          }
        } catch (err) {
          console.log('Telegram auth error:', err);
        }
      } else {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session?.user) {
          currentUser = session.user;
          await loadUserModules();
        }
      }

      renderModules();
      setupFilters();
    }

    async function loadUserModulesFromTelegram(userId) {
      try {
        // Charger les module_configs (compta, etc.)
        const { data: configs } = await supabaseClient
          .from('module_configs')
          .select('module_name, sheet_id')
          .eq('user_id', userId);

        if (configs) {
          const configuredModules = configs.filter(c => c.sheet_id).map(c => c.module_name);
          configuredModules.forEach(m => {
            if (!userModules.includes(m)) userModules.push(m);
          });
        }

        // Verifier stock
        const { count: stockCount } = await supabaseClient
          .from('stock_products')
          .select('id', { count: 'exact', head: true })
          .eq('user_id', userId);

        if (stockCount > 0 && !userModules.includes('stock')) {
          userModules.push('stock');
        }

        // Verifier paie
        const { count: paieCount } = await supabaseClient
          .from('employees')
          .select('id', { count: 'exact', head: true })
          .eq('user_id', userId);

        if (paieCount > 0 && !userModules.includes('paie')) {
          userModules.push('paie');
        }
      } catch (err) {
        console.log('Error loading user modules from telegram:', err);
      }
    }

    // Emails admin qui voient tous les modules
    const ADMIN_EMAILS = ['ludovikh@gmail.com'];

    async function loadModulesFromDB() {
      // Verifier si admin
      let isAdmin = false;
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session?.user?.email) {
        isAdmin = ADMIN_EMAILS.includes(session.user.email);
      }

      let query = supabaseClient
        .from('modules')
        .select('*')
        .order('sort_order', { ascending: true });

      // Admin voit tout, sinon filtrer
      if (!isAdmin) {
        query = query.in('status', ['available', 'beta']);
        query = query.in('visibility', ['public', 'beta']);
      } else {
        console.log('[Soldats] Mode admin - affichage de tous les modules');
      }

      const { data, error } = await query;

      if (error) {
        console.error('Error loading modules:', error);
        modulesData = [];
        return;
      }

      modulesData = data || [];
    }

    async function loadUserModules() {
      if (!currentUser) return;

      try {
        const { data: configs } = await supabaseClient
          .from('module_configs')
          .select('module_name, sheet_id')
          .eq('user_id', currentUser.id);

        if (configs) {
          userModules = configs.filter(c => c.sheet_id).map(c => c.module_name);
        }

        const { count: stockCount } = await supabaseClient
          .from('stock_products')
          .select('id', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (stockCount > 0 && !userModules.includes('stock')) {
          userModules.push('stock');
        }

        const { count: paieCount } = await supabaseClient
          .from('employees')
          .select('id', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (paieCount > 0 && !userModules.includes('paie')) {
          userModules.push('paie');
        }
      } catch (err) {
        console.log('Error loading user modules:', err);
      }
    }

    // hexToRgba est fourni par /js/icons.js

    // Determiner le badge d'un module depuis la BDD
    function getModuleBadge(mod) {
      if (mod.badge === 'none') return null;
      if (mod.badge === 'nouveau') return { class: 'nouveau', text: 'ðŸ†• NOUVEAU' };
      if (mod.badge === 'populaire') return { class: 'populaire', text: 'ðŸ”¥ POPULAIRE' };
      if (mod.badge === 'promo') return { class: 'promo', text: 'ðŸ’° PROMO' };
      // Auto: nouveau si < 14 jours
      if (!mod.badge && mod.created_at) {
        const daysSince = (Date.now() - new Date(mod.created_at).getTime()) / (1000 * 60 * 60 * 24);
        if (daysSince < 14) return { class: 'nouveau', text: 'ðŸ†• NOUVEAU' };
      }
      return null;
    }

    function renderModules() {
      const container = document.getElementById('modules-container');
      const tgParams = isTelegramMode ? `?tg=1&tguid=${telegramUserId}` : '';

      // Filter by category
      let modules = modulesData;
      if (currentCategory !== 'all') {
        modules = modules.filter(m => m.categories && m.categories.includes(currentCategory));
      }

      if (modules.length === 0) {
        container.innerHTML = '<div class="empty-state">Aucun soldat dans cette categorie</div>';
        return;
      }

      container.innerHTML = modules.map(m => {
        const isInstalled = userModules.includes(m.slug);

        // Determiner le badge a afficher
        let badge = '';
        if (isInstalled) {
          badge = '<span class="card-badge installe">INSTALLE</span>';
        } else {
          // Utiliser le badge de la base de donnees
          const dbBadge = getModuleBadge(m);
          if (dbBadge) {
            badge = `<span class="card-badge ${dbBadge.class}">${dbBadge.text}</span>`;
          }
        }

        // URL selon si installÃ© ou non
        let url;
        const tgParams = isTelegramMode ? `tg=1&tguid=${telegramUserId}` : '';
        if (isInstalled) {
          // ConfigurÃ© â†’ settings
          url = m.settings_url || `/?soldat=${m.slug}`;
          if (tgParams) url += (url.includes('?') ? '&' : '?') + tgParams;
        } else {
          // Pas configurÃ© â†’ setup
          url = m.setup_url || `/setup/?module=${m.slug}`;
          if (tgParams) url += (url.includes('?') ? '&' : '?') + tgParams;
        }

        // Tags HTML
        const tagsHtml = (m.tags || []).map(tag =>
          `<span class="card-tag" style="background:${hexToRgba(m.color, 0.1)}; color:${m.color};">${tag}</span>`
        ).join('');

        // Card background style
        const cardBg = `background: linear-gradient(145deg, ${hexToRgba(m.color, 0.25)}, ${hexToRgba(m.color, 0.15)}); border-color: ${hexToRgba(m.color, 0.4)};`;

        return `
          <a href="${url}" class="module-card" style="${cardBg}" onmouseover="this.style.borderColor='${hexToRgba(m.color, 0.6)}'; this.style.boxShadow='0 0 40px ${hexToRgba(m.color, 0.25)}';" onmouseout="this.style.borderColor='${hexToRgba(m.color, 0.4)}'; this.style.boxShadow='none';">
            ${badge}
            <div class="module-icon-container">
              ${getModuleIconWithBg(m.icon_type, m.color, 56)}
            </div>
            <div class="card-title">${m.name}</div>
            <div class="card-desc">${m.description || ''}</div>
            <div class="card-tags">${tagsHtml}</div>
          </a>
        `;
      }).join('');
    }

    function setupFilters() {
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentCategory = btn.dataset.category;
          renderModules();
        });
      });
    }

    // Avatar nav - simple lien
    function showNavAvatar(user) {
      const avatarLink = document.getElementById('nav-avatar-link');
      const avatarImg = document.getElementById('nav-avatar-img');
      if (!avatarLink || !avatarImg) return;

      const userName = user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0] || 'Utilisateur';
      const avatarUrl = user.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=FF6B35&color=fff`;

      avatarImg.src = avatarUrl;
      avatarLink.style.display = 'flex';
    }

    // Override init to show avatar
    const originalInit = init;
    init = async function() {
      await originalInit();
      // Show avatar if logged in
      if (currentUser && !isTelegramMode) {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session?.user) {
          showNavAvatar(session.user);
        }
      }
    };

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
