<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paie - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/header.css">
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { background: #0a0a0a; color: white; min-height: 100vh; }
    .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; }
    .glass:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.12); }
    .btn-primary { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border: none; border-radius: 12px; padding: 14px 24px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255,107,53,0.4); }
    .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 14px 24px; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .employee-card { transition: all 0.3s; cursor: pointer; }
    .employee-card:hover { transform: translateX(4px); border-color: rgba(255,107,53,0.3); }
    .tag { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; }
    .tag-cdi { background: rgba(34,197,94,0.15); color: #4ade80; }
    .tag-cdd { background: rgba(59,130,246,0.15); color: #60a5fa; }
    .tag-stage { background: rgba(168,85,247,0.15); color: #c084fc; }
    .tag-absence { background: rgba(239,68,68,0.15); color: #f87171; }
    .tag-late { background: rgba(251,191,36,0.15); color: #fbbf24; }
    .tag-extra { background: rgba(34,197,94,0.15); color: #4ade80; }
    .empty-state { text-align: center; padding: 60px 20px; }
    .tab { padding: 10px 16px; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .tab.active { background: rgba(255,107,53,0.15); color: #FF8B5E; }
    .tab:not(.active) { color: rgba(255,255,255,0.4); }
    .tab:not(.active):hover { color: rgba(255,255,255,0.7); }
    .event-row { border-bottom: 1px solid rgba(255,255,255,0.05); }
    .event-row:last-child { border-bottom: none; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal.show { display: flex; }
    .modal-content { background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 24px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; }
    input, select { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 12px 16px; color: white; width: 100%; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: rgba(255,107,53,0.5); }
    input::placeholder { color: rgba(255,255,255,0.3); }
    /* Nav */
    nav { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(3,3,3,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .nav-inner { max-width: 600px; margin: 0 auto; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; }
    .logo-i { width: 36px; height: 36px; min-width: 36px; min-height: 36px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; position: relative; overflow: hidden; }
    .logo-i:hover { transform: scale(1.1); box-shadow: 0 8px 30px rgba(255,107,53,0.5); }
    .logo-i svg { width: 100%; height: 100%; object-fit: contain; }
    .logo-i #i-helmet { transform-origin: 70px 60px; animation: helmetBounce 3s ease-in-out infinite; }
    @keyframes helmetBounce { 0%, 85%, 100% { transform: rotate(0deg) translateY(0); } 88% { transform: rotate(-3deg) translateY(-1px); } 92% { transform: rotate(1deg) translateY(0.5px); } 96% { transform: rotate(-1deg) translateY(0); } }
    .logo-i:hover #i-helmet { animation: salute 0.5s ease-out; }
    @keyframes salute { 0% { transform: rotate(0deg) translateY(0); } 30% { transform: rotate(-8deg) translateY(-3px); } 60% { transform: rotate(2deg) translateY(-1px); } 100% { transform: rotate(0deg) translateY(0); } }
    .nav-right { display: flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>
  <!-- Header -->
  <nav>
    <div class="nav-inner">
      <a href="/" style="text-decoration: none; color: white; display: flex; align-items: center; gap: 10px;">
        <div class="logo-i">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 139.61 327.81">
            <defs><style>.logo-body{fill:#fff;stroke:#fff;stroke-miterlimit:10}.logo-shadow{fill:#cecdd1;stroke-miterlimit:10}.logo-shadow-stroke{fill:#cecdd1;stroke:#cecdd1;stroke-miterlimit:10}.logo-helmet{fill:#47330f;stroke:#47330f;stroke-miterlimit:10}</style></defs>
            <g id="i-body"><path class="logo-body" d="M85.32,142.54c-2.41.32-5.05.57-7.21.96-8.54,1.56-33.88,6.95-43.99,9.8-12.24,3.46-13.3,11.97-14.1,17.56-.8,5.59,1.41,17.88,11.17,17.88,8.54,0,8.25,10.59,8.25,10.59,0,0,.14,68.63,0,84.86-.16,17.89-10.64,17.82-10.64,17.82,0,0-7.71,0-7.71,12.24,0,13.39,14.1,13.03,14.1,13.03h85.12c10.91,0,11.7-14.63,11.7-14.63,0,0,1.6-13.83-10.64-13.83-8.78,0-8.25-15.69-8.25-15.69v-112.79s1.05-15.65-4.69-20.55c-7.08-6.86-15.9-8.21-23.11-7.24Z"/><path class="logo-shadow" d="M51.63,148.52c-15.07,6.79-15.86,21.93-15.86,21.93,0,0-1.5,12.05,11.76,14.95,6.69,1.42,6.63,13.69,6.63,13.69v85.37c0,16.21-8.04,17.97-8.04,17.97,0,0-7.31.55-7.31,12.31,0,13.47,11.31,13.07,11.31,13.07h-14.97s-14.9.36-14.89-13.11c0-12.31,7.71-13.2,7.71-13.2,0,0,10.92.15,10.92-17.04v-85.37s.24-9.76-7.67-9.76c-10.37,0-12.68-13.36-11.88-18.98.8-5.62,2.46-14.33,14.77-17.81l17.49-4.02Z"/></g>
            <g id="i-head"><circle class="logo-body" cx="71.97" cy="86.29" r="47.78"/><path class="logo-shadow-stroke" d="M28.09,105.24c-2.51-5.81-3.9-12.22-3.9-18.95,0-26.39,21.39-47.78,47.78-47.78,21.31,0,39.36,13.95,45.52,33.22,0,0-57.76-3.29-89.39,33.5Z"/><path class="logo-shadow" d="M11.18,94.6c7.57,0,22.75-16.13,22.75-16.13,0,0,9.63-8.94,22.45-13.62,0,0-15.61,5.19-20.22,5.09-5.54-.13-18.51-29.21,3.34-53.81-18.29,6.35-31.42,23.73-31.42,44.18,0,0,.43,7.31,1.24,10.76,0,0,2.7,9.61,1.85,23.53Z"/><path class="logo-shadow" d="M90.21,58.98c22.66-6.38,45.01-.4,37.63-3.02-8.45-2.99-7.62-11.85-7.62-11.85,0,0-3.34,4.39-30,14.86Z"/></g>
            <g id="i-helmet"><path class="logo-body" d="M.66,106s-1.06-3.33,2.22-6.38c4.51-4.19-.15-23.54-.15-23.54-1.07-4.54-1.64-9.28-1.64-14.14C1.09,28.01,28.6.5,62.53.5c28.39,0,52.29,19.26,59.33,45.43,0,0,.69,6.19,7.75,9.4,4.72,2.14,9.06,4.39,9.43,7.55,0,0-22.99-6.11-65.67,3.07-25.04,4.53-39.22,19.55-39.22,19.55,0,0-23.43,24.08-33.47,20.51Z"/><path class="logo-helmet" d="M.66,106c.84,4.08,18.82,3.64,28.44,2.78,44.27-4.52,100.5-34,107.13-40.41,2.2-2.13,2.98-3.92,2.8-5.49,0,0-22.99-6.11-65.67,3.07-25.04,4.53-39.22,19.55-39.22,19.55,0,0-23.43,24.08-33.47,20.51"/><path class="logo-helmet" d="M.66,106c10.04,3.58,33.47-20.51,33.47-20.51,0,0,14.19-15.02,39.22-19.55,42.68-9.18,65.67-3.07,65.67-3.07.14,1.18-.2,2.38-1.34,3.86l-.02.03c-5.59-1.12-27.75-4.42-64.31,3.45-25.04,4.53-39.22,19.55-39.22,19.55,0,0-13.82,14.38-24.79,19.32,0,0-8.43-.46-8.68-3.09Z"/></g>
          </svg>
        </div>
        <span style="font-weight: 700; font-size: 18px; letter-spacing: -0.5px;">Paie</span>
      </a>
      <div class="nav-right">
        <button onclick="showAddEventModal()" class="btn-primary text-sm py-2 px-4" style="padding: 8px 16px; font-size: 13px; border-radius: 10px;">+ Event</button>
      </div>
    </div>
  </nav>

  <main class="max-w-lg mx-auto px-5 pt-24 pb-10">
    <!-- Month Selector -->
    <div class="flex items-center justify-between mb-6">
      <button onclick="changeMonth(-1)" class="p-2 rounded-lg hover:bg-white/5">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      </button>
      <div class="text-center">
        <div class="text-lg font-semibold" id="current-month">Janvier 2026</div>
        <div class="text-xs text-white/40" id="month-range">1 - 31 janvier</div>
      </div>
      <button onclick="changeMonth(1)" class="p-2 rounded-lg hover:bg-white/5">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </button>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-3 gap-3 mb-6">
      <div class="glass p-4 text-center">
        <div class="text-2xl font-bold text-orange-400" id="stat-employees">-</div>
        <div class="text-xs text-white/40 mt-1">Employes</div>
      </div>
      <div class="glass p-4 text-center">
        <div class="text-2xl font-bold text-red-400" id="stat-absences">-</div>
        <div class="text-xs text-white/40 mt-1">Absences</div>
      </div>
      <div class="glass p-4 text-center">
        <div class="text-2xl font-bold text-yellow-400" id="stat-events">-</div>
        <div class="text-xs text-white/40 mt-1">Events</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 mb-6 bg-white/5 p-1 rounded-xl">
      <div class="tab active flex-1 text-center" data-tab="equipe" onclick="switchTab('equipe')">Equipe</div>
      <div class="tab flex-1 text-center" data-tab="events" onclick="switchTab('events')">Events</div>
      <div class="tab flex-1 text-center" data-tab="recap" onclick="switchTab('recap')">Recap</div>
    </div>

    <!-- Tab: Equipe -->
    <div id="tab-equipe">
      <div id="employees-list">
        <div class="glass p-8 text-center text-white/40" id="loading">Chargement...</div>
      </div>
      <div id="empty-state" class="hidden">
        <div class="empty-state glass">
          <div class="w-20 h-20 mx-auto mb-5 bg-white/5 rounded-full flex items-center justify-center">
            <svg class="w-10 h-10 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold mb-2">Aucun employe</h3>
          <p class="text-white/40 text-sm mb-6">Ajoute ton equipe via le setup</p>
          <a href="/setup/?module=paie" class="btn-primary inline-block">Configurer</a>
        </div>
      </div>
    </div>

    <!-- Tab: Events -->
    <div id="tab-events" class="hidden">
      <div id="events-list" class="glass">
        <div class="p-8 text-center text-white/40">Aucun evenement ce mois</div>
      </div>
    </div>

    <!-- Tab: Recap -->
    <div id="tab-recap" class="hidden">
      <div id="recap-content" class="space-y-4">
        <div class="glass p-8 text-center text-white/40">
          Calcul du recap en cours...
        </div>
      </div>
      <button onclick="exportForAccountant()" class="btn-primary w-full mt-6 flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
        </svg>
        Export pour comptable
      </button>
    </div>

    <!-- Quick Actions -->
    <div class="mt-8 grid grid-cols-2 gap-3">
      <a href="/setup/?module=paie" class="btn-secondary flex items-center justify-center gap-2 text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Ajouter
      </a>
      <button onclick="openTelegram()" class="btn-secondary flex items-center justify-center gap-2 text-sm">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.46-1.9-.903-1.056-.692-1.653-1.123-2.678-1.799-1.185-.781-.417-1.21.258-1.911.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.248-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.008-1.252-.241-1.865-.44-.752-.244-1.349-.374-1.297-.789.027-.216.324-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.141.121.1.154.234.17.33.015.096.034.31.019.478z"/>
        </svg>
        Telegram
      </button>
    </div>
  </main>

  <!-- Modal: Add Event -->
  <div class="modal" id="event-modal">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-4">Ajouter un evenement</h3>
      <form id="event-form" onsubmit="saveEvent(event)">
        <div class="mb-4">
          <label class="block text-sm text-white/50 mb-2">Employe</label>
          <select id="event-employee" required>
            <option value="">Selectionner...</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-white/50 mb-2">Date</label>
          <input type="date" id="event-date" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-white/50 mb-2">Type</label>
          <select id="event-type" required onchange="toggleDuration()">
            <option value="absence">Absence</option>
            <option value="late">Retard</option>
            <option value="early_leave">Depart anticipe</option>
            <option value="extra_hours">Heures sup</option>
            <option value="reduced_hours">Heures en moins</option>
            <option value="other">Autre</option>
          </select>
        </div>
        <div class="mb-4" id="duration-field">
          <label class="block text-sm text-white/50 mb-2">Duree (minutes)</label>
          <input type="number" id="event-duration" placeholder="Ex: 120 pour 2h">
          <div class="text-xs text-white/30 mt-1">Laisser vide = journee complete</div>
        </div>
        <div class="mb-6">
          <label class="block text-sm text-white/50 mb-2">Notes</label>
          <input type="text" id="event-notes" placeholder="Optionnel...">
        </div>
        <div class="flex gap-3">
          <button type="button" onclick="closeModal()" class="btn-secondary flex-1">Annuler</button>
          <button type="submit" class="btn-primary flex-1">Ajouter</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Employee Detail -->
  <div class="modal" id="employee-detail-modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold" id="detail-emp-name">Employe</h3>
        <button onclick="closeEmployeeModal()" class="text-white/40 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="employee-detail-content">
        <!-- Content dynamique -->
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="closeEmployeeModal()" class="btn-secondary flex-1">Fermer</button>
        <button onclick="addEventForEmployee()" class="btn-primary flex-1">+ Event</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_8mpFx9ubrV29KfKtgAb3eg_dyazidfT';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let employees = [];
    let events = [];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const MONTHS = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'];
    const EVENT_TYPES = {
      absence: { label: 'Absence', icon: 'ðŸš«', class: 'tag-absence' },
      late: { label: 'Retard', icon: 'â°', class: 'tag-late' },
      early_leave: { label: 'Depart', icon: 'ðŸšª', class: 'tag-late' },
      extra_hours: { label: 'Heures +', icon: 'âž•', class: 'tag-extra' },
      reduced_hours: { label: 'Heures -', icon: 'âž–', class: 'tag-absence' },
      other: { label: 'Autre', icon: 'ðŸ“', class: 'tag' }
    };

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        const urlParams = new URLSearchParams(window.location.search);
        const tguid = urlParams.get('tguid') || tg?.initDataUnsafe?.user?.id;

        if (tguid) {
          const { data: link } = await supabase
            .from('telegram_links')
            .select('user_id')
            .eq('telegram_user_id', tguid.toString())
            .single();

          if (link) {
            currentUser = { id: link.user_id };
            await loadData();
            return;
          }
        }

        sessionStorage.setItem('auth_redirect', window.location.href);
        await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: window.location.origin + '/auth/callback' }
        });
        return;
      }

      currentUser = session.user;
      await loadData();
    }

    async function loadData() {
      updateMonthDisplay();
      await Promise.all([loadEmployees(), loadEvents()]);
      updateStats();
    }

    async function loadEmployees() {
      const { data, error } = await supabase
        .from('employees')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('name');

      document.getElementById('loading').classList.add('hidden');

      if (error || !data || data.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
        employees = [];
        return;
      }

      employees = data;
      renderEmployees();
      populateEmployeeSelect();
    }

    async function loadEvents() {
      const startDate = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
      const endDate = new Date(currentYear, currentMonth + 1, 0).toISOString().split('T')[0];

      const { data, error } = await supabase
        .from('employee_events')
        .select('*, employees(name)')
        .eq('user_id', currentUser.id)
        .gte('event_date', startDate)
        .lte('event_date', endDate)
        .order('event_date', { ascending: false });

      events = data || [];
      renderEvents();
      renderRecap();
    }

    function renderEmployees() {
      const container = document.getElementById('employees-list');
      container.innerHTML = employees.map(emp => {
        const empEvents = events.filter(e => e.employee_id === emp.id);
        const absences = empEvents.filter(e => e.event_type === 'absence').length;
        const lates = empEvents.filter(e => e.event_type === 'late').length;

        return `
        <div class="employee-card glass p-4 mb-3 flex items-center gap-4" onclick="showEmployeeDetail('${emp.id}')">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-500/20 to-orange-600/20 flex items-center justify-center text-lg font-semibold text-orange-400">
            ${emp.name.charAt(0).toUpperCase()}
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-medium truncate">${emp.name}</div>
            <div class="text-sm text-white/40 flex items-center gap-2">
              ${emp.role || 'Employe'}
              ${emp.contract_type ? `<span class="tag tag-${emp.contract_type.toLowerCase()}">${emp.contract_type}</span>` : ''}
            </div>
          </div>
          <div class="text-right text-xs">
            ${absences > 0 ? `<div class="text-red-400">${absences} abs</div>` : ''}
            ${lates > 0 ? `<div class="text-yellow-400">${lates} ret</div>` : ''}
            ${absences === 0 && lates === 0 ? `<div class="text-green-400">OK</div>` : ''}
          </div>
          <div class="text-right">
            <div class="text-sm font-medium">${emp.net_salary_reference ? emp.net_salary_reference + 'â‚¬' : (emp.gross_salary ? emp.gross_salary + 'â‚¬' : '-')}</div>
            <div class="text-xs text-white/30">${emp.net_salary_reference ? 'net' : 'brut'}</div>
          </div>
        </div>
      `}).join('');
    }

    function renderEvents() {
      const container = document.getElementById('events-list');

      if (events.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-white/40">Aucun evenement ce mois</div>';
        return;
      }

      container.innerHTML = events.map(evt => {
        const type = EVENT_TYPES[evt.event_type] || EVENT_TYPES.other;
        const date = new Date(evt.event_date);
        const dateStr = date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' });
        const duration = evt.duration_minutes ? `${Math.floor(evt.duration_minutes / 60)}h${evt.duration_minutes % 60 || ''}` : 'Journee';

        return `
        <div class="event-row p-4 flex items-center gap-3">
          <div class="text-2xl">${type.icon}</div>
          <div class="flex-1">
            <div class="font-medium">${evt.employees?.name || 'Employe'}</div>
            <div class="text-sm text-white/40">${dateStr} - ${duration}</div>
            ${evt.notes ? `<div class="text-xs text-white/30 mt-1">${evt.notes}</div>` : ''}
          </div>
          <span class="tag ${type.class}">${type.label}</span>
        </div>
      `}).join('');
    }

    function renderRecap() {
      const container = document.getElementById('recap-content');

      if (employees.length === 0) {
        container.innerHTML = '<div class="glass p-8 text-center text-white/40">Aucun employe</div>';
        return;
      }

      container.innerHTML = employees.map(emp => {
        const empEvents = events.filter(e => e.employee_id === emp.id);
        const absenceHours = empEvents
          .filter(e => e.event_type === 'absence')
          .reduce((sum, e) => sum + (e.duration_minutes ? e.duration_minutes / 60 : (emp.hours_per_week || 35) / 5), 0);
        const lateMinutes = empEvents
          .filter(e => e.event_type === 'late')
          .reduce((sum, e) => sum + (e.duration_minutes || 0), 0);
        const extraHours = empEvents
          .filter(e => e.event_type === 'extra_hours')
          .reduce((sum, e) => sum + (e.duration_minutes ? e.duration_minutes / 60 : 0), 0);

        const monthlyHours = emp.monthly_hours || (emp.hours_per_week || 35) * 4.33;
        const actualHours = monthlyHours - absenceHours + extraHours;
        const baseNet = emp.net_salary_reference || emp.gross_salary || 0;
        const hourlyRate = baseNet / monthlyHours;
        const deduction = absenceHours * hourlyRate;
        const addition = extraHours * hourlyRate;
        const finalNet = baseNet - deduction + addition;

        return `
        <div class="glass p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="font-semibold">${emp.name}</div>
            <div class="text-lg font-bold text-orange-400">${finalNet.toFixed(0)}â‚¬</div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="flex justify-between">
              <span class="text-white/40">Heures prevues</span>
              <span>${monthlyHours.toFixed(0)}h</span>
            </div>
            <div class="flex justify-between">
              <span class="text-white/40">Heures reelles</span>
              <span>${actualHours.toFixed(0)}h</span>
            </div>
            ${absenceHours > 0 ? `
            <div class="flex justify-between">
              <span class="text-red-400">Absences</span>
              <span class="text-red-400">-${absenceHours.toFixed(1)}h</span>
            </div>` : ''}
            ${lateMinutes > 0 ? `
            <div class="flex justify-between">
              <span class="text-yellow-400">Retards</span>
              <span class="text-yellow-400">${lateMinutes}min</span>
            </div>` : ''}
            ${extraHours > 0 ? `
            <div class="flex justify-between">
              <span class="text-green-400">Heures sup</span>
              <span class="text-green-400">+${extraHours.toFixed(1)}h</span>
            </div>` : ''}
            ${deduction > 0 ? `
            <div class="flex justify-between">
              <span class="text-white/40">Retenue</span>
              <span class="text-red-400">-${deduction.toFixed(0)}â‚¬</span>
            </div>` : ''}
            ${addition > 0 ? `
            <div class="flex justify-between">
              <span class="text-white/40">Supplement</span>
              <span class="text-green-400">+${addition.toFixed(0)}â‚¬</span>
            </div>` : ''}
          </div>
          ${empEvents.length > 0 ? `
          <div class="mt-3 pt-3 border-t border-white/5 text-xs text-white/30">
            ${empEvents.length} evenement(s) ce mois
          </div>` : ''}
        </div>
      `}).join('');
    }

    function updateStats() {
      document.getElementById('stat-employees').textContent = employees.length;
      document.getElementById('stat-absences').textContent = events.filter(e => e.event_type === 'absence').length;
      document.getElementById('stat-events').textContent = events.length;
    }

    function updateMonthDisplay() {
      document.getElementById('current-month').textContent = `${MONTHS[currentMonth]} ${currentYear}`;
      const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
      document.getElementById('month-range').textContent = `1 - ${lastDay} ${MONTHS[currentMonth].toLowerCase()}`;
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      loadData();
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

      document.getElementById('tab-equipe').classList.add('hidden');
      document.getElementById('tab-events').classList.add('hidden');
      document.getElementById('tab-recap').classList.add('hidden');
      document.getElementById('tab-' + tab).classList.remove('hidden');
    }

    function showAddEventModal() {
      document.getElementById('event-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('event-modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('event-modal').classList.remove('show');
      document.getElementById('event-form').reset();
    }

    function toggleDuration() {
      // Duration field always visible for flexibility
    }

    function populateEmployeeSelect() {
      const select = document.getElementById('event-employee');
      select.innerHTML = '<option value="">Selectionner...</option>' +
        employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
    }

    async function saveEvent(e) {
      e.preventDefault();

      const eventData = {
        user_id: currentUser.id,
        employee_id: document.getElementById('event-employee').value,
        event_date: document.getElementById('event-date').value,
        event_type: document.getElementById('event-type').value,
        duration_minutes: document.getElementById('event-duration').value ? parseInt(document.getElementById('event-duration').value) : null,
        notes: document.getElementById('event-notes').value || null
      };

      const { error } = await supabase.from('employee_events').insert(eventData);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      closeModal();
      await loadEvents();
      updateStats();
      renderEmployees();
    }

    let selectedEmployeeId = null;

    function showEmployeeDetail(id) {
      const emp = employees.find(e => e.id === id);
      if (!emp) return;

      selectedEmployeeId = id;
      document.getElementById('detail-emp-name').textContent = emp.name;

      const empEvents = events.filter(e => e.employee_id === id);
      const absenceHours = empEvents.filter(e => e.event_type === 'absence').reduce((sum, e) => sum + (e.duration_minutes ? e.duration_minutes / 60 : 7), 0);
      const lateMinutes = empEvents.filter(e => e.event_type === 'late').reduce((sum, e) => sum + (e.duration_minutes || 0), 0);
      const extraHours = empEvents.filter(e => e.event_type === 'extra_hours').reduce((sum, e) => sum + (e.duration_minutes ? e.duration_minutes / 60 : 0), 0);

      const monthlyHours = emp.monthly_hours || (emp.hours_per_week || 35) * 4.33;
      const baseNet = emp.net_salary_reference || emp.gross_salary || 0;
      const hourlyRate = baseNet / monthlyHours;
      const deduction = absenceHours * hourlyRate;
      const addition = extraHours * hourlyRate;
      const finalNet = baseNet - deduction + addition;

      const content = `
        <div class="glass p-4 mb-4">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-orange-500/20 to-orange-600/20 flex items-center justify-center text-xl font-semibold text-orange-400">
              ${emp.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <div class="text-white/50 text-sm">${emp.role || 'Employe'}</div>
              ${emp.contract_type ? `<span class="tag tag-${emp.contract_type.toLowerCase()}">${emp.contract_type}</span>` : ''}
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div>
              <div class="text-white/40">Heures/semaine</div>
              <div class="font-medium">${emp.hours_per_week || 35}h</div>
            </div>
            <div>
              <div class="text-white/40">Salaire ref</div>
              <div class="font-medium">${baseNet.toFixed(0)}â‚¬ ${emp.net_salary_reference ? 'net' : 'brut'}</div>
            </div>
          </div>
        </div>

        <h4 class="text-sm text-white/50 mb-2">Ce mois (${MONTHS[currentMonth]})</h4>
        <div class="glass p-4 mb-4">
          <div class="grid grid-cols-3 gap-3 text-center text-sm">
            <div>
              <div class="text-red-400 text-lg font-bold">${absenceHours.toFixed(1)}h</div>
              <div class="text-white/40 text-xs">Absences</div>
            </div>
            <div>
              <div class="text-yellow-400 text-lg font-bold">${lateMinutes}min</div>
              <div class="text-white/40 text-xs">Retards</div>
            </div>
            <div>
              <div class="text-green-400 text-lg font-bold">${extraHours.toFixed(1)}h</div>
              <div class="text-white/40 text-xs">H. Sup</div>
            </div>
          </div>
        </div>

        <div class="glass p-4">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-white/50">Salaire de base</span>
            <span>${baseNet.toFixed(2)}â‚¬</span>
          </div>
          ${deduction > 0 ? `<div class="flex justify-between text-sm mb-2">
            <span class="text-red-400">Retenue absences</span>
            <span class="text-red-400">-${deduction.toFixed(2)}â‚¬</span>
          </div>` : ''}
          ${addition > 0 ? `<div class="flex justify-between text-sm mb-2">
            <span class="text-green-400">Heures sup</span>
            <span class="text-green-400">+${addition.toFixed(2)}â‚¬</span>
          </div>` : ''}
          <div class="border-t border-white/10 pt-2 mt-2 flex justify-between font-semibold">
            <span>Net estime</span>
            <span class="text-orange-400">${finalNet.toFixed(2)}â‚¬</span>
          </div>
        </div>

        ${empEvents.length > 0 ? `
        <h4 class="text-sm text-white/50 mt-4 mb-2">Events (${empEvents.length})</h4>
        <div class="glass max-h-32 overflow-y-auto">
          ${empEvents.map(evt => {
            const type = EVENT_TYPES[evt.event_type] || EVENT_TYPES.other;
            const date = new Date(evt.event_date);
            return `<div class="p-2 border-b border-white/5 last:border-b-0 flex items-center gap-2 text-sm">
              <span>${type.icon}</span>
              <span class="flex-1">${date.getDate()}/${date.getMonth()+1}</span>
              <span class="tag ${type.class} text-xs">${type.label}</span>
            </div>`;
          }).join('')}
        </div>` : ''}
      `;

      document.getElementById('employee-detail-content').innerHTML = content;
      document.getElementById('employee-detail-modal').classList.add('show');
    }

    function closeEmployeeModal() {
      document.getElementById('employee-detail-modal').classList.remove('show');
      selectedEmployeeId = null;
    }

    function addEventForEmployee() {
      closeEmployeeModal();
      showAddEventModal();
      if (selectedEmployeeId) {
        document.getElementById('event-employee').value = selectedEmployeeId;
      }
    }

    function exportForAccountant() {
      let csv = 'Nom;Heures Prevues;Heures Reelles;Absences (h);Retards (min);Heures Sup;Base Net;Retenue;Supplement;Net Final\n';

      employees.forEach(emp => {
        const empEvents = events.filter(e => e.employee_id === emp.id);
        const absenceHours = empEvents.filter(e => e.event_type === 'absence').reduce((sum, e) => sum + (e.duration_minutes ? e.duration_minutes / 60 : 7), 0);
        const lateMinutes = empEvents.filter(e => e.event_type === 'late').reduce((sum, e) => sum + (e.duration_minutes || 0), 0);
        const extraHours = empEvents.filter(e => e.event_type === 'extra_hours').reduce((sum, e) => sum + (e.duration_minutes ? e.duration_minutes / 60 : 0), 0);

        const monthlyHours = emp.monthly_hours || (emp.hours_per_week || 35) * 4.33;
        const actualHours = monthlyHours - absenceHours + extraHours;
        const baseNet = emp.net_salary_reference || emp.gross_salary || 0;
        const hourlyRate = baseNet / monthlyHours;
        const deduction = absenceHours * hourlyRate;
        const addition = extraHours * hourlyRate;
        const finalNet = baseNet - deduction + addition;

        csv += `${emp.name};${monthlyHours.toFixed(1)};${actualHours.toFixed(1)};${absenceHours.toFixed(1)};${lateMinutes};${extraHours.toFixed(1)};${baseNet.toFixed(2)};${deduction.toFixed(2)};${addition.toFixed(2)};${finalNet.toFixed(2)}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `paie_${MONTHS[currentMonth].toLowerCase()}_${currentYear}.csv`;
      link.click();
    }

    function openTelegram() {
      window.open('https://t.me/iArmy_bot', '_blank');
    }

    init();
  </script>
</body>
</html>
