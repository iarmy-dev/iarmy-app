<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://byqfnpdcnifauhwgetcq.supabase.co;">
  <title>Connexion en cours... - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23FF6B35'/%3E%3Ctext x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'%3Ei%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #030303; color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .container { text-align: center; }
    .logo { width: 100px; height: 100px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 28px; display: flex; align-items: center; justify-content: center; font-size: 52px; font-weight: 800; margin: 0 auto 32px; animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .title { font-size: 24px; font-weight: 600; margin-bottom: 12px; }
    .subtitle { font-size: 14px; color: rgba(255,255,255,0.5); margin-bottom: 32px; }
    .dots { display: flex; gap: 12px; justify-content: center; }
    .dot { width: 12px; height: 12px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 50%; animation: bounce 1.4s ease-in-out infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
    .error { background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; padding: 16px 24px; color: #ef4444; margin-top: 24px; display: none; max-width: 400px; }
    .error.show { display: block; }
    .btn { background: linear-gradient(135deg, #FF6B35, #FF8B5E); padding: 12px 24px; border-radius: 12px; font-weight: 600; border: none; color: white; cursor: pointer; margin-top: 16px; text-decoration: none; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">i</div>
    <h1 class="title" id="title">Connexion en cours...</h1>
    <p class="subtitle" id="subtitle">Veuillez patienter</p>
    <div class="dots" id="dots">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <div class="error" id="error"></div>
  </div>

  <script>
    console.log('[CALLBACK] OAuth callback init');

    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_8mpFx9ubrV29KfKtgAb3eg_dyazidfT';

    function showError(message) {
      document.getElementById('title').textContent = 'Erreur de connexion';
      document.getElementById('subtitle').textContent = '';
      document.getElementById('dots').style.display = 'none';
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      const br = document.createElement('br');
      const link = document.createElement('a');
      link.href = '/';
      link.className = 'btn';
      link.textContent = 'Retour';
      errorDiv.appendChild(br);
      errorDiv.appendChild(link);
      errorDiv.classList.add('show');
    }

    function showSuccess(name) {
      document.getElementById('title').textContent = `Bienvenue ${name} !`;
      document.getElementById('subtitle').textContent = 'Redirection...';
    }

    // Decoder un JWT (partie payload seulement)
    function decodeJWT(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error('[CALLBACK] Erreur decode JWT:', e);
        return null;
      }
    }

    // Sauvegarder la session en cookie
    function saveSessionToCookie(sessionData) {
      const value = JSON.stringify(sessionData);
      document.cookie = `sb-auth-token=${encodeURIComponent(value)}; domain=.iarmy.fr; path=/; max-age=604800; SameSite=Lax; Secure`;
      console.log('[CALLBACK] Session sauvegardee en cookie');
    }

    async function handleCallback() {
      try {
        console.log('[CALLBACK] Traitement du callback...');

        // Parser le hash
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        const expiresIn = parseInt(hashParams.get('expires_in') || '3600');
        const expiresAt = parseInt(hashParams.get('expires_at') || String(Math.floor(Date.now() / 1000) + expiresIn));
        const providerToken = hashParams.get('provider_token');

        console.log('[CALLBACK] Tokens extraits:', {
          hasAccess: !!accessToken,
          hasRefresh: !!refreshToken,
          expiresAt
        });

        if (!accessToken) {
          showError('Aucun token trouve dans l\'URL');
          return;
        }

        // Decoder le JWT pour obtenir les infos user
        const payload = decodeJWT(accessToken);
        if (!payload) {
          showError('Token invalide');
          return;
        }

        console.log('[CALLBACK] JWT decode:', payload.email);

        // Construire l'objet user
        const user = {
          id: payload.sub,
          aud: payload.aud,
          role: payload.role,
          email: payload.email,
          email_confirmed_at: new Date().toISOString(),
          phone: payload.phone || '',
          app_metadata: payload.app_metadata || {},
          user_metadata: payload.user_metadata || {},
          identities: [],
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        // Construire l'objet session (format Supabase)
        const session = {
          access_token: accessToken,
          refresh_token: refreshToken,
          expires_in: expiresIn,
          expires_at: expiresAt,
          token_type: 'bearer',
          user: user,
          provider_token: providerToken
        };

        // Sauvegarder en cookie
        saveSessionToCookie(session);

        // Nettoyer l'URL
        window.history.replaceState({}, document.title, window.location.pathname);

        // Afficher succes
        const firstName = user.user_metadata?.full_name?.split(' ')[0] ||
                         user.user_metadata?.name?.split(' ')[0] ||
                         user.email?.split('@')[0] || 'toi';
        showSuccess(firstName);

        // Creer profil si necessaire
        await createProfileIfNeeded(user, accessToken);

        // Redirection
        const redirectUrl = sessionStorage.getItem('auth_redirect');
        sessionStorage.removeItem('auth_redirect');

        setTimeout(() => {
          window.location.href = redirectUrl || '/';
        }, 800);

      } catch (err) {
        console.error('[CALLBACK] Erreur:', err);
        showError('Erreur: ' + err.message);
      }
    }

    async function createProfileIfNeeded(user, accessToken) {
      try {
        // Verifier si profil existe
        const checkRes = await fetch(`${SUPABASE_URL}/rest/v1/profiles?id=eq.${user.id}&select=id`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${accessToken}`
          }
        });

        const existing = await checkRes.json();

        if (!existing || existing.length === 0) {
          console.log('[CALLBACK] Creation du profil...');
          await fetch(`${SUPABASE_URL}/rest/v1/profiles`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify({
              id: user.id,
              email: user.email,
              name: user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0],
              plan: 'free'
            })
          });
          console.log('[CALLBACK] Profil cree');
        }
      } catch (e) {
        console.log('[CALLBACK] Profil existant ou erreur ignoree:', e.message);
      }
    }

    // Lancer au chargement
    document.addEventListener('DOMContentLoaded', handleCallback);
  </script>
</body>
</html>
